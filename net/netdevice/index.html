<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="net, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Linux net device : firoyang.org"/>
<meta property="og:site_name" content="Firo Website"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://firoyang.org/net/netdevice/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2015-02-27"/>
<meta property="article:modified_time" content="2015-02-27"/>



<meta property="article:tag" content="net">





    <base href="http://firoyang.org/">
    <title> Linux net device - Firo</title>
    <link rel="canonical" href="http://firoyang.org/net/netdevice/">
    

    <link href='http://fonts.useso.com/css?family=Fjalla+One|Open+Sans:300' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/static/css/style.css">

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?a79535ca63291dc820e3ecefa615aad1";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>

</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
<header id="header">
	<link rel="stylesheet" href="static/css/font-awesome.min.css">
	<nav id="nav">
	<div id="title"><a href="/">Firo Notes</a></div>
	<div>
	
	</div>
	</nav>
	<nav id="nav">
    	        <ul id="mainnav">
            <li>
                <a href="/cs/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-laptop"></i></span>
                <span> cs </span>
            </a>
            </li>
            <li>
            <a href="/firo/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-male"></i></span>
                <span> firo </span>
            </a>
            </li>
            <li>
            <a href="/history/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-beer"></i></span>
                <span> history </span>
            </a>
            </li>
            <li>
            <a href="/about">
                <span class="icon"> <i aria-hidden="true" class="fa fa-rocket"></i></span>
                <span> About </span>
            </a>
            </li>
            <li>
                <a href="/howto/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-key"></i></span>
                <span> howto </span>
            </a>
            </li>
            <li>
            <a href="/kernel/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-linux"></i></span>
                <span> kernel </span>
            </a>
            </li>
            <li>
            <a href="/net/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-globe"></i></span>
                <span> net </span>
            </a>
            </li>
            <li>
            <a href="/philosophy/">
                <span class="icon"> <i aria-hidden="true" class="icon-heart"></i></span>
                <span> philosophy </span>
            </a>
            </li>
            <li>
            <a href="/review/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-thumbs-up"></i></span>
                <span> review</span>
            </a>
            </li>
        </ul>

	</nav>
	<nav id="nav">
       
	</nav>
</header>



<section id="main">
  <h1 itemprop="name" >Linux net device</h1>
  

<aside id="meta">

    <div>
        <section id="datecount">
          <h4 id="date"> Fri Feb 27, 2015 </h4>
          
        </section>
        
        <ul id="tags">
          
            <li> <a href="http://firoyang.org//tags/net">net</a> </li>
          
        </ul>

    </div>


</aside>

<meta itemprop="wordCount" content="796">
<meta itemprop="datePublished" content="2015-02-27">
<meta itemprop="url" content="http://firoyang.org/net/netdevice/">


  <div>
        <article itemprop="articleBody" id="content">
           

<h1 id="common-interface-felling:cd0f928d10f3bb2c8d02882e98d253ef">Common Interface felling</h1>

<h2 id="no-driver-tg3:cd0f928d10f3bb2c8d02882e98d253ef">No driver tg3</h2>

<p>I remove all kernel 4.0  moduls that ip ad just only output lo interface info.</p>

<h2 id="hiwifi:cd0f928d10f3bb2c8d02882e98d253ef">Hiwifi</h2>

<ul>
<li><p>Disable network(netifd) in hiwifi openwrt
root@Hiwifi:/# ip ad
1: lo: <LOOPBACK> mtu 16436 qdisc noop state DOWN
link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: eth2: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN qlen 1000
link/ether d4:ee:07:07:75:c2 brd ff:ff:ff:ff:ff:ff
3: ra0: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN qlen 1000
link/ether 00:00:00:00:00:00 brd ff:ff:ff:ff:ff:ff
4: sit0: <NOARP> mtu 1480 qdisc noop state DOWN
link/sit 0.0.0.0 brd 0.0.0.0
5: gre0: <NOARP> mtu 1476 qdisc noop state DOWN
link/gre 0.0.0.0 brd 0.0.0.0</p></li>

<li><p>Enable network(netifd) in hiwifi openwrt
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 16436 qdisc noqueue state UNKNOWN
link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
inet 127.0.0.<sup>1</sup>&frasl;<sub>8</sub> scope host lo
inet6 ::<sup>1</sup>&frasl;<sub>128</sub> scope host
   valid_lft forever preferred_lft forever
2: eth2: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UNKNOWN qlen 1000
link/ether d4:ee:07:07:75:c2 brd ff:ff:ff:ff:ff:ff
inet6 fe80::d6ee:7ff:fe07:75c2/64 scope link
   valid_lft forever preferred_lft forever
3: ra0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast master br-lan state UNKNOWN qlen 1000
link/ether d4:ee:07:07:75:c2 brd ff:ff:ff:ff:ff:ff
4: sit0: <NOARP> mtu 1480 qdisc noop state DOWN
link/sit 0.0.0.0 brd 0.0.0.0
5: gre0: <NOARP> mtu 1476 qdisc noop state DOWN
link/gre 0.0.0.0 brd 0.0.0.0
6: br-lan: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP
link/ether d4:ee:07:07:75:c2 brd ff:ff:ff:ff:ff:ff
inet 10.1.1.<sup>1</sup>&frasl;<sub>24</sub> brd 10.1.1.255 scope global br-lan
inet6 fe80::d6ee:7ff:fe07:75c2/64 scope link
   valid_lft forever preferred_lft forever
7: eth2.1@eth2: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue master br-lan state UP
link/ether d4:ee:07:07:75:c2 brd ff:ff:ff:ff:ff:ff
8: eth2.2@eth2: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP
link/ether d4:ee:07:07:75:c3 brd ff:ff:ff:ff:ff:ff
inet 192.168.199.<sup>223</sup>&frasl;<sub>24</sub> brd 192.168.199.255 scope global eth2.2
inet6 fe80::d6ee:7ff:fe07:75c3/64 scope link
   valid_lft forever preferred_lft forever
9: ra1: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN qlen 1000
link/ether d6:ee:07:04:75:c2 brd ff:ff:ff:ff:ff:ff
10: apcli0: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN qlen 1000
link/ether d6:ee:07:05:75:c2 brd ff:ff:ff:ff:ff:ff</p></li>
</ul>

<p>#Bridging
* A bridge behaves like a virtual network switch, 一样.
Bridging is a router using MAC address at L2 in essence.
A bridge transparently relays traffic between multiple network interfaces.
In plain English this means that a bridge connects two or more physical Ethernets together to form one bigger (logical) Ethernet.</p>

<h2 id="spanning-tree-protocol-rapid-stp-multiple-stp:cd0f928d10f3bb2c8d02882e98d253ef">Spanning tree protocol(Rapid STP,Multiple STP)</h2>

<p>the algorithm is not executed on a single host that later distributes the result to all the others;
instead, this is a distributed protocol.</p>

<h2 id="bpud-bridge-protocol-data-units:cd0f928d10f3bb2c8d02882e98d253ef">BPUD Bridge protocol data units</h2>

<ul>
<li><p>Configuration BPDU
Used to define the loop-free topology.
Topology Change Notification (TCN) BPDU
Used by a bridge to notify the root bridge about a detected topology change.</p></li>

<li><p>BPDU Aging
On a stable network, the time depends mainly on how loaded the bridges are and how fast they can process BPDUs.</p></li>

<li><p>Root Bridge
The root bridge is the only bridge that generates BPDUs
The root bridge makes sure each bridge in the network comes to know about a topology change when one occurs</p></li>

<li><p>Designated Bridges
While each tree has only one root bridge, there is one designated bridge for each LAN,
which becomes the bridge all hosts and bridges on the LAN use to reach the root.
The designated bridge is chosen by determining which bridge on the LAN has the lowest path cost to the root bridge.</p></li>

<li><p>Bridge Port
While root ports lead toward the root of the tree (i.e., the root bridge), designated ports lead toward the leaves.</p></li>
</ul>

<h2 id="function:cd0f928d10f3bb2c8d02882e98d253ef">Function</h2>

<p>Rassive learning
Flooding
Aging
Bridging Loops
Switch:</p>

<h2 id="details:cd0f928d10f3bb2c8d02882e98d253ef">Details</h2>

<p>newe_bridge_dev() create net_device and net_bridge.</p>

<h1 id="vlan:cd0f928d10f3bb2c8d02882e98d253ef">vlan</h1>

<p>Vlans are a way to split up a layer2 broadcasting domain, VLANs allow you to create multiple separated networks with only a single switch.
In a vlan-capable network there are 2 types of connections : &ldquo;access&rdquo; connections and &ldquo;trunk&rdquo; connections
Vlan packet</p>

<h2 id="vlan-packet:cd0f928d10f3bb2c8d02882e98d253ef">Vlan packet</h2>

<p>Preamble 56 alternating bits | SFD10101011 | dst mac | src mac | TPID 0x8100 | TCI:PCP DEI VID| Ether type 0x86DD ipv6 &hellip;|CRC FCS</p>

<h2 id="802-1q-vlan-header:cd0f928d10f3bb2c8d02882e98d253ef">802.1Q/Vlan header</h2>

<p>TPID is the same as 0x86DD just a Ether type 0x8100  | PCP 3bis  DEI 1bit VID 12bis</p>

<h2 id="access-connection:cd0f928d10f3bb2c8d02882e98d253ef">Access connection</h2>

<p>An access connection looks like a normal connection to an ethernet switch,
only that switch will only forward your packets within the same vlan, so they will not be able to reach ports that are in a different vlan.
For access ports, the switch will add (or overwrite) this tag value on any incoming(it means transfer out of host) packet before forwarding</p>

<h2 id="trunk-connnection:cd0f928d10f3bb2c8d02882e98d253ef">Trunk connnection</h2>

<p>&ldquo;Trunk&rdquo; ports can communicate with multiple vlans, but you need to send special packets that contain
both the packet and an indication in what vlan they are to be forwarded.
For trunk ports, the value is supposed to be present. If it is not, the value of the &ldquo;native vlan&rdquo; will be added.</p>

<h2 id="split-up-a-layer2-broadcasting-domain:cd0f928d10f3bb2c8d02882e98d253ef">Split up a layer2 broadcasting domain</h2>

<p>vlan 什么都别想, 你总的有个vlan吧. 对上来就创建一个vlan-device.
vconfig add eth0 vid
for trunk routing between the different vlans we need ip_forward</p>

<h2 id="details-of-implemention:cd0f928d10f3bb2c8d02882e98d253ef">Details of implemention</h2>

<p>net/8021q/</p>

<h3 id="initialize:cd0f928d10f3bb2c8d02882e98d253ef">initialize</h3>

<p>vlan_proto_init()
这个函数最重要的是映射了iocctl函数， 因为接下来的所有操作都要用到ioctl。</p>

<h3 id="application:cd0f928d10f3bb2c8d02882e98d253ef">application</h3>

<p>vconfig eth0 1
vlan_ioctl_handler()-&gt;register_vlan_device():
alloc net_device.
vlan_setup()函数非常重要，设置dev-&gt;priv_flags 为 802.1q！tx queue 为0.
设置open函数为vlan_dev_open;
register_vlan_dev(）把这个设备注册到内核。</p>

        </article>
  </div>
</section>

<aside id=comments>
    <div><h2> Comments </h2></div>
    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'firoyang';
    var disqus_identifier = 'http:\/\/firoyang.org\/net\/netdevice\/';
    var disqus_title = 'Linux net device';
    var disqus_url = 'http:\/\/firoyang.org\/net\/netdevice\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</aside>

<footer>
  <div>
    <p>
    &copy; 2015 2016 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Firo Yang.</span></span>
        Powered by <a href="http://hugo.spf13.com">Hugo</a>.
        Theme by <a href="http://spf13.com">Steve Francia</a>.
    </p>
  </div>
</footer>
<script type="text/javascript">
(function(){var j=function(a,b){return window.getComputedStyle?getComputedStyle(a).getPropertyValue(b):a.currentStyle[b]};var k=function(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else a.attachEvent('on'+b,c)};var l=function(a,b){for(key in b)if(b.hasOwnProperty(key))a[key]=b[key];return a};window.fitText=function(d,e,f){var g=l({'minFontSize':-1/0,'maxFontSize':1/0},f);var h=function(a){var b=e||1;var c=function(){a.style.fontSize=Math.max(Math.min(a.clientWidth/(b*10),parseFloat(g.maxFontSize)),parseFloat(g.minFontSize))+'px'};c();k(window,'resize',c)};if(d.length)for(var i=0;i<d.length;i++)h(d[i]);else h(d);return d}})();
fitText(document.getElementById('title'), 1)
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

</body>
</html>


<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>

</body>
