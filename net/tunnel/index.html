<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="tunnel : firoyang.org"/>
<meta property="og:site_name" content="Firo Website"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://firoyang.org/net/tunnel/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2014-12-28"/>
<meta property="article:modified_time" content="2014-12-28"/>





    <base href="http://firoyang.org/">
    <title> tunnel</title>
    <link rel="canonical" href="http://firoyang.org/net/tunnel/">
    

    
<link rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/static/css/style.css">


    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
     
</head>


<body lang="en" itemscope itemtype="http://schema.org/Article">
<header id="header">
	<link rel="stylesheet" href="static/css/font-awesome.min.css">
	<nav id="nav">
	<div id="title"><a href="/">Firo Notes</a></div>


	<div>
	
	</div>
	</nav>
	<nav id="nav">
    	        <ul id="mainnav">
            <li>
            <a href="/review/">
                <span class="icon"> <i aria-hidden="false" class="fa fa-thumbs-o-up"></i></span>
                <span> review</span>
            </a>
            </li>
	
            <li>
            <a href="/firo/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-male"></i></span>
                <span> firo </span>
            </a>
            </li>
            <li>
            <a href="/history/">
                <span class="icon"> <i aria-hidden="false" class="fa fa-institution"></i></span>
                <span> history </span>
            </a>
            </li>
            <li>
            <a href="/about">
                <span class="icon"> <i aria-hidden="true" class="fa fa-rocket"></i></span>
                <span> Firo </span>
            </a>
            </li>
            <li>
                <a href="/howto/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-gamepad"></i></span>
                <span> howto </span>
            </a>
            </li>
            <li>
            <a href="/kernel/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-linux"></i></span>
                <span> kernel </span>
            </a>
            </li>
            <li>
            <a href="/net/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-globe"></i></span>
                <span> net </span>
            </a>
            </li>
            <li>
            <a href="/philosophy/">
                <span class="icon"> <i aria-hidden="true" class="icon-leaf"></i></span>
                <span> philosophy </span>
            </a>
            </li>
            <li>
                <a href="/cs/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-laptop"></i></span>
                <span> cs </span>
            </a>
            </li>
        </ul>

	</nav>
	<nav id="nav">
       
	</nav>
</header>



 <link rel="stylesheet" href="highlight.js/styles/monokai-sublime.css">
    <script src="highlight.js/highlight.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
	<section id="main">
	  <h1 itemprop="name" >tunnel</h1>
	  

<aside id="meta">

    <div>
        <section id="datecount">
          <h4 id="date"> Sun Dec 28, 2014 </h4>
          
        </section>
        
        <ul id="tags">
          
        </ul>

    </div>


</aside>

<meta itemprop="wordCount" content="894">
<meta itemprop="datePublished" content="2014-12-28">
<meta itemprop="url" content="http://firoyang.org/net/tunnel/">


	  <div>
		<article itemprop="articleBody" id="content">
		   

<p>#class<br />
network layer over network layer: gre<br />
link layer over network layer: l2tp, pptp</p>

<h1 id="proxy:76e7252b2d04b0b5161bfb0dbf64d663">Proxy</h1>

<p><a href="http://www.coder4.com/archives/4434">透明代理、匿名代理、混淆代理、高匿代理有什么区别？</a></p>

<h2 id="正向代理forward-proxy:76e7252b2d04b0b5161bfb0dbf64d663">正向代理forward proxy</h2>

<p>shadowsocks goagent</p>

<h2 id="reverse-proxy:76e7252b2d04b0b5161bfb0dbf64d663">Reverse proxy</h2>

<p>负载均衡的服务器, 缓存的静态内容的server</p>

<h2 id="透明代理:76e7252b2d04b0b5161bfb0dbf64d663">透明代理</h2>

<p>hiwifi router kproxy nginx, kproxy 是更细粒度的iptables.<br />
所谓透明代理就是正向代理且client零配置.</p>

<h2 id="dmz:76e7252b2d04b0b5161bfb0dbf64d663">DMZ</h2>

<p>Demilitarized zone, 解除军事武装区 or 非军事区!<br />
这个跨领域的名字听上去, 好叼叼的, 现实中南极洲和三八线都是非军事区.<br />
为什么叫这个名字, 暗指firewall没有设置太多限制规则的一部分网络地址空间.<br />
内网和外网是争端的主角, 而DMZ是个缓冲区.</p>

<h3 id="simplest-sample:76e7252b2d04b0b5161bfb0dbf64d663">simplest sample</h3>

<p>iptables -A INPUT -p tcp -d 10.42.0.52 &ndash;dport 53 -j ACCEPT<br />
iptables -A FORWARD -p tcp -d 192.168.1.2 &ndash;dport 53 -j ACCEPT<br />
iptabltes -t nat -A PREOUTTING -p -tcp 10.42.0.52 &ndash;dport 53 -j DNAT &ndash;to 192.168.1.2:53<br />
我们就知道了dmz有整体有两部分构成ACCEPT and DNAT<br />
同时涉及到一个dmz地址空间{dmzwan10.42.0.52:53, dmzlan:192.168.1.2:53}</p>

<p>#Basic concepts<br />
* VPN is created by establishing a virtual point-to-point connection through the use of<br />
1. dedicated connections(permanent)<br />
2. virtual tunneling protocols<br />
traffic encryptions and authentication<br />
+ connection(tunnel) + secure</p>

<p>#Tunnel proctocol<br />
* pptp<br />
data-link header | PPP | IP &hellip;<br />
data-link header | IP | GRE | PPP | IP&hellip;<br />
rfc2637<br />
<a href="http://pptpclient.sourceforge.net/diagrams.phtml">http://pptpclient.sourceforge.net/diagrams.phtml</a><br />
* pppd -&gt; /dev/ppp<br />
/dev/ppp (see ppp_init) 下发密码, 加密之类的.<br />
ppp_netdev_ops (see ppp_create_interface)<br />
ppp_wirte-&gt;ppp_xmit_process-&gt;ppp_send_frame-&gt;ppp_push-&gt;|pch-&gt;chan-&gt;ops-&gt;start_xmit()=pppoe_xmit-&gt;__pppoe_xmit</p>

<ul>
<li>init<br />
pptp -&gt; pptp server -&gt; generate PPP connection and PPP0(interface)<br /></li>
<li>input<br />
eth -&gt; ppptp(remove gre header)-&gt;PPP header-&gt; pty(device) -&gt; PPP0(interface) -&gt;<br /></li>

<li><p>output<br />
-&gt; PPP0(interface) -&gt; PPP header -&gt; pty -&gt; PPPT(add gre header) -&gt; raw socket -&gt; eth</p></li>

<li><p>shadowsocks<br />
user -&gt; iptables -&gt; shadowsocks(redir.c (struct server)-&gt;(struct remote)) -&gt; server</p></li>
</ul>

<p>ssh redsocks<br />
user -&gt; iptables -&gt; redsocks -&gt; ssh -&gt; server</p>

<ul>
<li>pppoe<br />
pppoe 的sk-&gt;sk_backlog_rcv是在pppoe_create中确定的, 这点却别与tcp socket<br />
pppoe_rcv_core -&gt;　netif_rx<br />
从sk_receive_skb来看pppoe 和tcp都对应一个session or sock!<br />
对比inet_create 和 pppoe_create, 而pppoe很屌是在链路层的sock厉害!<br />
pppoe报文会经过两次sk_filter()<br />
<a href="http://blog.csdn.net/osnetdev/article/details/8958058">http://blog.csdn.net/osnetdev/article/details/8958058</a><br />
&amp;pppoe_chan_ops;<br /></li>
</ul>

<p>+ppp header<br />
is added in ppp_start_xmit to ppp_send_frame NO ppp_hdr struct!<br />
ppp-wan-&gt;ndo_start_xmit()=ppp_start_xmit()-&gt;ppp_xmit_process()-&gt;ppp_send_frame()<br />
-&gt;<br />
{<br />
    __skb_push(skb, sizeof(*ph));<br />
    skb_reset_network_header(skb);<br />
    //add pppoe_hdr no header???<br />
    dev_queue_xmit(skb);<br />
}</p>

<p>#PPP<br />
<a href="http://www.cnitblog.com/liaoqingshan/archive/2013/06/13/52906.html">http://www.cnitblog.com/liaoqingshan/archive/2013/06/13/52906.html</a></p>

<p>#GRE<br />
include/net/gre.h</p>

<p>#L2tp<br />
IP -&gt; UDP -&gt; L2TP -&gt; PPP</p>

<ul>
<li>source files<br />
net/l2tp/<br />
├── Kconfig<br />
├── l2tp_core.c<br />
├── l2tp_core.h<br />
├── l2tp_debugfs.c<br />
├── l2tp_eth.c<br />
├── l2tp_ip.c<br />
├── l2tp_netlink.c<br />
├── l2tp_ppp.c<br />
└── Makefile<br /></li>
</ul>

<p>include/uapi/linux/ppp_defs.h</p>

<ul>
<li>Functions<br />
l2tp_recv_common &hellip;recv_skb=pppol2tp_recv()<br />
l2tp_xmit_core<br /></li>
</ul>

<p>#PPTP<br />
##Route ip-list to pptp-vpn<br />
11: pptp-vpn: <POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1482 qdisc pfifo_fast state UNKNOWN qlen 3<br />
    link/ppp<br />
    inet 192.168.1.60 peer 192.168.1.<sup>1</sup>&frasl;<sub>32</sub> scope global pptp-vpn<br />
root@Hiwifi:~# route -n<br />
Kernel IP routing table<br />
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br />
0.0.0.0         192.168.1.1     0.0.0.0         UG    0      0        0 pptp-vpn<br />
123.121.94.19   192.168.10.254  255.255.255.255 UGH   0      0        0 eth2.2<br />
192.168.1.1     0.0.0.0         255.255.255.255 UH    0      0        0 pptp-vpn<br />
192.168.10.0    0.0.0.0         255.255.255.0   U     0      0        0 eth2.2<br />
192.168.199.0   0.0.0.0         255.255.255.0   U     0      0        0 br-lan</p>

<p>##pptp header<br />
IP | GRE | pptp_gre_header | PPP | IP</p>

<p>##input<br />
ip -&gt; gre -&gt; ppp -&gt; ip<br />
ip_local_deliver_finish()(netfilter NF LOCAL IN smartqos local in) -&gt;inet_protos.gre_rcv -&gt; gre_proto[GREPROTO_PPTP]=pptp_rcv{pptp_gre_header} -&gt; sk_receive_skb -&gt;sk_backlog_rcv -&gt; pptp_rcv_core -&gt; ppp_input -&gt; ppp_do_recv<br />
-&gt; ppp_receive_frame -&gt; ppp_receive_nonmp_frame -&gt; netif_rx -&gt; netif_rx_internal -&gt; enqueue_to_backlog -&gt; ____napi_schedule(sd, &amp;sd-&gt;backlog);<br />
-&gt; netif_receive_skb&hellip;</p>

<p>##output<br />
ip_output &hellip;-&gt; ppp_start_xmit -&gt; ppp_xmit_process -&gt; ppp_send_frame -&gt; add ppp header -&gt; ppp_push<br />
-&gt;pch-&gt;chan-&gt;ops-&gt;start_xmit=pptp_xmit -&gt; add gre and ip header. -&gt; ip_local_out -&gt;<br />
+another send skb functions is ip_build_and_send_pkt()<br />
{ this functions hook is init in pptp_connect() -&gt; ppp_register_channel(&amp;po-&gt;chan) }<br />
{ppp_connect()&rsquo;s init functions is pptp_create, see pptp_init_module -&gt;<br />
register_pppox_proto(PX_PROTO_PPTP, &amp;pppox_pptp_proto) pptp_create.}<br />
when invoke pptp_create? socket()!</p>

<p>if layer 4 protocol is gre then pass.</p>

<p>##PPTP &amp; NAT<br />
* Forward package<br />
br-lan(PREROUTING orginal packet NAT old)<br />
(route -&gt; pptp-vpn) = ip_forward()-&gt;NF_INET_FORWARD-&gt;ip_forward_finish()-&gt;dst_output()<br />
pptp-vpn -&gt; ndo_start_xmit -&gt; add some headers -&gt; local_out NAT new -&gt; tc dequeue_qdisc(this is maybe eth2.2&rsquo;s routing result! see top)<br />
so we need to do is just find original skb in PPTP packet header!</p>

<p>##PPTP &amp; GRE &amp; Conntrack</p>

<h1 id="as-a-pure-ip-protocol-gre-uses-only-ip-addresses-but-no-port-numbers-giving-the-router-s-nat-a-tough-time-to-track-such-a-connection-in-its-base-configuration-openwrt-backfire-is-able-to-nat-a-single-pptp-connections-but-not-multiple-such-connections-concurrently-it-is-also-unreliable-when-trying-to-establish-consecutive-single-pptp-connections-from-different-lan-clients-in-rapid-succession:76e7252b2d04b0b5161bfb0dbf64d663">As a pure IP protocol GRE uses only IP addresses but no port numbers giving the router&rsquo;s NAT a tough time to track such a connection. In its base configuration OpenWrt Backfire is able to NAT a single PPTP connections but not multiple such connections concurrently. It is also unreliable when trying to establish consecutive single PPTP connections from different LAN clients in rapid succession.</h1>

<p>kernel vpn just one session.</p>

<p>##ppp-&gt; pptp code.<br />
ppp_send_frame()<br />
{</p>

<pre><code>//below is ok 132 is output!
printk(&quot;ct %d, %d, %d, %d\n&quot;, HWF_CT_EXT(ct)-&gt;user_id, user_id, HWF_CT_EXT(ct)-&gt;is_marked, proto);
switch(proto) //0x21, 33
{

    //Below two print is not show, so we did pass through these codes.
    if (cp == skb-&gt;data + 2) {
        /* didn't compress */
        printk(&quot;NO compreess %x\n&quot;, ppp-&gt;flags);
        kfree_skb(new_skb);
    } else {
        if (cp[0] &amp; SL_TYPE_COMPRESSED_TCP) {
            proto = PPP_VJC_COMP;
            cp[0] &amp;= ~SL_TYPE_COMPRESSED_TCP;
        } else {
            proto = PPP_VJC_UNCOMP;
            cp[0] = skb-&gt;data[2];
        }
        kfree_skb(skb);
        skb = new_skb;
        printk(&quot;I am here %d ,%d, %x\n&quot;, cp[0], proto, ppp-&gt;flags);


}
printk(&quot;hit b %d\n&quot;, skb-&gt;qosmark);
skb = pad_compress_skb(ppp, skb);//this functions skb will be replaced with a new_skab by alloc_skb();
printk(&quot;hit a %d\n&quot;, skb-&gt;qosmark);
//...
printk(&quot;befor push %d %d\n&quot;, skb-&gt;qosmark, user_id);
skb-&gt;qosmark = user_id;

ppp-&gt;xmit_pending = skb;
ppp_push(ppp);
</code></pre>

<p>//dmesg<br />
[  304.600000] ct 132, 132, 0, 33<br />
[  304.610000] hit b 132<br />
[  304.610000] hit a 0<br />
[  304.610000] befor push 0 132<br />
[  304.610000] out chan 132<br />
[  304.620000] chan ok132<br />
[  304.620000] qosmark132 132</p>

<pre><code>so we need backup qosmark be for invoking this function then restore it.
</code></pre>

<p>}</p>

<p>ppp_push(struct ppp *ppp)<br />
{<br />
    struct list_head *list;<br />
    struct channel *pch;<br />
    struct sk_buff *skb = ppp-&gt;xmit_pending;</p>

<pre><code>if (!skb)
    return;

list = &amp;ppp-&gt;channels;
if (list_empty(list)) {
    /* nowhere to send the packet, just drop it */
    ppp-&gt;xmit_pending = NULL;
    kfree_skb(skb);
    return;
}

if ((ppp-&gt;flags &amp; SC_MULTILINK) == 0) {
    /* not doing multilink: send it down the first channel */
    list = list-&gt;next;
    pch = list_entry(list, struct channel, clist);

    printk(&quot;out chan %d\n&quot;, skb-&gt;qosmark);
    spin_lock_bh(&amp;pch-&gt;downl);
    if (pch-&gt;chan) {
        printk(&quot;chan ok%d\n&quot;, skb-&gt;qosmark);
        if (pch-&gt;chan-&gt;ops-&gt;start_xmit(pch-&gt;chan, skb))
            ppp-&gt;xmit_pending = NULL;
    } else {
        /* channel got unregistered */
        printk(&quot;no chan\n&quot;, skb-&gt;qosmark);
        kfree_skb(skb);
        ppp-&gt;xmit_pending = NULL;
</code></pre>

		</article>
	  </div>
	</section>

<aside id=comments>
    <div><h2> Comments </h2></div>
    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'firoyang';
    var disqus_identifier = 'http:\/\/firoyang.org\/net\/tunnel\/';
    var disqus_title = 'tunnel';
    var disqus_url = 'http:\/\/firoyang.org\/net\/tunnel\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</aside>

<footer>
  <div>
    <p>
    &copy; 2014 ~ 2016 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Firo Yang </span></span><a href="http://creativecommons.org/licenses/by/4.0/">Some rights reserved</a>. 
	Powered by <a href="http://gohugo.io">Hugo</a>.
        Theme by <a href="http://spf13.com">Steve Francia <a href="http://firoyang.org">Firo Yang</a>.
    </p>
  </div>
</footer>
<script type="text/javascript">
(function(){var j=function(a,b){return window.getComputedStyle?getComputedStyle(a).getPropertyValue(b):a.currentStyle[b]};var k=function(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else a.attachEvent('on'+b,c)};var l=function(a,b){for(key in b)if(b.hasOwnProperty(key))a[key]=b[key];return a};window.fitText=function(d,e,f){var g=l({'minFontSize':-1/0,'maxFontSize':1/0},f);var h=function(a){var b=e||1;var c=function(){a.style.fontSize=Math.max(Math.min(a.clientWidth/(b*10),parseFloat(g.maxFontSize)),parseFloat(g.minFontSize))+'px'};c();k(window,'resize',c)};if(d.length)for(var i=0;i<d.length;i++)h(d[i]);else h(d);return d}})();
fitText(document.getElementById('title'), 1)
</script>




</body>
</html>


<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>

</body>
