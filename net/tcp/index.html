<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="net, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Transport layer : firoyang.org"/>
<meta property="og:site_name" content="Firo Website"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://firoyang.org/net/tcp/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2015-02-27"/>
<meta property="article:modified_time" content="2015-02-27"/>


<meta property="article:tag" content="net">





    <base href="http://firoyang.org/">
    <title> Transport layer</title>
    <link rel="canonical" href="http://firoyang.org/net/tcp/">

    
<link rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/static/css/style.css">


    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
     
</head>

<body style="background-color:#FFFFF0;" lang="en" itemscope itemtype="http://schema.org/Article">
<body lang="en" itemscope itemtype="http://schema.org/Article">
<header id="header">
	<link rel="stylesheet" href="static/css/font-awesome.min.css">
	<nav id="nav">
	<div id="title"><a href="/" style="color:#B22222;">ƒ(x)</a></div>


	
	</nav>
	<nav id="nav">
    	        <ul id="mainnav">
            <li>
            <a href="/review/" >
                <span class="icon"> <i aria-hidden="false" style="background-color:#FFFFF0" class="fa fa-thumbs-o-up"></i></span>
                <span> review</span>
            </a>
            </li>
            <li>
            <a href="/life/" >
                <span class="icon"> <i aria-hidden="true" style="background-color:#FFFFF0" class="fa fa-male"></i></span>
                <span> life </span>
            </a>
            </li>
            <li>
            <a href="/history/" >
                <span class="icon"> <i aria-hidden="false" style="background-color:#FFFFF0" class="fa fa-institution"></i></span>
                <span> history </span>
            </a>
	    <li>
                <a href="/linguistics/" >
                <span class="icon"> <i aria-hidden="true" style="background-color:#FFFFF0" class="fa fa-language"></i></span>
                <span> linguistics </span>
            </a>
            </li>
            </li>
            <li>
                <a href="/howto/" >
                <span class="icon"> <i aria-hidden="true" style="background-color:#FFFFF0" class="fa fa-gamepad"></i></span>
                <span> howto </span>
            </a>
            </li>
            <li>
            <a href="/cs/" >
                <span class="icon"> <i aria-hidden="true" style="background-color:#FFFFF0" class="fa fa-linux"></i></span>
                <span> cs </span>
            </a>
            </li>
            <li>
            <a href="/net/" >
                <span class="icon"> <i aria-hidden="true" style="background-color:#FFFFF0" class="fa fa-globe"></i></span>
                <span> net </span>
            </a>
            </li>
            <li>
            <a href="/philosophy/" >
                <span class="icon"> <i aria-hidden="true" style="background-color:#FFFFF0" class="icon-leaf"></i></span>
                <span> philosophy </span>
            </a>
            </li>

            
            

            <li>
            <a href="/" style="color:#B22222" >
                <span class="icon" > <i aria-hidden="true" style="background-color:#FFFFF0" class="fa fa-rocket"></i></span>
                
            </a>
            </li>

        </ul>

	</nav>
	<nav id="nav">
               <ul id="social">

            <li id="follow">
                
                
                <div class="dropdown follow">
                    <ul class="social">
                        <li> <a href="http://www.twitter.com/firoyang" target="_blank" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="mailto:firogm@gmail.com" style="color:#B22222;"  class="gmail"><span style="color:#B22222;" class="icon icon-mail"></span>Gmail</a> </li-->
                        
                        
                        
                        
                        
                        
                        
                    </ul>
                    
                </div>
            </li>
            

        </ul>

	</nav>
</header>



 <link rel="stylesheet" href="highlight.js/styles/monokai-sublime.css">
    <script src="highlight.js/highlight.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
	<section id="main">

	  <h1 itemprop="name" id="title" style="color:#B22222;" >Transport layer</h1>
	  

<aside id="meta">

    <div>
        <section id="datecount">
          <h4 id="date"> Fri Feb 27, 2015 </h4>
          
        </section>
        
        <ul id="tags">
          
            <li> <a href="http://firoyang.org//tags/net">net</a> </li>
          
        </ul>

    </div>


</aside>

<meta itemprop="wordCount" content="485">
<meta itemprop="datePublished" content="2015-02-27">
<meta itemprop="url" content="http://firoyang.org/net/tcp/">


	  <div>
		<article itemprop="articleBody" id="content">
		   

<h1 id="references">References</h1>

<p>man tcp<br />
<a href="http://tools.ietf.org/html/rfc7414">A Roadmap for Transmission Control Protocol (TCP) Specification Documents</a><br />
<a href="https://tools.ietf.org/html/rfc1122">Requirements for Internet Hosts &ndash; Communication Layers</a><br />
<a href="http://tools.ietf.org/html/rfc793">TRANSMISSION CONTROL PROTOCOL 1981</a></p>

<h1 id="send-tcp-message">Send tcp message</h1>

<p>server:<br />
nc -l -p 2046<br />
nc  127.0.0.1 2046</p>

<h1 id="syn-queue-and-listen-queue">Syn queue and listen queue</h1>

<p><a href="http://veithen.github.io/2014/01/01/how-tcp-backlog-works-in-linux.html">How TCP backlog works in Linux</a></p>

<h1 id="syn-flood">Syn flood</h1>

<p><a href="https://githubengineering.com/syn-flood-mitigation-with-synsanity/">SYN Flood Mitigation with synsanity</a></p>

<h1 id="ucopy">ucopy</h1>

<p>ucopy.task was temporarily enabled in tcp_recvmsg in order to read more data after processing receive queue.<br />
It will be disabled in the same fuction. So go back to tcp_prequeue, we know if user need more data, then we queue new skb in ucopy.preueue otherwise not.<br />
In tcp_rcv_established(), the tp-&gt;ucopy.task == current indicats we are in process context.</p>

<h1 id="multiplexing">Multiplexing</h1>

<p>Ports can provide multiple endpoints on a single node.<br />
inet_hash_connect()<br />
inet_sock: dport, sport</p>

<h1 id="mss">MSS</h1>

<p>MSS tcp_sock-&gt;mss_cache in tcp_sync_mss not minus SACK option<br />
        in <em>tcp_current_mss</em> minus SACK option<br />
sudo tcpdump -s0 -p -ni enp0s31f6 &lsquo;(ip and ip[20+13] &amp; tcp-syn != 0)&rsquo;<br />
send: tcp_advertise_mss<br />
tcp_current_mss<br />
<a href="https://medium.com/fcamels-notes/%E7%94%A8-systemtap-%E6%89%BE%E5%87%BA-tcp-%E5%A6%82%E4%BD%95%E6%B1%BA%E5%AE%9A-mss-%E7%9A%84%E5%80%BC-4b6b7a969d04">用 SystemTap 找出 TCP 如何決定 MSS 的值</a><br />
mss derives from MTU; see rfc6691<br />
When TCP is used in a situation where either the IP or TCP headers are not minimum, the sender must reduce the amount of TCP data in any given packet by the number of octets used by the IP and TCP options.</p>

<h1 id="sack">Sack</h1>

<p><a href="http://www.tecyle.com/2019/06/22/sack-%E5%88%86%E6%9E%90/">SACK 分析</a></p>

<h1 id="time-wait">Time-wait</h1>

<p><a href="https://vincent.bernat.ch/en/blog/2014-tcp-time-wait-state-linux">Coping with the TCP TIME-WAIT state on busy Linux servers</a><br />
tcp: remove tcp_tw_recycle - 4396e46187ca5070219b81773c4e65088dac50cc</p>

<p>双工, 1. 被动关闭收到ack就%100圆满了.而clinet就不能确认被动关闭是否收到ack,<br />
显然被动关闭方不能在ack了, 如果下去, 还有个完, 所以两害相权, 取其轻.clinet来吧.</p>

<ol>
<li><p>为了server考虑, server的session 链接必须别正常正确的关闭!<br />
如果没有time wait, 而且client的ack丢了, server 重传fin ack, clinet的linux<br />
发现这个fin对应的sock不存在, 直接RST, server异常关闭, 应用程序会检测到错误.<br />
不友好.</p></li>

<li><p>为了clinet, 不受旧server 干扰.<br />
这也是为什么要等2MSL</p></li>

<li><p>tcp_timestamps tcp_tw_recycle<br />
tcp_time_wait<br />
一起用如果recycle 不ok就是time wait就是TCP_TIMEWAIT_LEN（60s）</p></li>
</ol>

<p>两种方法可以进入time wait 状态 tw_substate做区分.<br />
FIN_WAIT_2 收到fin 见tcp_fin()这个函数<br />
这个, time wait 如果没有设置recycle就是TCP_TIMEWAIT_LEN,设置了就是rto<br />
可以说rto的值真的要比TCP_TIMEWAIT_LEN要小.</p>

<p>FIN_WAIT_2 超时假的time wait状态.貌似tcp_keepalive_timer()<br />
没有遵从协议但是没有break协议,是个优化.<br />
tcp_sock结构占用的资源要比tcp_timewait_sock结构占用的资源多, tcp_done干掉sock.<br />
在TIME_WAIT下也可以处理连接的关闭。<br />
这个,还一样time_wait是和rto TCP_TIMEWAIT_LEN有关.<br />
inet_twsk_schedule设置等的时间.</p>

<ul>
<li><p>tcp_tw_reuse<br />
server 端玩蛋去, 本身像80, 自带重用技能&hellip;<br />
用在clinet段inet_hash_connect检查是否可以重用TIME_WAIT状态的套接字的端口.</p></li>

<li><p>tcp_fin_timeout<br />
这个参数是FIN_WAIT_2 转到TIME_WAIT的时间.<br />
跟time wait时间, 没有直接联系! 好多blog都直接说成time wait的时间.<br />
这里是间接作用.<br />
FIXME&hellip;<br />
而time wait的时间看代码, 要不然是rto 要不然就是TCP_TIMEWAIT_LEN(60s)<br />
tcp_time_wait<br />
            if (recycle_ok) {<br />
                    tw-&gt;tw_timeout = rto;<br />
            } else {<br />
                    tw-&gt;tw_timeout = TCP_TIMEWAIT_LEN;<br />
                    if (state == TCP_TIME_WAIT)<br />
                            timeo = TCP_TIMEWAIT_LEN;<br />
            }<br />
如果启用recycle 就是rto, 这个rto是const int rto = (icsk-&gt;icsk_rto &lt;&lt; 2) - (icsk-&gt;icsk_rto &gt;&gt; 1); 3.5倍的icsk_rto<br />
在FIN_WAIT_2状态下没有接收到FIN包就进入TIME_WAIT的情况下，如果tcp_fin_timeout的值设置的太小，可能会导致TIME_WAIT套接字（子状态为FIN_WAIT_2）过早地被释放，这样对端发送的FIN（短暂地延迟或者本来就是正常的时间到达）到达时就没有办法处理，导致连接不正常关闭，所以tcp_fin_timeout参数的值并不是越小越好，通常设置为30S比较合适。</p></li>
</ul>

<h1 id="tcp-receive">TCP receive</h1>

<h1 id="established-socket-receive-window">Established socket receive window</h1>

<p><a href="https://tools.ietf.org/html/rfc793">https://tools.ietf.org/html/rfc793</a><br />
<a href="https://tools.ietf.org/html/rfc1122">https://tools.ietf.org/html/rfc1122</a><br />
tcp_transmit_skb<br />
th-&gt;ack_seq     = htonl(tp-&gt;rcv_nxt);<br />
tcp_data_queue</p>

<h2 id="tp-rcv-nxt-tcp-skb-cb-skb-end-seq">tp-&gt;rcv_nxt = TCP_SKB_CB(skb)-&gt;end_seq;</h2>

<h1 id="connection-oriented-communications">Connection-oriented communications</h1>

<h2 id="handshak-of-kproxy">Handshak of kproxy</h2>

<p>chome -&gt; syn(kproxy reocrd syn) -&gt; firoyang.org<br />
firoyang.org -&gt; sync ack -&gt; chrome<br />
chrome -&gt; ack -&gt; firoyang.org<br />
chrome -&gt; GET(firoyang.org) kproxy match then send record syn then setup natinfo -&gt; nginx<br />
nginx -&gt; tcp send fake syn ack-&gt; chrome<br />
chrome -&gt; ack -&gt; nginx(then -&gt; firoyang.org)<br />
tcp_v4_do_rcv{<br />
    sk-&gt;sk_state == TCP_ESTABLISHED<br />
    tcp_rcv_established{<br />
    len &lt;= tcp_header_len =&gt;<br />
    tcp_ack -&gt; tcp_fastretrans_alert{retrans ack and GET(firoyang) -&gt; nginx<br />
    }<br />
}<br />
nginx-&gt; GET -&gt; firoyang.org<br />
firoyang.org-&gt; nginx-&gt; chrome</p>

<h1 id="reliability">Reliability</h1>

<h2 id="rtt">RTT</h2>

<p>计算发送和返回ack的时间差.<br />
tcp_rtt_estimator()</p>

<h2 id="arq">ARQ</h2>

<p>ack and timeout<br />
Sliding window protocol is based on automatic repeat request/ARQ<br />
My conclusion: in practice TCP is a mixture between both GBN and SR.<br />
* Go-Back-N<br />
* Selective repeat</p>

<h2 id="timer-expiring-retransmiter">Timer expiring retransmiter</h2>

<p>tcp_retransmiter_timer()&hellip;-&gt;tcp_transmit_skb()</p>

<h2 id="reponse-for-receiving-an-ack">reponse for receiving an ACK</h2>

<p>tcp_data_snd_check()-&gt;tcp_write_xmit()</p>

<h2 id="timer">Timer</h2>

<p>sk_timer<br />
listen: synack<br />
estblished: keepalive<br />
timewait:</p>

		</article>
	  </div>
	</section>

<aside id=comments>
    <div><h2> Comments </h2></div>
    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'firoyang';
    var disqus_identifier = 'http:\/\/firoyang.org\/net\/tcp\/';
    var disqus_title = 'Transport layer';
    var disqus_url = 'http:\/\/firoyang.org\/net\/tcp\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</aside>

<footer>
  <div>
    <p>
    &copy; 2014 ~ 2016 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Firo Yang </span></span><a href="http://creativecommons.org/licenses/by/4.0/">Some rights reserved</a>. 
	Powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://fortawesome.github.io/Font-Awesome/">Font Awesome</a>.
        Theme by <a href="http://spf13.com">Steve Francia <a href="http://firoyang.org">Firo Yang</a>.
    </p>
  </div>
</footer>
<script type="text/javascript">
(function(){var j=function(a,b){return window.getComputedStyle?getComputedStyle(a).getPropertyValue(b):a.currentStyle[b]};var k=function(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else a.attachEvent('on'+b,c)};var l=function(a,b){for(key in b)if(b.hasOwnProperty(key))a[key]=b[key];return a};window.fitText=function(d,e,f){var g=l({'minFontSize':-1/0,'maxFontSize':1/0},f);var h=function(a){var b=e||1;var c=function(){a.style.fontSize=Math.max(Math.min(a.clientWidth/(b*10),parseFloat(g.maxFontSize)),parseFloat(g.minFontSize))+'px'};c();k(window,'resize',c)};if(d.length)for(var i=0;i<d.length;i++)h(d[i]);else h(d);return d}})();
fitText(document.getElementById('title'), 1)
</script>




</body>
</html>


<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>

</body>
