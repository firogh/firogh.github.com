<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kernel, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Yet another guide on the way to linux kernel hacking : firoyang.org"/>
<meta property="og:site_name" content="Firo Website"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://firoyang.org/cs/kernel_hacking/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2015-04-25"/>
<meta property="article:modified_time" content="2015-04-25"/>


<meta property="article:tag" content="kernel">





    <base href="http://firoyang.org/">
    <title> Yet another guide on the way to linux kernel hacking</title>
    <link rel="canonical" href="http://firoyang.org/cs/kernel_hacking/">

    
<link rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/static/css/style.css">


    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
     
</head>

<body style="background-color:#FFFFF0;" lang="en" itemscope itemtype="http://schema.org/Article">
<body lang="en" itemscope itemtype="http://schema.org/Article">
<header id="header">
	<link rel="stylesheet" href="static/css/font-awesome.min.css">
	<nav id="nav">
	<div id="title"><a href="/" style="color:#B22222;">ƒ(x)</a></div>


	
	</nav>
	<nav id="nav">
    	        <ul id="mainnav">
            <li>
            <a href="/review/" >
                <span class="icon"> <i aria-hidden="false" style="background-color:#FFFFF0" class="fa fa-thumbs-o-up"></i></span>
                <span> review</span>
            </a>
            </li>
            <li>
            <a href="/life/" >
                <span class="icon"> <i aria-hidden="true" style="background-color:#FFFFF0" class="fa fa-male"></i></span>
                <span> life </span>
            </a>
            </li>
            <li>
            <a href="/history/" >
                <span class="icon"> <i aria-hidden="false" style="background-color:#FFFFF0" class="fa fa-institution"></i></span>
                <span> history </span>
            </a>
	    <li>
                <a href="/linguistics/" >
                <span class="icon"> <i aria-hidden="true" style="background-color:#FFFFF0" class="fa fa-language"></i></span>
                <span> linguistics </span>
            </a>
            </li>
            </li>
            <li>
                <a href="/howto/" >
                <span class="icon"> <i aria-hidden="true" style="background-color:#FFFFF0" class="fa fa-gamepad"></i></span>
                <span> howto </span>
            </a>
            </li>
            <li>
            <a href="/cs/" >
                <span class="icon"> <i aria-hidden="true" style="background-color:#FFFFF0" class="fa fa-linux"></i></span>
                <span> cs </span>
            </a>
            </li>
            <li>
            <a href="/net/" >
                <span class="icon"> <i aria-hidden="true" style="background-color:#FFFFF0" class="fa fa-globe"></i></span>
                <span> net </span>
            </a>
            </li>
            <li>
            <a href="/philosophy/" >
                <span class="icon"> <i aria-hidden="true" style="background-color:#FFFFF0" class="icon-leaf"></i></span>
                <span> philosophy </span>
            </a>
            </li>

            
            

            <li>
            <a href="/" style="color:#B22222" >
                <span class="icon" > <i aria-hidden="true" style="background-color:#FFFFF0" class="fa fa-rocket"></i></span>
                
            </a>
            </li>

        </ul>

	</nav>
	<nav id="nav">
               <ul id="social">

            <li id="follow">
                
                
                <div class="dropdown follow">
                    <ul class="social">
                        <li> <a href="http://www.twitter.com/firoyang" target="_blank" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="mailto:firogm@gmail.com" style="color:#B22222;"  class="gmail"><span style="color:#B22222;" class="icon icon-mail"></span>Gmail</a> </li-->
                        
                        
                        
                        
                        
                        
                        
                    </ul>
                    
                </div>
            </li>
            

        </ul>

	</nav>
</header>



 <link rel="stylesheet" href="highlight.js/styles/monokai-sublime.css">
    <script src="highlight.js/highlight.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
	<section id="main">

	  <h1 itemprop="name" id="title" style="color:#B22222;" >Yet another guide on the way to linux kernel hacking</h1>
	  

<aside id="meta">

    <div>
        <section id="datecount">
          <h4 id="date"> Sat Apr 25, 2015 </h4>
          
        </section>
        
        <ul id="tags">
          
            <li> <a href="http://firoyang.org//tags/kernel">kernel</a> </li>
          
        </ul>

    </div>


</aside>

<meta itemprop="wordCount" content="1017">
<meta itemprop="datePublished" content="2015-04-25">
<meta itemprop="url" content="http://firoyang.org/cs/kernel_hacking/">


	  <div>
		<article itemprop="articleBody" id="content">
		   

<h1 id="hacking-goals">Hacking goals</h1>

<h2 id="trade-time-for-space">Trade time for space</h2>

<p>search_exception_tables</p>

<h1 id="define-asm-extable-handle-from-to-handler">define _ASM_EXTABLE_HANDLE(from, to, handler)                 </h1>

<pre><code>    .pushsection &quot;__ex_table&quot;,&quot;a&quot; ;                         \
    .balign 4 ;                                             \
    .long (from) - . ;                                      \
    .long (to) - . ;                                        \
    .long (handler) - . ;                                   \
    .popsection
</code></pre>

<h1 id="hacking-area">Hacking area</h1>

<p>mm<br />
<a href="https://kernsec.org/wiki/index.php/Kernel_Self_Protection_Project">https://kernsec.org/wiki/index.php/Kernel_Self_Protection_Project</a><br />
<a href="https://lwn.net/Articles/749064/">Variable-length arrays and the max() mess</a><br />
<a href="https://www.youtube.com/watch?v=wlqjQe3vDx8&amp;list=PLbzoR-pLrL6rOT6m50HdJFYUHyvA9lurI&amp;index=11&amp;t=0s">Sub-system Update: Kernel Self-Protection Project - Kees Cook, Google</a></p>

<h2 id="kernel-refactoring">Kernel refactoring</h2>

<p><a href="https://linuxtv.org/wiki/index.php/Development:_Hints_for_Refactoring_Existing_Drivers">https://linuxtv.org/wiki/index.php/Development:_Hints_for_Refactoring_Existing_Drivers</a><br />
<a href="https://www.youtube.com/watch?v=mxxicJZ8cis">Kernel Recipes 2017 - Refactoring the Linux Kernel - Thomas Gleixner</a></p>

<h2 id="feature">Feature</h2>

<p>some results or progress information for PFRA</p>

<h2 id="write-your-own-kernel">Write your own kernel</h2>

<p><a href="http://os.phil-opp.com/">Writing an OS in Rust</a><br />
<a href="http://www.brokenthorn.com/Resources/OSDevIndex.html">BrokenThorn Entertainment Operating System Development Series</a></p>

<h1 id="build">Build</h1>

<ul>
<li>if no .config, every config tools make a .config from scrach!<br /></li>
<li>oldconfig just for new moduels patch merged in trunk. This no any relations to .config.old and /boot/config.x.y.z<br /></li>
<li>make localmodconfig will reduce many unused kernel config.<br /></li>
<li>make bzImage  #kmods will not build that configured with M!<br /></li>
<li>make modules_install INSTALL_MOD_PATH=/home/firo/kmods<br />
##build signle kernel module<br />
make menuconfig<br />
make oldconfig &amp;&amp; make prepare<br />
make -C $(pwd) M=/home/firo/linux/fs/ext3 modules V=1<br />
make ARCH=arm CROSS_COMPILE=/usr/bin/arm-linux-gnu- drivers/pcmcia/sa11xx_base.o<br />
<br /></li>
</ul>

<h1 id="git-repos">Git repos</h1>

<p><a href="https://lwn.net/Articles/572068/">Git tree maintenance</a></p>

<h2 id="next-tree-2-6-1x-latest-tree-please-rebase-your-patch-against-this-tree-before-send-it-to-upstream">next tree - 2.6.1x ~ latest tree; please rebase your patch against this tree before send it to upstream</h2>

<p><a href="https://www.kernel.org/doc/man-pages/linux-next.html">Working with linux-next</a><br />
git add git://git.kernel.org/pub/scm/linux/kernel/git/next/linux-next.git</p>

<h2 id="tglx-tree-2-4-2-6-1x">tglx tree - 2.4 - 2.6.1x</h2>

<p>origin  git://git.kernel.org/pub/scm/linux/kernel/git/tglx/history.git (fetch)<br />
origin  git://git.kernel.org/pub/scm/linux/kernel/git/tglx/history.git (push)</p>

<h2 id="history-tree-0-2-4">history tree - 0 - 2.4</h2>

<p>origin  <a href="https://git.kernel.org/pub/scm/linux/kernel/git/history/history.git/">https://git.kernel.org/pub/scm/linux/kernel/git/history/history.git/</a> (fetch)<br />
origin  <a href="https://git.kernel.org/pub/scm/linux/kernel/git/history/history.git/">https://git.kernel.org/pub/scm/linux/kernel/git/history/history.git/</a> (push)<br />
git checkout -b 240p 2.4.0-prerelease</p>

<h1 id="blogs">Blogs</h1>

<p><a href="http://www.joelfernandes.org/linuxinternals/">http://www.joelfernandes.org/linuxinternals/</a><br />
<a href="https://paulmck.livejournal.com/">https://paulmck.livejournal.com/</a></p>

<h2 id="traning">Traning</h2>

<p><a href="https://www.kernel.org/doc/htmldocs/kernel-hacking/index.html">Unreliable Guide To Hacking The Linux Kernel</a><br />
<a href="https://linux-kernel-labs.github.io/master/index.html">Bootlin linux kernel labs</a></p>

<h1 id="mailing-list-archives">Mailing list archives</h1>

<p><a href="https://www.kernel.org/lore.html">The Linux Kernel Archives</a><br />
Online: <a href="https://lore.kernel.org/lists.html">https://lore.kernel.org/lists.html</a><br />
Git: <a href="https://git.kernel.org/pub/scm/public-inbox/">https://git.kernel.org/pub/scm/public-inbox/</a><br />
<a href="https://lwn.net/Articles/758034/">LKML archives on lore.kernel.org</a><br />
and marc.info</p>

<h1 id="source-code-navigator">Source code navigator</h1>

<p>Just make tags; make cscope<br />
<a href="https://www.gnu.org/software/global/links.html">&lsquo;Source code reading&rsquo; related sites</a></p>

<h1 id="kvm">KVM</h1>

<p><a href="https://blacks3pt3mb3r.wordpress.com/linux-stuffz/264-2/">Building a KVM host machine.</a><br />
<a href="https://lwn.net/Articles/660404/">Speeding up kernel development with QEMU</a><br />
<a href="http://mgalgs.github.io/2015/05/16/how-to-build-a-custom-linux-kernel-for-qemu-2015-edition.html">How to Build A Custom Linux Kernel For Qemu</a><br />
<a href="https://morbidrsa.github.io/2017/04/19/rapid-kernel-development-with-dracut-and-qemu.html">Rapid kernel development with dracut and Qemu</a></p>

<h2 id="suse">SUSE</h2>

<p>zypper &ndash;root /home/firo/ws/suse addrepo <a href="http://download.opensuse.org/distribution/leap/15.0/repo/oss/">http://download.opensuse.org/distribution/leap/15.0/repo/oss/</a> foss<br />
<a href="https://en.opensuse.org/Package_repositories">https://en.opensuse.org/Package_repositories</a><br />
zypper &ndash;root /home/firo/ws/suse install kernel-default-devel</p>

<h2 id="build-minimal-bootable-rootfs-fedora">Build minimal bootable rootfs - fedora</h2>

<p>./etc/yum.repos.d/<br />
./etc/yum.repos.d/fedora-updates-testing.repo<br />
./etc/yum.repos.d/fedora.repo<br />
./etc/yum.repos.d/fedora-updates.repo<br />
./etc/yum.repos.d/fedora-cisco-openh264.repo<br />
can be gotten by supermin &ndash;prepare bash -o /tmp/supermin.d<br />
or just copy from you host to some place like /home/firo/kernel/k/testfs/<br />
sudo dnf &ndash;releasever=27 &ndash;installroot=/home/firo/kernel/k/testfs/ &ndash;setopt=reposdir=/home/firo/kernel/k/testfs/etc/yum.repos.d install dnf udev passwd</p>

<h2 id="how-to-build-a-minimal-kernel-for-testing">How to build a minimal kernel for testing?</h2>

<p>[tiny config @ kernel.org][5]<br />
[3 attempts to reduce the configurations][6]<br />
<a href="7">Fedora equivalent of debootstrap</a><br />
Then enable following config option<br />
CONFIG_CHR_DEV_SG<br />
Some ftrace stuff<br />
CONFIG_SLUB<br />
CONFIG_KASAN</p>

<h2 id="kernel-org-build-a-tiny-kernel-https-tiny-wiki-kernel-org"><a href="https://tiny.wiki.kernel.org/">Kernel.org: Build a tiny kernel</a></h2>

<h2 id="make-initrd-for-nfs">make initrd for NFS</h2>

<p><a href="http://migueleonardortiz.com.ar/linux/upgrade-kernel-and-initrd-in-linux/2067">Upgrade kernel and initrd in Linux</a><br />
sudo chroot suse mkinitrd -m &lsquo;nfs nfsv3 nfsv4 iwlwifi&rsquo; -A -D wlp4s0</p>

<h2 id="kvm-and-nfs">KVM and NFS</h2>

<p>qemu-system-x86_64 -nographic -enable-kvm  -kernel ./bzImag  -append &lsquo; console=ttyS0 ip=dhcp root=/dev/nfs nfsroot=192.168.0.104:/home/firo/kernel/k/testfs,nfsvers=3,tcp rw nfsrootdebug debug  raid=noautodetect selinux=0 enforcing=0 &lsquo;<br />
dnf install nfs-utils<br />
cat /etc/exports # For more details, man exports<br />
/home/firo/kernel/k/testfs 127.0.0.1(rw,sync,fsid=0,no_root_squash)<br />
systemctl start nfs-server.service<br />
systemctl status nfs-server.service<br />
● nfs-server.service - NFS server and services<br />
   Loaded: loaded (/usr/lib/systemd/system/nfs-server.service; disabled; vendor preset: disabled)<br />
   Active: active (exited) since Sat 2018-03-17 17:52:29 CST; 4s ago</p>

<h3 id="test-the-nfs">Test the nfs</h3>

<p>sudo mount -t nfs localhost://home/firo/kernel/k/testfs /mnt<br />
if touch prermission denied, add no_all_squash to/etc/exports</p>

<h2 id="nfs-errors">NFS errors</h2>

<p>[   54.600121] NFS: sending MNT request for 10.0.2.2:/buildarea1/firo/ima/export/dist<br />
[   54.600121] NFS: failed to create MNT RPC client, status=-101<br />
[   54.600121] NFS: unable to mount server 10.0.2.2, error -101<br />
CONFIG_E100 CONFIG_E1000 &hellip;and IP_PNP and DHCP BOOTP RARP<br />
try: nfsvers=3,tcp and 192.168.0.104 or 10.0.2.2 are mandatory!</p>

<h2 id="nfs-vers">NFS vers</h2>

<p>rpcinfo -t localhost nfs<br />
program 100003 version 3 ready and waiting<br />
program 100003 version 4 ready and waiting<br />
rpcinfo -p | grep nfs<br />
    100003    3   tcp   2049  nfs<br />
    100003    4   tcp   2049  nfs<br />
    100227    3   tcp   2049  nfs_acl</p>

<h1 id="submitting-patch">Submitting patch</h1>

<h2 id="patch-prefix">Patch prefix</h2>

<pre><code>git log --oneline  path/to/file.c
</code></pre>

<h2 id="resending-the-patch">Resending the patch</h2>

<p><a href="https://meta.stackexchange.com/questions/314212/why-is-it-called-initial-revision-if-its-not-a-revision">First revision, version, second revision</a><br />
<a href="https://kernelnewbies.org/Outreachyfirstpatch">Versioning one patch revision</a><br />
<a href="https://kernelnewbies.org/PatchTipsAndTricks">For example, if you&rsquo;re sending the second revision of a patch, you should use [PATCH v2]</a><br />
<a href="https://kernelnewbies.org/PatchPhilosophy">use PATCHv2 (or PATCHv3 and so on) in the subject lines instead of PATCH &hellip; To update the subject lines, add the -v 2 (or -v 3, etc) options to git format-patch</a><br />
<a href="https://kernelnewbies.org/PatchPhilosophy">Finally, to send your new patch series as a reply to the previous one, first look up the Message-Id of the cover letter (or the one-and-only patch) in your previous patch series, and then pass that to the &ndash;in-reply-to= option of either git format-patch or git send-email.</a><br />
<a href="https://kernelnewbies.org/PatchTipsAndTricks">Patch v2, v3, &hellip; Changes, tags</a></p>

<h2 id="patch-in-series-with-a-cover">Patch in series with a cover</h2>

<pre><code>proxychains git send-email --subject &quot;[PATCH v2 0/15] Remove unneeded casts of memory-alloc function return values&quot; --thread --compose --confirm=compose --to firogm@gmail.com *.patch
</code></pre>

<h2 id="dave-s-miller-s-perferences">Dave S Miller&rsquo;s perferences</h2>

<p>@@ -325,13 +325,15 @@ static inline void empty_child_dec(struct key_vector *n)<br />
  static struct key_vector *leaf_new(t_key key, struct fib_alias *fa)<br />
  {<br />
-       struct tnode *kv = kmem_cache_alloc(trie_leaf_kmem, GFP_KERNEL);<br />
-       struct key_vector *l = kv-&gt;kv;<br />
+       struct tnode *kv;<br />
+       struct key_vector *l;<br />
Dave Miller usually prefers it if variables are ordered from longest to shortest.  So you should probably have l defined first, and then kv.</p>

<h2 id="julia-lawall-sorry-to-be-picky">Julia Lawall Sorry to be picky,</h2>

<p>but normally people put a space after the colon.  Also,<br />
the subject line could be shorter: Remove unneeded cast.<br />
The description part of the subject doesnt have to be unique,<br />
just the whole thing, asfter the [PATCH] part.</p>

<h2 id="dan-carpenter">Dan Carpenter</h2>

<p>Otherwise your patch was fine, btw.  Other improvements.<br />
Don&rsquo;t put &ldquo;Drivers:&rdquo; in the subject.<br />
On Wed, Apr 22, 2015 at 09:10:50PM +0800, Firo Yang wrote:<br />
&gt; From: Firo Yang <a href="mailto:firogm@gmail.com">firogm@gmail.com</a><br />
Don&rsquo;t include this line.  We can get it from you email address.<br />
Include everyone from the ./scripts/get_maintainer.pl output except<br />
don&rsquo;t include linux-kernel@vger.kernel.org if there is another mailing<br />
list there already.</p>

<h2 id="kubecek">Kubecek</h2>

<p>│17:31:57 mkubecek | For the record, once the commit is in net or net-next tree, there is no chance to tweak its commit message. │ vtsironis_ho<br />
│17:32:26   alesak | mkubecek: ok, thanks for the clarification                                                                  │ wpreston<br />
│17:33:19 mkubecek | These trees do not rebase and some people (like me) would appreciate if other subsystem trees didn&rsquo;t        │ Zara<br />
│                  | either.                                                                                                     │ zuzka<br />
│17:34:20 mkubecek | We could avoid spurious git_sort failures and commits like kernel-source 174731527683</p>

<h1 id="git-mutt-patch">git mutt patch</h1>

<p><a href="https://www.youtube.com/watch?v=6zUVS4kJtrA">Greg: How to Apply a Patch to the Linux Kernel Stable Tree</a></p>

<h2 id="newbies-what-to-do">newbies! what to do?</h2>

<p><a href="https://lwn.net/Articles/286244/">Peter Zijlstra: From DOS to kernel hacking</a><br />
<a href="http://kernelnewbies.org/KernelJanitors/Todo">KernelJanitors/Todo</a><br />
<a href="https://lwn.net/Articles/284099/">linux-wanking@vger.kernel.org</a></p>

<h2 id="smatch">Smatch</h2>

<pre><code>    make CHECK=&quot;~/path/to/smatch/smatch -p=kernel&quot; C=1 \
            bzImage modules | tee warns.txt
</code></pre>

<h2 id="coccinelle">Coccinelle</h2>

		</article>
	  </div>
	</section>

<aside id=comments>
    <div><h2> Comments </h2></div>
    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'firoyang';
    var disqus_identifier = 'http:\/\/firoyang.org\/cs\/kernel_hacking\/';
    var disqus_title = 'Yet another guide on the way to linux kernel hacking';
    var disqus_url = 'http:\/\/firoyang.org\/cs\/kernel_hacking\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</aside>

<footer>
  <div>
    <p>
    &copy; 2014 ~ 2016 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Firo Yang </span></span><a href="http://creativecommons.org/licenses/by/4.0/">Some rights reserved</a>. 
	Powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://fortawesome.github.io/Font-Awesome/">Font Awesome</a>.
        Theme by <a href="http://spf13.com">Steve Francia <a href="http://firoyang.org">Firo Yang</a>.
    </p>
  </div>
</footer>
<script type="text/javascript">
(function(){var j=function(a,b){return window.getComputedStyle?getComputedStyle(a).getPropertyValue(b):a.currentStyle[b]};var k=function(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else a.attachEvent('on'+b,c)};var l=function(a,b){for(key in b)if(b.hasOwnProperty(key))a[key]=b[key];return a};window.fitText=function(d,e,f){var g=l({'minFontSize':-1/0,'maxFontSize':1/0},f);var h=function(a){var b=e||1;var c=function(){a.style.fontSize=Math.max(Math.min(a.clientWidth/(b*10),parseFloat(g.maxFontSize)),parseFloat(g.minFontSize))+'px'};c();k(window,'resize',c)};if(d.length)for(var i=0;i<d.length;i++)h(d[i]);else h(d);return d}})();
fitText(document.getElementById('title'), 1)
</script>




</body>
</html>


<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>

</body>
