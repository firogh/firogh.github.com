
 <!DOCTYPE HTML>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  
    <title>Firo Notes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Firo Yang">
    

    
    <meta name="description" content="firo">
<meta property="og:type" content="website">
<meta property="og:title" content="Firo Notes">
<meta property="og:url" content="http://firoyang.org/page/2/">
<meta property="og:site_name" content="Firo Notes">
<meta property="og:description" content="firo">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Firo Notes">
<meta name="twitter:description" content="firo">
<meta name="twitter:creator" content="@firoter">
<link rel="publisher" href="116338260303228780000">


    
    <link rel="alternative" href="/atom.xml" title="Firo Notes" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Firo Notes" title="Firo Notes"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Firo Notes">Firo Notes</a></h1>
				<h2 class="blog-motto">kernel, philosophy, beautiful things</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:firoyang.org">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/02/27/cs/cs/" title="Computer science a kernel programmer&#39;s perspective" itemprop="url">Computer science a kernel programmer&#39;s perspective</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/116338260303228780000?rel=author" title="Firo Yang" target="_blank" itemprop="author">Firo Yang</a>
		
  <p class="article-time">
    <time datetime="2015-02-27T07:46:14.000Z" itemprop="datePublished"> Published Feb 27 2015</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Epistemology">Epistemology</h1>
<p>石里克 &lt;普通认识论&gt;<br>胡适&lt;实用主义&gt;<br>Faq list<br>Incessancily continuously Share your what read, thought<br>GEB</p>
<ul>
<li>s3c24xx@gmail.com<br>凭什么我们就如此受制于人or 书？他就能搞懂，而我就不行呢？”。<br>其实，我们需要的是一种重其意而忘其形的根本之道，<br>需要的是一种兵来将挡，火来水淹的通用解决方法。<br>而绝不是淹没于牛人们的结论中。</li>
</ul>
<ul>
<li>否则，遇到一个新的问题，就只能埋怨牛人的书还不够厚，以至于没把你需要的东西也包括进去了。</li>
</ul>
<h1 id="Mathematics">Mathematics</h1>
<p>In mathematics, and more specifically in algebra, a domain is a ring such that ab = 0 implies a = 0 or b = 0.</p>
<h1 id="Automata">Automata</h1>
<p>Logic and Mathematics -&gt; Turning machine and automata -&gt; computer</p>
<h1 id="Logic">Logic</h1>
<ul>
<li>Completeness, this one is most important part!</li>
<li>Consistency</li>
<li>Soundness 一一性</li>
</ul>
<h1 id="Language">Language</h1>
<p>More details in programming language notes</p>
<h1 id="Algorithm">Algorithm</h1>
<p>Algorithms: Design Techniques and Analysis</p>
<h1 id="Design_pattern">Design pattern</h1>
<p>Publish-Subscribe Mechanism<br>observation</p>
<h1 id="Hardware">Hardware</h1>
<p>More details in hardware notes </p>
<h1 id="OS">OS</h1>
<h2 id="Process_management">Process management</h2>
<p>进程的定义和PCB，进程和线程的区别，进程的三个基本状态及它们之间的转换关系，进程的同步，竞争和死锁，进程间通信</p>
<h3 id="Representation">Representation</h3>
<ul>
<li>Programe  memory<br>Stack(User/Kernel)<br>Heap<br>Data segment(data/bss)<br>Code segment</li>
<li>PCB<br>Resource<br>Processor Context<br>Process state<h3 id="daemonize">daemonize</h3>
<a href="http://fixunix.com/unix/84640-daemon-controlling-terminal.html" target="_blank" rel="external">http://fixunix.com/unix/84640-daemon-controlling-terminal.html</a></li>
</ul>
<h2 id="Memory_managerment">Memory managerment</h2>
<p>分页式管理，分段式管理，虚拟内存的概念，页面置换算法，内存分配算法</p>
<h3 id="Paging">Paging</h3>
<p>paging is one of the memory management schemes by which<br>a computer stores and retrieves data from the secondary storage for use in main memory.</p>
<ul>
<li>Page fault<h3 id="Page_replacement_algorithm">Page replacement algorithm</h3>
OPT<br>FIFO<br>Second-chance<br>LRU<h3 id="x86_memory_segmentation">x86 memory segmentation</h3>
linux 基本不用<br><a href="http://oss.org.cn/kernel-book/ch02/2.3.7.htm" target="_blank" rel="external">Linux中的段</a></li>
<li>GDT</li>
<li>TSS<br><a href="https://en.wikipedia.org/wiki/Task_state_segment#Use_of_TSS_in_Linux" target="_blank" rel="external">Use of TSS in Linux</a></li>
<li>Linear address<h3 id="Virtual_memory"><a href="https://en.wikipedia.org/wiki/Virtual_memory#Paged_virtual_memory" target="_blank" rel="external">Virtual memory</a></h3>
It maps memory addresses used by a program, called virtual addresses, into physical addresses in computer memory.</li>
<li>Logic/Virtual address</li>
<li>Page table<h3 id="Memory_allocation">Memory allocation</h3>
</li>
<li>Buddy memory allocation. </li>
<li>Slab allocation/Memory Pool</li>
</ul>
<h2 id="Device_management">Device management</h2>
<p>中断的概念，中断处理，I/O控制方式，缓冲区管理，设备驱动，磁盘调度和高速缓存</p>
<h3 id="Low_I/O_type">Low I/O type</h3>
<ul>
<li>Programmed I/O/Polling</li>
<li>DMA</li>
<li>Interrupt I/O</li>
<li>Channel I/O<h3 id="I/O_scheduling">I/O scheduling</h3>
Elevator algorithm</li>
</ul>
<h3 id="Asynchronous_I/O_NEED_CLEAN">Asynchronous I/O NEED CLEAN</h3>
<ul>
<li>synchronous I/O multiplexing and I/O event notification facility<br>select/poll/epoll<br>For the ease of use, the select loop is implemented as an <em>event loop</em> with callbacks.<br>libevent and libev is a well-designed <em>event loop</em>.Check shadowsocks for using of libev.</li>
</ul>
<h2 id="File_system">File system</h2>
<p>文件的概念，文件的管理，文件系统</p>
<h2 id="System_calls">System calls</h2>
<p>系统调用的概念，系统调用的处理，系统调用类型</p>
<h1 id="I/O">I/O</h1>
<p>CPU and main memory is the brain of a computer.<br>Any transfer of information to or from the CPU/memory combo, for example by reading data from a disk drive, is considered I/O. </p>
<h2 id="CPU-device_I/O">CPU-device I/O</h2>
<h3 id="Memory-mapped_I/O">Memory-mapped I/O</h3>
<p>ioremap: physical address-&gt;logical address, simlar to vmalloc except we need not page.</p>
<h3 id="Ported-mapped_I/O">Ported-mapped I/O</h3>
<h2 id="Non_CPU-device_I/O">Non CPU-device I/O</h2>
<h3 id="I/O_channels">I/O channels</h3>
<h2 id="Interface">Interface</h2>
<p><a href="http://www.cs.uwm.edu/classes/cs458/Lecture/HTML/ch11s02.html" target="_blank" rel="external">Methods for designing a CPU’s I/O interface generally fall into one of the following categories:</a><br>Completely separate memory and I/O. buses DMA?<br>Common buses, separate control lines. Port-I/O<br>Common buses and control line. Memroy-maped I/O</p>
<h3 id="Higher_level_implemention">Higher level implemention</h3>
<p>device or partion of device/memory -&gt; file<br>io -&gt; stream</p>
<h4 id="stream)"><a href="https://en.wikipedia.org/wiki/Stream_(computing" target="_blank" rel="external">stream</a>)</h4>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Standard_streams" target="_blank" rel="external">Standard streams</a><br>interface is stdio library or the kernel version.</li>
<li>codata</li>
</ul>
<h1 id="Buffer">Buffer</h1>
<p>a data buffer (or just buffer) is a region of a physical memory storage<br>used to temporarily store data while it is being moved from one place to another.</p>
<ul>
<li>Page cache, Buffer head</li>
<li>Pipe</li>
</ul>
<h1 id="Cache">Cache</h1>
<p>a cache is a component that stores data so future requests for that data can be served faster;<br>the data stored in a cache might be the results of an earlier computation,<br>or the duplicates of data stored elsewhere. </p>
<h2 id="CPU_cache">CPU cache</h2>
<p>A CPU cache is a cache used by the central processing unit (CPU) of a computer<br>to reduce the average time to access data from the main memory.</p>
<h3 id="Associativity_-_CPU_Cache_algorithms">Associativity - CPU Cache algorithms</h3>
<ul>
<li>Two-way set associative cache</li>
</ul>
<h3 id="Cache_coherence">Cache coherence</h3>
<p>Cache coherence is the consistency of shared resource data that ends up stored in multiple local caches.<br>Cache conerence is mantained by mostly archtecure like cpu</p>
<ul>
<li>MSI</li>
</ul>
<h3 id="Cache_type">Cache type</h3>
<ul>
<li>Instructin cache</li>
<li>Data cache</li>
<li>TLB - Translation lookaside buffer<h2 id="GPU_cache">GPU cache</h2>
<h2 id="Disk_cache">Disk cache</h2>
<h2 id="Web_cache">Web cache</h2>
</li>
</ul>
<h1 id="Data_struct_aligment">Data struct aligment</h1>
<p><a href="http://www.catb.org/esr/structure-packing/" target="_blank" rel="external">The Lost Art of C Structure Packing</a><br><a href="http://en.wikipedia.org/wiki/Data_structure_alignment#Typical_alignment_of_C_structs_on_x86" target="_blank" rel="external">Typical alignment of C structs on x86</a></p>
<h2 id="为什么需要结构体对齐?">为什么需要结构体对齐?</h2>
<p>struct foo {<br>char c;<br>int i;<br>};<br>如果是32位, cpu 一次取4byte a word 数据.<br>如果我们把i的前3byte和c存到一起, 剩下1byte of i自己单独存.<br>那么我们访问i这个数据就要读两个4byte a word. 对cpu来说性能损耗.<br>如果我们把i单独放到4byte 对齐的地址, 那么我们只需要一次cpu读取.fast!</p>
<h2 id="产生非对齐访问的场景">产生非对齐访问的场景</h2>
<ol>
<li>Casting variables to types of different lengths, 比如char <em> 到int </em></li>
<li>Pointer arithmetic followed by access to at least 2 bytes of data , 不太理解.</li>
</ol>
<h2 id="我们做什么?">我们做什么?</h2>
<ul>
<li>什么也不干, 按默认对齐来Natural alignment</li>
<li>为了不影响性能, 同时减少内存使用, 编程时最好显示reorder.</li>
<li>get/put_unaligned  to avoid analigned access.</li>
<li>通过attribute aligned指定对齐要求.</li>
<li>数据要在不同体系, 32/64之间使用, 比如网络,写到disk, 我们必须要attribute packed<br>也就是说不对齐, 不同平台对齐可能不同, 我们不能让数据corruption.</li>
</ul>
<h2 id="如果数据不对齐有什么,_cpu怎么办?">如果数据不对齐有什么, cpu怎么办?</h2>
<p><a href="https://www.kernel.org/doc/Documentation/unaligned-memory-access.txt" target="_blank" rel="external">必读UNALIGNED MEMORY ACCESSES</a></p>
<ol>
<li>如果用了packed, 编译器会生成extra代码阻止非对齐访问, performance loss.</li>
<li>cpu呢? 可能正确处理raise a exception to fix it with performance loss.</li>
</ol>
<h2 id="Calculate_the_sizeof_of_aligned_c_struct">Calculate the sizeof of aligned c struct</h2>
<p>Data alignment means putting the data at a memory address equal to some multiple of the word size,<br>which increases the system’s performance due to the way the CPU handles memory.</p>
<ol>
<li>find the widest scalar member and attribute( aligned(x)) to determin alignment.<br>找到结构体内scalar和attribute最大的对齐要求.</li>
<li>fill the member to alignement without wrap<br>把结构的成员一次填满对齐宽度, 不够的填到下个对齐宽度, 空出来留着padding</li>
<li>pading to alignment<br>填上所有空.</li>
</ol>
<h2 id="关于kernel中put/get_unaligned实现">关于kernel中put/get_unaligned实现</h2>
<p>access_ok, do nothing in essence<br>byteshift, 移位每次访问u8,<br>packed_struct: 交给gcc<br>memove, byte-wise copy</p>
<h2 id="Faq">Faq</h2>
<ul>
<li><p>How does gcc attribute((aligned)) work?<br>struct S1 { short f; short f1; short f2;char a; char c;} <strong>attribute</strong> ((aligned ));<br>sizeof S1 = 16 in 64-bit</p>
</li>
<li><p>In what situation can unaligned accesss make a kernel panic?<br>may be arch/mips/kernel/unaligned.c</p>
</li>
</ul>
<h1 id="Scheduling">Scheduling</h1>
<h2 id="Process_scheduler">Process scheduler</h2>
<h2 id="Network_scheduler">Network scheduler</h2>
<h2 id="I/O_scheduling-1">I/O scheduling</h2>
<h1 id="Endianess">Endianess</h1>
<p><a href="http://www.yolinux.com/TUTORIALS/Endian-Byte-Order.html" target="_blank" rel="external">Endianness: Big and Little Endian Byte Order</a><br>应该说bit endianess 实际存储只有MSB … LSB这一种二进制表达形式! 在上面的文章的representtion, 辅证这一点.<br>这篇文章<a href="http://tonybai.com/2013/05/21/talk-about-bitfield-in-c-again/" target="_blank" rel="external">再谈C语言位域</a>,<br>之所以输出逆序, 是因为错误里理解了, bit 序. bit 序是cpu 读取的方式, 不是存储的方式!</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Bit_numbering" target="_blank" rel="external">bit endianness</a><br>这样就可以更好的理解iphdr:<br>#if defined(<strong>LITTLE_ENDIAN_BITFIELD)
  </strong>u8    ihl:4,<pre><code>  <span class="tag">version</span><span class="pseudo">:4</span>;
</code></pre>#elif defined (<strong>BIG_ENDIAN_BITFIELD)
  </strong>u8    version:4,<pre><code>  ih<span class="variable">l:4</span>;
</code></pre>#else<br>#error  “Please fix <asm byteorder.h="">“<br>#endif<br>ipv4 header的拓扑<br>version ihl<br>0100 0101<br>因为le的cpu是 lsb first, 也就是从最左面的1开始读, 所以第一个是ihl<br>而be的cpu是 msb first, 从最右开始所以version开头.</asm></li>
</ul>
<p>而使用unsigned char ver_ihl<br>(ver_ihl &amp; 0xf0)&gt;&gt; 4 = version<br>ver_ihl &amp; 0x0f = ihl<br>是无关cpu读取顺序的.</p>
<h3 id="Endianess_in_build">Endianess in build</h3>
<p>cpu -&gt; toolchain<br>ar71xx big<br>ralink little</p>
<h1 id="File_formate">File formate</h1>
<h2 id="ELF_—_ELF_executable_and_linkable_format-">ELF — ELF executable and linkable format.</h2>
<p>Used for Relocatable file(object file, kernel moudle), Executable file, Dynamic library, Core dump. </p>
<h3 id="Relocatable_file(object_file,_kernel_module)">Relocatable file(object file, kernel module)</h3>
<p>ELF header.<br>Sections.<br>Section header table.</p>
<h3 id="Executeable_file,_dynamic_library">Executeable file, dynamic library</h3>
<p>ELF header.<br>Program header table.<br>Segments.<br>Section header table.</p>
<h1 id="Net">Net</h1>
<p>More details in net notes </p>
<h1 id="Testing">Testing</h1>
<h2 id="Black-box_testing">Black-box testing</h2>
<p>test software function.</p>
<h2 id="White-box_testing">White-box testing</h2>
<p>test software internal logic.</p>
<h1 id="Hardware-1">Hardware</h1>
<p>常用寄存器，常见指令<br>实模式和保护模式<br>分段和分页机制<br>TSS和任务管理<br>中断机制<br>时钟机制<br>高速缓存</p>
<h2 id="Reference">Reference</h2>
<p>See MIPS run<br>Intel 64 and IA-32 architectures software developers manual combined volumes 3A, 3B, and 3C: System programming guide    </p>
<h1 id="x86_Interrupt">x86 Interrupt</h1>
<p>If interrupt occured in user mode, then cpu will context swith for potential reschedule.<br>The Interrupt Descriptor Table (IDT) is a data structure used by the x86 architecture to implement an interrupt vector table. </p>
<h2 id="Hardware_interrupts">Hardware interrupts</h2>
<p>are used by devices to communicate that they require attention from the operating system.<br>asynchronus<br>more details in init_IRQ() or set_irq() in driver.</p>
<h2 id="software_interrupt">software interrupt</h2>
<p>synchronus<br>more details in trap_init().</p>
<ul>
<li>exception or trap<br>is caused either by an exceptional condition in the processor itself,<br>divide zero painc?</li>
<li>special instruction, for example INT 0x80<br>or a special instruction in the instruction set which causes an interrupt when it is executed.</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/cs/">cs</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/cs/">cs</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/02/27/cs/cs/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/02/27/cs/language/" title="The programming language" itemprop="url">The programming language</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/116338260303228780000?rel=author" title="Firo Yang" target="_blank" itemprop="author">Firo Yang</a>
		
  <p class="article-time">
    <time datetime="2015-02-27T07:46:14.000Z" itemprop="datePublished"> Published Feb 27 2015</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Formal_language">Formal language</h1>
<h1 id="c">c</h1>
<p>我们还是从使用的角度来看c 语言;<br>c语言自身重要基础性质, 我们需要了解.<br>除此之外, 我们还要了解一些重要的标准库函数.<br>知道这些, 我们就能用c语言.</p>
<h2 id="Reference">Reference</h2>
<p>C11<br>C Traps and Pitfalls<br>Expert C Programming<br><a href="http://www.tenouk.com/ModuleW.html" target="_blank" rel="external">compiler, assembler, linker and loader: a brief story</a></p>
<h2 id="Type">Type</h2>
<ul>
<li>Object type and function type</li>
<li>Object — void, scalar,aggregate types, composite</li>
<li>Scalar type — Arithmetic types and pointer types<br><a href="http://www.techopedia.com/definition/16441/scalar" target="_blank" rel="external">What does Scalar mean?</a><br>scalar 词源上由scale演化而来, scalar type来自scalar processor and vector processor.<br>超标量也是来自这里concurrent SISD =&gt;MIMD 所谓的流水线.</li>
<li>Arithmetic type — Integer and floating types<h2 id="Incomplete_and_complete">Incomplete and complete</h2>
void; struct s; union u;<h2 id="Conversion">Conversion</h2>
</li>
<li>only effect to scalar type data<br>error: conversion to non-scalar type requested</li>
<li>无符号数 转换成upper rank的有符号数, 还是无符号数, 不管最初是-1!<br>unsigned int i = 1; long f = -10;if ( i &gt; f ) printf(“ok\n”); true 证明确实usigned 向long转换了.<br>unsigned int i = -3; long f = -5u;if ( i &gt; f ) printf(“ok\n”); true<br>c11上是ok的!</li>
<li>做signed 和unsigned 貌似both convert to unsigned gcc才给警告, 否则不给即便是signed和unsigned比较. <h2 id="lvalue_rvalue_modfiable_rvalue">lvalue rvalue modfiable rvalue</h2>
<a href="http://eli.thegreenplace.net/2011/12/15/understanding-lvalues-and-rvalues-in-c-and-c" target="_blank" rel="external">Understanding lvalues and rvalues in C and C++</a></li>
</ul>
<h2 id="Array_decay">Array decay</h2>
<p>数组退化的初衷, 可能是K&amp;R当年计算资源紧缺, 导致不允许函数传值copy数组内容.<br>总之标准委员会介入之前就决定.<br><a href="http://bbs.chinaunix.net/thread-1031622-1-1.html" target="_blank" rel="external">[C] [原创]数组与指针—-都是”退化”惹的祸</a><br>关于char *s错误声明的讲解不错!<br><a href="http://stackoverflow.com/questions/17752978/exception-to-array-not-decaying-into-a-pointer" target="_blank" rel="external">Exception to array not decaying into a pointer?</a><br>在c11 6.3.2.1 Lvalues, arrays, and function designators第3点说明了<br>array不会退化的4种场景. Except when it is </p>
<ul>
<li>the operand of the sizeof operator, </li>
<li>the _Alignof operator, or the</li>
<li>unary &amp; operator, or </li>
<li><p>is a string literal used to initialize an array, an expression that has type<br>‘‘array of type’’ is converted to an expression with type ‘‘pointer to type’’<br>that points to the initial element of the array object and is not an lvalue.<br>If the array object has register storage class, the behavior is undefined.<br>这4种场景之外, 那么array名退化的结果是pointer.<br>这个pointer和我们最常用的pointer如int <em>p有什么区别呢?<br>首先array decay是type上的转化array -&gt; pointer.<br>其次数组名原来是lvalue -&gt; not an lvalue更谈不上modifiable.<br>type: tyepof(array[0]) </em><br>value: &amp;array[0] or array<br>property: not lvalue<br>当然这只是c11上的说明, 我们只要明白为什么不能修改一个decay数组名就行了.<br>实现的个人猜测是: 根据lvalue的定义decay后数组名还是lvalue, 只不过一直都不是modifiable.</p>
</li>
<li><p>为什么作为函数形参的数组名可以++, 而作为变量的数组名就不可以.<br>因为形参数组名被当初pointer处理modifiable lvalue, 而实参数组名只是传值而已.<br>而普通数组名是一个lvalue,不能修改.</p>
<h3 id="Why_innermost_dimension_can_be_omit_in_array">Why innermost dimension can be omit in array</h3>
<p>用不到.<br>In essence, all arrays in C are one-dimensional.</p>
</li>
</ul>
<p>Because the array will decay to pointer and to calculate offset to<br>the elements of the array you do not need to know the innermost dimension. </p>
<p>Compiler has to know by how much to increment the pointer when<br>indexing on the first dimension for example. So if an int array is named a,</p>
<h2 id="Integer_Promotion">Integer Promotion</h2>
<p><a href="http://www.idryman.org/blog/2012/11/21/integer-promotion/" target="_blank" rel="external">Deep C: Integer Promotion</a></p>
<ul>
<li><a href="https://msdn.microsoft.com/en-us/library/fc9te331.aspx" target="_blank" rel="external">Integral Promotions</a><br>0xF int<br>0xFFFFFFFF unsigned int<h2 id="Scopes_of_identifiers">Scopes of identifiers</h2>
For each different entity that an identifier designates, the identifier is visible (i.e., can be<br>used) only within a region of program text called its scope.</li>
<li>four kinds of scopes: function, file, block, and function prototype<br>If the declarator or type specifier that declares the identifier<br>appears outside of any block or list of parameters, the identifier has file scope, which<br>terminates at the end of the translation unit.</li>
</ul>
<p>If the declarator or type specifier that<br>declares the identifier appears inside a block or within the list of parameter declarations in<br>a function definition, the identifier has block scope, which terminates at the end of the<br>associated block.</p>
<p>If the declarator or type specifier that declares the identifier appears<br>within the list of parameter declarations in a function prototype (not part of a function<br>definition), the identifier has function prototype scope, which terminates at the end of the<br>function declarator.</p>
<p>If an identifier designates two different entities in the same name<br>space, the scopes might overlap.</p>
<h2 id="linkages_of_identifiers">linkages of identifiers</h2>
<p>An identifier declared in different scopes or in the same scope more than once can be<br>made to refer to the same object or function by a process called linkage.</p>
<ul>
<li>There are three kinds of linkage: external, internal, and none.</li>
<li>There is no linkage between different identifiers.</li>
<li>external linkage<br>In the set of translation units and libraries that constitutes an entire program, each<br>declaration of a particular identifier with external linkage denotes the same object or<br>function. —c11</li>
</ul>
<p>If the name has external linkage,<br>the entity that name denotes may be referred to from another translation unit<br>using a distinct declaration for that same name,<br>and from other scopes within the same translation unit using distinct declarations. —wikipedia</p>
<ul>
<li>Internal linkage<br>Within one translation unit, each declaration of an identifier with internal<br>linkage denotes the same object or function. —c11</li>
</ul>
<p>Were the name given internal linkage,<br>such a declaration would denote a distinct entity, although using the same name,<br>but its entity could be referred to by distinct declarations within the same translation unit.  —wikipedia</p>
<ul>
<li>No linkage<br>Each declaration of an identifier with no linkage denotes a unique entity. —c11<br>A name that has no linkage at all cannot be referred to from declarations in different scopes,<br>not even from within the same translation unit. —wikipedia<h2 id="Name_spaces_of_identifiers">Name spaces of identifiers</h2>
<h2 id="Storage_durations_of_objects">Storage durations of objects</h2>
An object has a storage duration that determines its lifetime.<br>There are four storage durations: static, thread, automatic, and allocated.<br>The lifetime of an object is the portion of program execution during which storage is<br>guaranteed to be reserved for it.<br>In book 21st Century C, it was named memory mode.</li>
<li>static storage duration<br>An object whose identifier is declared without the storage-class specifier _Thread_local,<br>and either with external or internal linkage or with the storage-class specifier static(for no linkage —firo),<br>has static storage duration.</li>
</ul>
<p>Its lifetime is the entire execution of the program and its stored value is initialized only once,<br>prior to program startup.</p>
<ul>
<li>automatic storage duration<br>An object whose identifier is declared with no linkage and without the storage-class<br>specifier static has automatic storage duration, as do some compound literals.</li>
<li>alloced storage duration<br>The lifetime of an allocated object extends from the allocation until the deallocation.</li>
<li>Thread storage duration<br>details in c11<h2 id="Alignment_of_objects">Alignment of objects</h2>
An alignment is an implementation-defined integer value representing the number of bytes between<br>successive addresses at which a given object can be allocated.<br>More deatils in cs.md<h2 id="Declarations">Declarations</h2>
A declaration specifies the interpretation and attributes of a set of identifiers.</li>
</ul>
<p>A definition of an identifier is a declaration for that identifier that:<br>for an object, causes storage to be reserved for that object;<br>for a function, includes the function body;<br>for an enumeration constant, is the (only) declaration of the identifier;<br>for a typedef name, is the first (or only) declaration of the identifier.</p>
<p>The declaration specifiers consist of a sequence of specifiers that indicate the linkage,<br>storage duration, and part of the type of the entities that the declarators denote.</p>
<h2 id="Marco">Marco</h2>
<p><a href="http://blog.csdn.net/huyansoft/article/details/2484297" target="_blank" rel="external">如果#操作符出现在对象宏的替换列表中,则仅作为一个普通字符,不具有下述含义</a></p>
<h2 id="Expressions">Expressions</h2>
<ul>
<li>cast<br>A cast does not yield an lvalue.</li>
</ul>
<h2 id="Lexical_element">Lexical element</h2>
<h3 id="Character_constants">Character constants</h3>
<p>An integer character constant has type int.</p>
<h2 id="lexical_pitfall">lexical pitfall</h2>
<h2 id="Greedy_lexical_analysis">Greedy lexical analysis</h2>
<ul>
<li>Write tokens with blank!<br>x = y/<em>p;  /</em> oops, hidden error.*/</li>
<li>Associative<br>You donot need to remember it! Just use it!</li>
<li>Precedence<br>Need to remember, but if you not sure, parenthess.<h2 id="inline_和宏的区别">inline 和宏的区别</h2>
inline的好处与坏处<br>没有调用的开销效率很高, 但是调试代码复杂了, 内链函数的实现是拷贝副本消耗内存.<br>inline有类型检测, 宏没有.<h2 id="C_standard_library">C standard library</h2>
<h2 id="FAQ">FAQ</h2>
</li>
<li>Logical operation with signed value? x86!<br>int c = 0xFFFFFFFF;  int d = c &gt;&gt; 31; =&gt; d == f;<br>unsigned c = 0xFFFFFFFF;  int d = c &gt;&gt; 31; d!= f;</li>
<li>shift beyond bits long?<br>c &gt;&gt; 296 == c &gt;&gt; 8</li>
<li>变量同名不同类型不同文件, 通过extern, 否则就是multiple definition<br>这是c语言最为迷糊的地方.简单说来类似union, 具体我也不清楚.</li>
</ul>
<ol>
<li>所有名字引用同一个object</li>
<li>不同文件中不同类型的sizeof和当前文件类型一直.</li>
</ol>
<h1 id="C_standard_library-1">C standard library</h1>
<p>NULL?</p>
<h2 id="String_handling">String handling</h2>
<p>kernel/lib/string.c</p>
<ul>
<li><p>Copying functions<br>memcpy: dest<br>memmove: dest<br>strcpy: dest, 拷贝\0<br>strncpy: dest, if src_len &gt;= n; 0 NULL, if src _len &lt; n; (n - len) NULL;<br>strlcpy: src_len, mini(n -1, src_len -1) + \0, src_len 用你返回啊!</p>
</li>
<li><p>Concatenation functions<br>strcat: dest, overwrite dest \0 with src util src \0<br>strncat: dest, 末尾一定有\0</p>
</li>
<li><p>Comparison functions<br>memcmp: 差值,<br>strcmp: -1, 0, 1, 如果整个s1都比完了NULL or —n ==0 for strncmp, return 0</p>
</li>
<li><p>Search functions<br>memchr, NULL or p;<br>strchr,ditto, 到\0返回NUll<br>strrchr,ditto, last occurence.<br>strspn: s1开始有多少在s2中.<br>strcspn: s1开始有多少不在s2中.<br>strpbrk: s2中第一次出现的位置<br>strstr: 找子串, 用memcmp</p>
</li>
</ul>
<h1 id="ASM_in_c_code">ASM in c code</h1>
<p>c语言嵌入汇编这不是c语言的特性是编译器的feature.<br><a href="https://gcc.gnu.org/onlinedocs/gcc/Using-Assembly-Language-with-C.html#Using-Assembly-Language-with-C" target="_blank" rel="external">How to Use Inline Assembly Language in C Code</a></p>
<h1 id="MIPS">MIPS</h1>
<p>bdi 4, 8 delay solt<br>mips instruction size is fixed, 32bit, 4byte.<br>instruction address:  instrction in hex formate       instruction in string formate, 260<br>8002c28c:   8c440104    lw  a0,260(v0)</p>
<h2 id="ASM_codes_Fixme">ASM codes Fixme</h2>
<p>move &lt;-<br>j long jump<br>b short jump<br>a0, a1…99% is parameters.</p>
<h2 id="lwr_&amp;_lwl">lwr &amp; lwl</h2>
<p>load a word<br>different with endianess<br>register 63…..32……0<br>big endian: lwl high bits in b + 0<br>little endian: lwl high in b + off<br>向中心</p>
<h1 id="x86">x86</h1>
<p><a href="http://heather.cs.ucdavis.edu/~matloff/50/PLN/lock.pdf" target="_blank" rel="external">Intel’s ‘cmpxchg’ instruction</a><br>eax: e stand for 32<br>rax: r stand for 64<br><a href="http://x86.renejeschke.de/html/file_module_x86_id_159.html" target="_blank" rel="external">lock prefix in x86</a><br>the lock prefix make instruction atomic!</p>
<h2 id="registers’_purpose">registers’ purpose</h2>
<h2 id="Register">Register</h2>
<ul>
<li>gs<br>The linux kernel uses GS to access cpu-specific memory.</li>
<li>gdtr<br>GDT</li>
<li>tr<br>TSS addressing</li>
</ul>
<h1 id="Wildcards">Wildcards</h1>
<p><a href="http://whatis.techtarget.com/definition/wildcard-character" target="_blank" rel="external">A wildcard character is a type of meta character</a></p>
<h2 id="Type-1">Type</h2>
<h3 id="Standard_Wildcards_(globbing_patterns)">Standard Wildcards (globbing patterns)</h3>
<p>File and directory patterns<br>?: must stand for a character</p>
<ul>
<li>Regular expression</li>
<li>SQL</li>
</ul>
<h1 id="Shell">Shell</h1>
<h2 id="test">test</h2>
<h3 id="-n_is_not_equivalent_to_!_-z">-n is not equivalent to ! -z</h3>
<p>Be caution! just juse -z and !-z</p>
<h2 id="ls">ls</h2>
<p>-l: show hardlinks of file/dir in 2nd column<br>drwsrwsr-T: T stand for sticky bit no other execution bit</p>
<h2 id="eval">eval</h2>
<ul>
<li>create variable name<br>  <strong>var=”name”<br>  eval “export — \”$</strong>var=firo\””<br>  set | grep firo<br>  __var=’name’<br>  bbb=’firo’<h2 id="expr">expr</h2>
expr “$name” : ‘(.*).conf’<h2 id="find">find</h2>
</li>
<li>find symbols in object<br>  find . -name ‘a.out’ -exec nm -D {} \; -print<br>  find . -name ‘*.o’ -print0 | xargs -0 nm -A | egrep ‘ (i|y)$’</li>
<li>rm<br>find . -name ‘your_pattern<em>’ -exec rm -f {} \;<br>find . -name ‘your_pattern</em>’ -delete<h2 id="grep">grep</h2>
-c: count of match<h2 id="pipe">pipe</h2>
find . -type d | while read d; do cnt=$(ls $d | grep tgz | wc -l); echo “$cnt $d”; done | sort -n &gt;stat </li>
</ul>
<h1 id="Regualar_expression">Regualar expression</h1>
<h2 id="Basic">Basic</h2>
<h2 id="Extend">Extend</h2>
<h2 id="Vim_regex">Vim regex</h2>
<p><a href="http://vimregex.com/" target="_blank" rel="external">http://vimregex.com/</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/cs/">cs</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/cs/">cs</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/02/27/cs/language/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/02/27/cs/mathematics/" title="Mathematics" itemprop="url">Mathematics</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/116338260303228780000?rel=author" title="Firo Yang" target="_blank" itemprop="author">Firo Yang</a>
		
  <p class="article-time">
    <time datetime="2015-02-27T07:46:14.000Z" itemprop="datePublished"> Published Feb 27 2015</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Complement">Complement</h1>
<p>radix complement<br>diminished radix complement</p>
<h1 id="Codata">Codata</h1>
<h1 id="Collection">Collection</h1>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/cs/">cs</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/cs/">cs</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/02/27/cs/mathematics/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/02/27/cs/programming/" title="Programming" itemprop="url">Programming</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/116338260303228780000?rel=author" title="Firo Yang" target="_blank" itemprop="author">Firo Yang</a>
		
  <p class="article-time">
    <time datetime="2015-02-27T07:46:14.000Z" itemprop="datePublished"> Published Feb 27 2015</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>programming principles<br>High cohesion low coupling</p>
<h1 id="Programming_style">Programming style</h1>
<h1 id="coding_for_testing">coding for testing</h1>
<h1 id="Programming_principles"><a href="http://en.wikipedia.org/wiki/Category:Programming_principles" target="_blank" rel="external">Programming principles</a></h1>
<h2 id="defensive_programming">defensive programming</h2>
<p>Low tolerance against “potential” bugs<br>Assertion, panic in user space</p>
<h1 id="Skills">Skills</h1>
<p>How to use assertion</p>
<h1 id="clean_code">clean code</h1>
<p><em>all codes related to loop must in one block<br>__find_meaningful_task_parent_by_task()<br>old version: </em>p <em>pp<br>clean version: </em>tmp, *p</p>
<h1 id="Coding_standards">Coding standards</h1>
<ul>
<li>GNU coding standards</li>
<li>Linux kernel coding style<br>= Shell coding standard</li>
</ul>
<h1 id="Review">Review</h1>
<h1 id="Best_coding_practices">Best coding practices</h1>
<p>=Commenting</p>
<ul>
<li>Copyleft/right,</li>
<li>Author and maintainer</li>
<li>Update log</li>
<li>Name of the module</li>
<li>Usage</li>
</ul>
<h1 id="Coding_error">Coding error</h1>
<p>= Leak of semicolon, parentheses</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/cs/">cs</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/cs/">cs</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/02/27/cs/programming/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/02/27/cs/debugging/" title="General debugging method" itemprop="url">General debugging method</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/116338260303228780000?rel=author" title="Firo Yang" target="_blank" itemprop="author">Firo Yang</a>
		
  <p class="article-time">
    <time datetime="2015-02-27T07:46:14.000Z" itemprop="datePublished"> Published Feb 27 2015</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Reference">Reference</h1>
<p>DWARF</p>
<h1 id="BUG_type_of_JimGray"><a href="http://www.opensourceforu.com/2010/10/joy-of-programming-types-of-bugs/" target="_blank" rel="external">BUG type of JimGray</a></h1>
<h2 id="Bohrbug,_can_be_reproduce-">Bohrbug, can be reproduce.</h2>
<h2 id="Heisenbug_不论你用多少的时间和精力来试图让bug重现，bug就是人间蒸发了">Heisenbug 不论你用多少的时间和精力来试图让bug重现，bug就是人间蒸发了</h2>
<h2 id="Mandelbug_当bug产生的原因过于复杂而难以理解时，bug的出现也变得没有规律">Mandelbug 当bug产生的原因过于复杂而难以理解时，bug的出现也变得没有规律</h2>
<h2 id="Schroedinbug">Schroedinbug</h2>
<h1 id="Common_types_of_computer_bugs"><a href="https://en.wikipedia.org/wiki/Software_bug#Common_types_of_computer_bugs" target="_blank" rel="external">Common types of computer bugs</a></h1>
<h2 id="Arithmetic_bugs">Arithmetic bugs</h2>
<h2 id="syntax_error">syntax error</h2>
<h2 id="Logic_error">Logic error</h2>
<p>Incorrect Bounds-Checking<br>off-by-one bug<br>Skipping Null-Termination Issues</p>
<h2 id="Resource_bugs">Resource bugs</h2>
<p>uninitialized/nonvalidated/corrupted pointer dereference.<br>Segmentation fault in userspace<br>Kernel oops,<a href="http://neependra.net/kernel/Debugging_Kernel_OOPs_FUDCon2011.pdf" target="_blank" rel="external">When the kernel de-references an invalid pointer, it’s not called a segfault – it’s called an ”oops”.</a><br>Buffer overflow/踩内存</p>
<ul>
<li><a href="http://lwn.net/Articles/174494/" target="_blank" rel="external">Double kfree errors</a><br>The devm_* series functions introduce more double free error in driver code.</li>
</ul>
<h2 id="Race_condition_bug">Race condition bug</h2>
<p>Multi-threading programming bugs(parallel problems)</p>
<ul>
<li>deadlock<h2 id="Interfacing_bugs">Interfacing bugs</h2>
<h2 id="Performance_bugs">Performance bugs</h2>
<h2 id="Teamworking_bugs">Teamworking bugs</h2>
<h2 id="Vulnerable_bugs">Vulnerable bugs</h2>
*unbounded memory manipulation functions<br>strcpy</li>
<li>Non-Null Termination Issues<br>non terminaed string<br>*Formate string<br><a href="https://www.owasp.org/index.php/Format_string_attack" target="_blank" rel="external">Format Strings attacker</a> or <a href="https://en.wikipedia.org/wiki/Uncontrolled_format_string" target="_blank" rel="external">Uncontrolled format string</a></li>
<li>integer issues<br>integer overflow<br>Signed Comparison Vulnerabilities</li>
</ul>
<h2 id="Special_BUG">Special BUG</h2>
<p><a href="http://www.av8n.com/computer/htm/kernel-lockup.htm" target="_blank" rel="external">kenrel lockup</a></p>
<h1 id="Taxonomy_of_Kernel_BUG">Taxonomy of Kernel BUG</h1>
<ul>
<li><a href="http://fedoraproject.org/wiki/KernelBugClassification" target="_blank" rel="external">oops, WARN_ON, or kernel panic</a></li>
<li><a href="http://fedoraproject.org/wiki/KernelBugTriage#Kernel_Bug_Classification" target="_blank" rel="external">Source of BUG</a>, driver or subsystem and so on.</li>
</ul>
<h1 id="BUG_made_by_me">BUG made by me</h1>
<ul>
<li>print_signal_info wrong pritk parameters position<pre><code>  printk(KERN_NOTICE <span class="string">"K <span class="variable">%d</span> : <span class="variable">%d</span> -&gt; <span class="variable">%s</span> <span class="variable">%d</span> <span class="variable">%s</span> <span class="variable">%d</span>\n"</span>, sig, <span class="keyword">q</span>-&gt;info.si_code,
          ss[<span class="number">2</span>], ss[<span class="number">3</span>], task_tgid_vnr(r_t), task_tgid_vnr(r_p));
</code></pre>Watch compile warning info can be avoid of this bug.</li>
<li>spin_lock(sighand) invoke down_sem and cond_resched…<br>  __send_signal()</li>
</ul>
<h1 id="Anti_debugging">Anti debugging</h1>
<h2 id="Syntax_checking">Syntax checking</h2>
<p>gcc -Wall<br>bash -n</p>
<h2 id="static_code_analysis">static code analysis</h2>
<p>smatch</p>
<h1 id="Typical_debugging_process_—_step_1,_2,_3_maybe_loop-">Typical debugging process — step 1, 2, 3 maybe loop.</h1>
<ol>
<li>合理性假设可能性, 最高的一系列原因!</li>
<li>Generating program states, 对于内核很多时候, 我们只能有一次机会产生调试的信息, 就是panic or oops那时, 不绝对.</li>
<li>examine program states </li>
<li>track down the origin of the problem(s)</li>
<li>fix it</li>
</ol>
<h1 id="合理推判">合理推判</h1>
<h2 id="我们的程序_or_系统,_库有问题-">我们的程序 or 系统, 库有问题.</h2>
<h2 id="证明,_注重因果性,_而不是相关性Correlation">证明, 注重因果性, 而不是相关性Correlation</h2>
<p>充分: 因-&gt;果, 基本backtrace可以断定<br>必要: 果-&gt;因, 这个bug只是这个因造成的.</p>
<h1 id="Generating_program/system_states">Generating program/system states</h1>
<h2 id="Printing">Printing</h2>
<ul>
<li><p>刘东log法 #define debugme(fmt, args…) do{FILE *fdebug=fopen(“/d.log”, “a+”); fprintf(fdebug,”%s,%s,%d:”, <strong>TIME</strong>, <strong>FUNCTION</strong>, <strong>LINE</strong>);fprintf(fdebug, fmt, ##args);fclose(fdebug);} while(0)</p>
</li>
<li><p>before kernel decompress<br>putstr</p>
</li>
<li><p>early printk<br>Linux serial-port driver is interrupt driven, if irq-off console will not work!</p>
</li>
<li><p>printk</p>
</li>
</ul>
<h2 id="beyond_printing">beyond printing</h2>
<p>Use atexit() register a stackdump() function<br>dump_stack in kernel<br>ioctl/netlink<br>print signal This is just a hiwifi wonderful kernel patch #931</p>
<h2 id="Log">Log</h2>
<p>dmesg<br>syslog</p>
<h2 id="Debugging_support_in_the_kernel">Debugging support in the kernel</h2>
<p>更为宽泛意义上的printing 方法.</p>
<ul>
<li><p>kernel tracing<br><a href="http://lwn.net/Articles/291091/" target="_blank" rel="external">http://lwn.net/Articles/291091/</a><br><a href="http://lwn.net/Articles/330402/" target="_blank" rel="external">http://lwn.net/Articles/330402/</a><br><a href="http://lwn.net/Articles/379903/" target="_blank" rel="external">http://lwn.net/Articles/379903/</a><br><a href="http://lwn.net/Articles/381064/" target="_blank" rel="external">http://lwn.net/Articles/381064/</a><br><a href="http://lwn.net/Articles/383362/" target="_blank" rel="external">http://lwn.net/Articles/383362/</a><br><a href="http://lwn.net/Articles/346470/" target="_blank" rel="external">http://lwn.net/Articles/346470/</a></p>
</li>
<li><p>CONFIG_DYNAMIC_DEBUG<br>pr_debug()/dev_debug()<br><debugfs>/dynamic_debug/control</debugfs></p>
</li>
</ul>
<h2 id="SysRq">SysRq</h2>
<p>t, m</p>
<h2 id="/proc_(specially_/proc/sys/)_and_/sys">/proc (specially /proc/sys/) and /sys</h2>
<h2 id="Trace">Trace</h2>
<p>strace<br>ltrace<br>ftrace in kernel<br>kgtp</p>
<h2 id="Debuger_Gdb_kdb_kgdb">Debuger Gdb kdb kgdb</h2>
<p>gdb /usr/src/linux/vmlinux /proc/kcore<br>    bt<br>    x/100a<br>thread apply all bt full</p>
<ul>
<li><p>How to use gdb debug loaded kernel module(maybe kernel its self)<br>gdb vmlinux /proc/kcore<br>core-file /proc/kcore<br>p jiffies_64<br>text_addr=$(cat /sys/module/char-read-write/sections/.text)<br>add-symbol-file /home/nkhare/char-read-write.ko $text_addr</p>
</li>
<li><p>how to get module text address<br>firo@firo module$ cat /sys/module/wmi/sections/.text<br>0xffffffffa023b000</p>
</li>
</ul>
<p>firo@firo module$ cat /proc/modules | grep wmi<br>wmi 18820 0 - Live 0xffffffffa023b000</p>
<p>……<br>int bss_var;<br>static int hello_init(void)<br>{<br>printk(KERN_ALERT “Text location .text(Code Segment):%p\n”,hello_init);<br>static int data_var=0;<br>printk(KERN_ALERT “Data Location .data(Data Segment):%p\n”,&amp;data_var);<br>printk(KERN_ALERT “BSS Location: .bss(BSS Segment):%p\n”,&amp;bss_var);<br>……<br>}<br>Module_init(hello_init);</p>
<h3 id="GDB_skills">GDB skills</h3>
<ul>
<li>offset of member in struct<br>gdb ./vmlinux<br>print &amp;((struct kmem_cache *)0)-&gt;offset</li>
</ul>
<h2 id="Kprobes">Kprobes</h2>
<ul>
<li>kgdb<br>gdb<br>file vmlinux<br>set remotebaud 115200<br>target remote /dev/ttyS0</li>
</ul>
<h2 id="lockdep">lockdep</h2>
<h2 id="tcpdump/wireshark">tcpdump/wireshark</h2>
<h2 id="lsof">lsof</h2>
<h2 id="kernel_oops/warn/panic"><a href="https://www.kernel.org/doc/Documentation/oops-tracing.txt" target="_blank" rel="external">kernel oops</a>/warn/panic</h2>
<p>狭隘的认为oops等价于内存地址出问题了, oops 本质上是<strong>die(“Oops”
</strong>die 却可以表明很多错误 “Bad pagetable”, “Oops - badmode”<br>arm_notify_die(“Oops - undefined instruction” 等等..<br>oops 是超出programmer 之外的错误,属于不可控风险, 其实更危险比panic.<br>panic 则是programmer 感知到的是防御式编程assertion的体现.</p>
<h2 id="Coredump_and_/proc/kcore_and_kdump">Coredump and /proc/kcore and kdump</h2>
<h2 id="library_dependencies_of_a_ELF/bin">library dependencies of a ELF/bin</h2>
<p>LD_TRACE_LOADED_OBJECTS=1 git<br>ldd /usr/bin/git</p>
<h2 id="Kernel_specific">Kernel specific</h2>
<p>kernel version<br>ask reporter for the .config<br>decoding “code”</p>
<h2 id="General_case">General case</h2>
<h3 id="how_to_find_or_generate_a_backtrace">how to find or generate a backtrace</h3>
<ul>
<li>gdb bt(Strongly, recommand), break continue bt</li>
<li>backtrace() / dumpstack</li>
<li>read soucecode</li>
<li>print log </li>
<li>Timer backtrace, Just for funny, the foolish of me. </li>
</ul>
<h1 id="Examine_program_states">Examine program states</h1>
<ul>
<li>Variable values</li>
<li>Function calls</li>
<li>Packet</li>
<li>Backtrace</li>
<li>Registers</li>
<li>Stack</li>
</ul>
<h2 id="Examine_oops-txt">Examine oops.txt</h2>
<ul>
<li><p>use System.map to resolve the function name of IP<br>kallsyms replace ksymoops tools.</p>
</li>
<li><p>examinecodes in oops<br>./scripts/decodecode &lt; Oops.txt</p>
</li>
</ul>
<p>echo “Code: 23 25 dc 47 6f 00 41 f6 c4 10 75 66 9c 5d fa 65 48 8b 14 25 a8 d1 00 00 48 8b 03 48 8d 04 02 4c 8b 28 4d 85 ed 74 55 48 63 53 18 <49> 8b 54 15 00 48 89 10 55 9d 4d 85 ed 74 06 66 45 85 e4 78 22” | ./kernel/scripts/decodecode </49></p>
<h2 id="demangle_c++_symbols">demangle c++ symbols</h2>
<p>c++filt command<br>addr2line -f -C -a xxx -e ooo<br>/home/build/x/ab/mips-openwrt-linux-addr2line -C -f -e /data/logs/hwf-health-chk/debug-root/HC6361/0.9005.5384s/debugfs/tmp/data/usr/bin/aria2c  0x00607188<br>aria2::ZeroBtMessage::~ZeroBtMessage()</p>
<h1 id="Tracking_down_the_origin_of_the_problems">Tracking down the origin of the problems</h1>
<h2 id="Different_Origins">Different Origins</h2>
<h3 id="Assemblly_level">Assemblly level</h3>
<ul>
<li><p>Generat vmlinux Assemblly codes<br>objdump -S vmlinux<br>objdump -S char-read-write.ko</p>
</li>
<li><p>Generat single sources file assemblly  codes<br>为了使汇编代码和C代码更好的对应起来， Linux内核的Kbuild子系统提供了这样一个功能： 任何一个C文件都可以单独编译成汇编文件，例如：<br>make kernel/sched.s V=1</p>
</li>
</ul>
<h2 id="Track_down">Track down</h2>
<h3 id="“Wolf_fence”_algorithm">“Wolf fence” algorithm</h3>
<p>二分调试大法</p>
<h2 id="From_oops_to_ASM">From oops to ASM</h2>
<ul>
<li>Fast way maybe???</li>
</ul>
<ol>
<li>make kernel/xx.s</li>
<li>grep “code in oops.txt” kernel/xx.s</li>
</ol>
<h3 id="From_ASM_to_c_language">From ASM to c language</h3>
<p><a href="http://yarchive.net/comp/linux/oops_decoding.html" target="_blank" rel="external">lkml-Linus-Al-Viro-oops-debug</a></p>
<ul>
<li>expand inline function</li>
<li>locate <strong>asm</strong>() 内嵌汇编, 能快速定位代码! 但很少! slhc_uncompress()</li>
<li>找常量!</li>
<li>找loop codes formate!</li>
<li>通过.config or CONFIG_判断具体是那个相同函数.</li>
<li>字符的数字敏感<br>0000000034333545 doesnt have a bit 7 set in any byte.</li>
</ul>
<p>+ef8:   00a01021    move    v0,a1<br> efc:   88440003    lwl a0,3(v0)<br> f00:   24450004    addiu   a1,v0,4<br> f04:   98440000    lwr a0,0(v0)<br> f08:   00641821    addu    v1,v1,a0<br> f0c:   0064202b    sltu    a0,v1,a0<br>+f10:   14a7fff9    bne a1,a3,ef8 <slhc_uncompress+0x444><br> f14:   00831821    addu    v1,a0,v1</slhc_uncompress+0x444></p>
<h3 id="From_ASM_to_c_language_x86">From ASM to c language x86</h3>
<ul>
<li><p>local_irq_save/disable<br> c: 9c                    pushfq        //not sure<br> d: 5d                    pop    %rbp //not sure<br> e: fa                    cli</p>
</li>
<li><p>per-CPU<br>f: 65 48 8b 14 25 a8 d1  mov    %gs:0xd1a8,%rdx</p>
</li>
</ul>
<h3 id="Track_skills">Track skills</h3>
<h4 id="Tips_on_debugging_optimized_code"><a href="http://www.stlinux.com/devel/debug/jtag/build?q=node/82" target="_blank" rel="external">Tips on debugging optimized code</a></h4>
<ul>
<li>code reordering</li>
<li>inlining</li>
<li>Optimized-away variables</li>
<li>Tailcall optimization</li>
</ul>
<h3 id="General_track_down_case">General track down case</h3>
<ul>
<li><p>If an page oops close to zero, for example 0xfffffff4<br>It maybe ERR_PTR(-12);</p>
</li>
<li><p>smartqos custom qdisc - self inferrence<br>要自己推测除几种可能, 之后按着思路去找, 不能汪洋大海, 乱砍.</p>
</li>
<li><p>追BUG实际上就是, 找关联度最高的, 最好不要从头开始推理, 太耗时.</p>
</li>
</ul>
<h3 id="A_case_of_oops">A case of oops</h3>
<p>Register IP: -&gt; System.map /proc/kallsyms -&gt; objdump -S char-read-write.ko</p>
<h1 id="FIXME/FIXIT">FIXME/FIXIT</h1>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/cs/">cs</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/cs/">cs</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/02/27/cs/debugging/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/02/27/net/net/" title="Linux Network Stack" itemprop="url">Linux Network Stack</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/116338260303228780000?rel=author" title="Firo Yang" target="_blank" itemprop="author">Firo Yang</a>
		
  <p class="article-time">
    <time datetime="2015-02-27T07:46:13.000Z" itemprop="datePublished"> Published Feb 27 2015</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Reference">Reference</h1>
<p><a href="http://www.cubrid.org/blog/dev-platform/understanding-tcp-ip-network-stack/#.VB6Vx9c6mKc.twitter" target="_blank" rel="external">Understanding TCP/IP Network Stack &amp; Writing Network Apps</a><br><a href="http://www.protocols.com/pbook/tcpip1.htm" target="_blank" rel="external">TCP/IP Reference Page</a></p>
<h1 id="INET">INET</h1>
<p>An implementation of the TCP/IP protocol suite for the LINUX operating system.<br>INET is implemented using the  BSD Socket interface as the means of communication with the user level. </p>
<h1 id="PF_*">PF_*</h1>
<ul>
<li>Capture frames<br>PF_PACKET<br>AF_PACKET sockets hand frames directly to dev_queue_xmit</li>
</ul>
<h1 id="Encapuslation">Encapuslation</h1>
<h1 id="offload">offload</h1>
<ul>
<li>TSO in tcp_v4_connect<br><a href="https://tejparkash.wordpress.com/2010/03/06/tso-explained/" target="_blank" rel="external">TSO Explained</a><br>One Liner says: It is a method to reduce cpu workload of packet cutting in 1500byte and asking hardware to perform the same functionality.</li>
<li>GSO<br><a href="http://thread.gmane.org/gmane.linux.network/37287" target="_blank" rel="external">GSO: Generic Segmentation Offload</a><br>TSO = GSO_TCPV4<br>frags = sg I/O<br>frag_list<br>*GRO<br>napi -&gt; dev -&gt;inet-&gt;skb</li>
</ul>
<h1 id="package_name_in_different_layer">package name in different layer</h1>
<p>An individual package of transmitted data is commonly called a frame on the link layer, L2;<br>a packet on the network layer; a segment on the transport layer; and a message on the application layer.</p>
<h1 id="apple_talk_in_linux_network_stack">apple talk in linux network stack</h1>
<p>talk_dgram_ops<br>&amp;atalk_family_ops</p>
<h1 id="What_is_LAN">What is LAN</h1>
<h1 id="WAN">WAN</h1>
<p><a href="https://en.wikipedia.org/wiki/Wide_area_network" target="_blank" rel="external">WAN</a></p>
<h1 id="relations_of_concept">relations of concept</h1>
<p>Qdisc — NET_XMIT_SUCCESS<br>dev — NETDEV_TX_OK</p>
<h1 id="sk_buff">sk_buff</h1>
<p><a href="http://www.skbuff.net/skbuff.html" target="_blank" rel="external">sk_buff{} documents and resources</a><br><a href="http://www.skbuff.net/skbuff.html" target="_blank" rel="external">How SKBs work by David S. Miller</a></p>
<ul>
<li>fclone — fast clone<br><a href="http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=d179cd12928443f3ec29cfbc3567439644bd0afc" target="_blank" rel="external">NET Implement SKB fast cloning.</a><br><a href="http://lwn.net/Articles/140552/" target="_blank" rel="external">Fast SKB cloning, continued</a><br>use in skb_clone function<br>use case 1: tcpdump and network stack<br>fclones-&gt;fclone_ref 这就是引用, 用处见skb_clone<br>skbuff_head_cache alloc的skb对应n-&gt;fclone = SKB_FCLONE_UNAVAILABLE;</li>
<li>pskb_pull — p abbrivated from oprivate</li>
<li>truesize — len of sk_buff + head_len + frags + frag_list</li>
<li>data_len — len of frags + frag_list</li>
<li>len — head_len + frgas + frag_list</li>
</ul>
<h1 id="skb_reference_usage">skb reference usage</h1>
<ul>
<li>计数引用 count ref skb-&gt;users — skb_get<br>  没有私有的</li>
<li>克隆引用 clone ref skb-&gt;dataref —skb_clone, skb_cloned<br>  sk_buff是私有的</li>
<li>页碎片共享 —pskb_copy<br>  sk_buff, head_len 是私用的</li>
<li>不共享 —skb_copy skb_copy_expand</li>
</ul>
<h1 id="sock-&gt;pfmemealloc">sock-&gt;pfmemealloc</h1>
<p>Yes, I only wanted to drop the packet if we were under pressure<br>when skb was allocated. If we hit pressure between when skb was<br>allocated and when __netdev_alloc_page is called,<br>+in sk_filter<br><a href="https://groups.google.com/forum/#!msg/linux_net/-YtWB66adxY/Qqm_y4U09IAJ" target="_blank" rel="external">netvm: Allow skb allocation to use PFMEMALLOC reserves</a><br><a href="http://thread.gmane.org/gmane.linux.kernel/1152658" target="_blank" rel="external">netvm: Allow skb allocation to use PFMEMALLOC reserves - gmane 08/14</a></p>
<ul>
<li><p>sk_set_memalloc<br>SOCK_MEMALLOC, sock has feature mem alloc for free memory.<br>只有到了sock层才能分辨, sock是否是memalloc的.<br>sk_filter</p>
</li>
<li><p>control buffer skb-cb<br>tcp_skb_cb</p>
</li>
</ul>
<h1 id="socket">socket</h1>
<ul>
<li><p>What is socket?<br>A socket is one endpoint of a two-way communication link between two programs running on the network.<br>An Internet socket is characterized by at least the following :<br>Local socket address: Local IP address and port number<br>Protocol: A transport protocol (e.g., TCP, UDP, raw IP, or others).<br>Remote socket address, if connected to another socket.<br>struct sockaddr<br>socket是跟协议族绑定的概念, 所以要用inet_create, netlink_create</p>
</li>
<li><p>Abstruction Concepts of socket<br>sock_common: 5 tuples, the essence of sock<br>inet_timewait_sock: deal heavily loaded servers without violating the protocol specification<br>sock: network sock<br>atalk_sock: apple talk<br>unix_sock: unix_address<br>netlink_sock:portid<br>socket: BSD socket with VFS stuff<br>inet_sock: INET sock, sock_common inet-nise!ip addr, Multicast, TTL<br>inet_connection_sock: INET connection oriented sock, Pluggable congestion control hook, Delayed ACK control data<br>tcp_sock: tcp sock, snd_cwnd, tcp_options_received, reordering, keepalive_probes</p>
</li>
</ul>
<h1 id="Session">Session</h1>
<p>In computer science, in particular networking, a session is a semi-permanent interactive information interchange<br>session，中文经常翻译为会话，其本来的含义是指<em>有始有终</em>的一系列动作/消息<br><a href="http://www.scottklement.com/rpg/socktut/overview.html" target="_blank" rel="external">Instance of tcp session in BSD socket</a><br><a href="http://www.dummies.com/how-to/content/network-basics-tcp-session-establishment-handshaki.html" target="_blank" rel="external">TCP Session - Handshaking in protocol</a></p>
<h1 id="Virtul_circuit">Virtul circuit</h1>
<p>A virtual circuit (VC) is a means of transporting data over a packet switched computer network<br>in such a way that it appears as though there is a dedicated physical layer link between the source and destination end systems of this data. </p>
<h1 id="Implemention_of_protocols">Implemention of protocols</h1>
<ul>
<li>inet_create<br>sock-&gt;ops = inet_protosw-&gt;ops = inet_stream_ops</li>
<li>proto<em>ops — fops<br>is a good name stand for all PF</em>*, all 协议族, but sock_generic_ops is better 具体协议与BSD socket api的通用接口</li>
<li>proto, — specific fs, like ext,  btfs in <em>inetsw</em><br>sock的lab决定具体的slab, 如tcp_sock/udp_sock, 根本的发送方法tcp_sendmsg, 协议的真正实体!</li>
<li>越来越具体<br>BSD socket api -&gt;proto_ops(sock type base)协议通用api -&gt;proto (udp/tcp_prot)<br>sys_bind -&gt; inet_stream_ops -&gt;inet_bind -&gt;sk_prot-&gt;bind(likely, is NULL)<br>write-&gt;inet_stream_ops-&gt;sendmsg-&gt;tcp_sendmsg</li>
<li>inet_connection_sock_af_ops<br>icsk-&gt;icsk_af_ops</li>
<li>net_protocol — l4 rcv in <em>inet_protos</em><br>是iphdr中protocol成员的延伸, 所以有了tcp_protocol/udp_protocol all in inet_protos</li>
<li>packet_type — l3 rcv in ptype_all and ptype_base<br>pt_prev-&gt;func</li>
</ul>
<h1 id="BSD_socket_layer">BSD socket layer</h1>
<p>Details and skills in Unix network programming.</p>
<ul>
<li>sockfs — using read, write, close to manipulate socket fd.<br><a href="http://isomerica.net/~dpn/socket_vfs.pdf" target="_blank" rel="external">Linux Sockets and the Virtual Filesystem</a></li>
</ul>
<h1 id="Transport_layer">Transport layer</h1>
<p>Details in l4.md</p>
<h1 id="Network_layer">Network layer</h1>
<p>Details in l3.md</p>
<h1 id="Data_link_layer">Data link layer</h1>
<p>Details in l2.md</p>
<h1 id="Physical_layer_—_PHY">Physical layer — PHY</h1>
<ul>
<li>Physical Coding Sublayer</li>
<li>Physical Medium Attachment Sublayer</li>
<li>Physical Medium Dependent Sublayer</li>
</ul>
<h1 id="out">out</h1>
<p>inet_stream_ops-&gt;tcp_sendmsg()-&gt;tcp_push()-&gt;<strong>tcp_push_pending_frames()-&gt;tcp_write_xmit()-&gt;tcp_transmit_skb()-&gt;ipv4_specific.ip_queue_xmit()-&gt;<br>ip_local_out()-&gt;</strong>ip_local_out()-&gt;NF_INET_LOCAL_OUT-&gt;dst_output()-&gt;<br>ip_output()<br>{<br>    //set in ip_mkroute_output<br>    skb-&gt;dev = dev = skb_dst(skb)-&gt;dev; //!!!<br>    skb-&gt;protocol = htons(ETH_P_IP);<br>}-&gt;NF_INET_POST_ROUTING-&gt;ip_finish_output()-&gt;</p>
<p>ip_finish_output2-&gt; dst_neigh_output<br>{<br>    neigh_hh_output // hh already in below:-)<br>    or<br>    n-&gt;output = neigh_resolve_output{dev_hard_header}<br>}<br>-&gt;dev_queue_xmit()<br>{</p>
<pre><code>__dev_xmit_skb<span class="subst">-&gt;</span>__qdisc_run<span class="subst">-&gt;</span>qdisc_restart()<span class="subst">-&gt;</span>dev_hard_start_xmit()
<span class="literal">or</span> 
validate_xmit_skb<span class="subst">-&gt;</span>skb_gso_segment<span class="subst">-&gt;</span>skb_mac_gso_segment<span class="subst">-&gt; </span>ptype<span class="subst">-&gt;</span>callbacks<span class="built_in">.</span>gso_segment<span class="subst">=</span>inet_gso_segment<span class="subst">-&gt;</span>tcp4_gso_segment,
dev_hard_start_xmit()
</code></pre><p>}<br>xmit_one-&gt;<br>{<br>    dev_queue_xmit_nit is Sun’s Network Interface Tap (NIT)<br>    netdev_start_xmit-&gt;ops-&gt;ndo_start_xmit{this functions is init in createing device} = e100_xmit_frame<br>}</p>
<p>softirq:net_tx_action()-&gt;qdisc_run()</p>
<h1 id="in_&amp;_forward">in &amp; forward</h1>
<ul>
<li><p>NAPI poll_list net_device<br>driver intr add skb to private queue -&gt; e100_intr()-&gt;<strong>netif_rx_schedule()-&gt;</strong>napi_schedule(netdev,nic-&gt;napi)-&gt;:<br>add napi to poll_list and __raise_softirq_irqoff()<br>do_softirq-&gt;net_rx_action()-&gt;<br>+netdev-&gt;poll()=e100_poll()private function-&gt;e100_rx_clean()…-&gt;<br>netif_receive_skb()-&gt;deliver_skb-&gt;<br>private queue and private function</p>
</li>
<li><p>Non-NAPI input_pkt_queue skb<br>driver intr vortex_rx()-&gt;netif_rx()-&gt;add skb to SD input_pkt_queue-&gt;napi_schedule(backlog)-&gt;add backlog to SD poll_list __raise_softirq_irqoff()<br>async:net_rx_action()-&gt;<br>+backlog-&gt;poll()=process_backlog()<br>-&gt;netif_receive_skb()-&gt;deliver_skb-&gt;<br>skb to sd input_pkt_queue process</p>
</li>
<li><p>common path<br>pt_prev-&gt;func=ip_rcv()-&gt;NF_INET_PRE_ROUTING-&gt;ip_rcv_finish()-&gt;<br>ip_route_input()-&gt;ip_route_input_slow()<br>{<br>  local_input dst.input??=ip_local_deliver()<br>  or<br>  ip_mkroute_input()-&gt;__mkroute_input():dst.input=ip_forward() 紧接着dst.output??=ip_output()<br>}<br>dst_input()-&gt;<br>{<br>  ip_local_deliver()-&gt;NF_INET_LOCAL_IN-&gt;ip_local_deliver_finish()-&gt;inet_protos.tcp_v4_rcv()<br>  or<br>  ip_forward()-&gt;NF_INET_FORWARD-&gt;ip_forward_finish()-&gt;dst_output()见上。<br>}</p>
</li>
<li><p>Differences<br>1 NAPI has not netif_rx():input_pkt_queue.<br>2 NAPI and Non-NAPI used different napi-&gt;poll 决定本质上的区别。<br>3 vortex_rx() 多，e100_rx_clean()多！这点可以看出不同优势来。</p>
</li>
<li><p>Need clean<br>net_tx_action-&gt;output_queue/每个设备的qdisc and  clear_bit<strong>QDISC_STATE_SCHED qdisc_run add back
</strong>QDISC_STATE_SCHED是否加入softdata<br>qdisc_restart: 如果队列有数据就返回大于零 继续减小weight_p<br><strong>qdisc_run queue no data </strong>QDISC_STATE_SCHED not set, only in this case!<br>driver tx, stack xmit</p>
</li>
</ul>
<h1 id="Net_initialization">Net initialization</h1>
<p>start_kernel-&gt; parse_early_param irq timers softirq -&gt; rest_init(): kthread<br>{<br>    do_basic_setup()<br>    {<br>        driver_init<br>        sock_init<br>        do_initcalls()<br>        {<br>            net_dev_init: Initializing the Device Handling Layer<br>            {<br>                per-CPU<br>                proc<br>                sysfs<br>                ptype_base<br>                dst_init<br>                softirq: net_rx/tx_action<br>                dev_cpu_callback: CPU hotplug.<br>            }<br>        }<br>    }<br>    free_init_mem()<br>    run_init_process()<br>}</p>
<h1 id="network_init">network init</h1>
<p>inet_init()-&gt;ip_init()-&gt;ip_rt_init()-&gt;ip_fib_init()-&gt;fib_hash_init():create kmem_cache</p>
<h1 id="net_device_init">net device init</h1>
<ul>
<li>net_dev_init</li>
<li>nic init<br>e100_init_module    pci_register_driver:构建结构    driver_regiser:注册到内核    really_probe()drv-&gt;probe:初始化。<br>vconfig add        regiser_vlan_device：构建结构    register_netdevice:注册到内核    dev-&gt;init():初始化</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/net/">net</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/net/">net</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/02/27/net/net/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/02/27/net/l3/" title="Network layer" itemprop="url">Network layer</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/116338260303228780000?rel=author" title="Firo Yang" target="_blank" itemprop="author">Firo Yang</a>
		
  <p class="article-time">
    <time datetime="2015-02-27T07:46:13.000Z" itemprop="datePublished"> Published Feb 27 2015</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Network_layer">Network layer</h1>
<ul>
<li>Error detection, unreliable<br>Best effort service,IP has a simple error handling algorithm:<br>throw away the datagram and try to send an ICMP message back to the source</li>
<li>Host addressing</li>
</ul>
<h1 id="IP">IP</h1>
<ul>
<li>IP Packet Fragmentation/Defragmentation</li>
<li>MSS tcp_sock-&gt;mss_cache in tcp_sync_mss not minus SACK option<br>  in <em>tcp_current_mss</em> minus SACK option<br>rfc1122</li>
</ul>
<ul>
<li>IP option is  fixed in a session icsk-&gt;icsk_ext_hdr_len;</li>
<li>is network header icsk-&gt;icsk_af_ops-&gt;net_header_len</li>
<li>tcp_sock-&gt;tcp_header_len all except SACK option (Not sure)<h2 id="Reference">Reference</h2>
<a href="http://www.tecmint.com/ipv4-and-ipv6-comparison/" target="_blank" rel="external">What’s wrong with IPv4 and Why we are moving to IPv6</a></li>
</ul>
<h2 id="Classless_Inter-Domain_Routing">Classless Inter-Domain Routing</h2>
<p>CIDR is a method for allocating IP addresses and routing Internet Protocol packets.<br>IETF introduced CIDR in 1993 to replace the classful network.</p>
<ul>
<li>prefix/length</li>
<li>Prefix aggregation</li>
</ul>
<h2 id="Supernetwork">Supernetwork</h2>
<p>prefix/route aggregation<br>decrease the memroy and the time of search route table.</p>
<h2 id="Private_network">Private network</h2>
<p>In the Internet addressing architecture, a private network is a network that uses private IP address space.</p>
<h2 id="IP_fragmention/defragmention">IP fragmention/defragmention</h2>
<p>iphdr-&gt;id, iphdr-&gt;frag_off<br>skb_shared_info-&gt;frag_list<br>ip_fragment/ip_defrag<br><a href="http://tools.ietf.org/html/rfc6864" target="_blank" rel="external">Updated Specification of the IPv4 ID Field</a></p>
<h2 id="Route">Route</h2>
<ul>
<li>state structure<br>fib_info:route info<br>fib_config:</li>
<li>add new rule<br>iproute2 …-&gt;inet_rtm_newroute()-&gt;fib_new_table()-&gt;fib_hash_table()</li>
<li>Multi-time line<br>fib_create_info(): create a fib_info<h2 id="Netfilter">Netfilter</h2>
</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/net/">net</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/net/">net</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/02/27/net/l3/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/02/27/net/netdevice/" title="Linux net device" itemprop="url">Linux net device</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/116338260303228780000?rel=author" title="Firo Yang" target="_blank" itemprop="author">Firo Yang</a>
		
  <p class="article-time">
    <time datetime="2015-02-27T07:46:13.000Z" itemprop="datePublished"> Published Feb 27 2015</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Common_Interface_felling">Common Interface felling</h1>
<h2 id="No_driver_tg3">No driver tg3</h2>
<p>I remove all kernel 4.0  moduls that ip ad just only output lo interface info.</p>
<h2 id="Hiwifi">Hiwifi</h2>
<ul>
<li><p>Disable network(netifd) in hiwifi openwrt<br>root@Hiwifi:/# ip ad<br>1: lo: <loopback> mtu 16436 qdisc noop state DOWN<br>  link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>2: eth2: <broadcast,multicast> mtu 1500 qdisc noop state DOWN qlen 1000<br>  link/ether d4:ee:07:07:75:c2 brd ff:ff:ff:ff:ff:ff<br>3: ra0: <broadcast,multicast> mtu 1500 qdisc noop state DOWN qlen 1000<br>  link/ether 00:00:00:00:00:00 brd ff:ff:ff:ff:ff:ff<br>4: sit0: <noarp> mtu 1480 qdisc noop state DOWN<br>  link/sit 0.0.0.0 brd 0.0.0.0<br>5: gre0: <noarp> mtu 1476 qdisc noop state DOWN<br>  link/gre 0.0.0.0 brd 0.0.0.0</noarp></noarp></broadcast,multicast></broadcast,multicast></loopback></p>
</li>
<li><p>Enable network(netifd) in hiwifi openwrt<br>1: lo: <loopback,up,lower_up> mtu 16436 qdisc noqueue state UNKNOWN<br>  link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>  inet 127.0.0.1/8 scope host lo<br>  inet6 ::1/128 scope host </loopback,up,lower_up></p>
<pre><code> valid_lft <span class="keyword">forever</span> preferred_lft <span class="keyword">forever</span>
</code></pre><p>2: eth2: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state UNKNOWN qlen 1000<br>  link/ether d4:ee:07:07:75:c2 brd ff:ff:ff:ff:ff:ff<br>  inet6 fe80::d6ee:7ff:fe07:75c2/64 scope link </broadcast,multicast,up,lower_up></p>
<pre><code> valid_lft <span class="keyword">forever</span> preferred_lft <span class="keyword">forever</span>
</code></pre><p>3: ra0: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast master br-lan state UNKNOWN qlen 1000<br>  link/ether d4:ee:07:07:75:c2 brd ff:ff:ff:ff:ff:ff<br>4: sit0: <noarp> mtu 1480 qdisc noop state DOWN<br>  link/sit 0.0.0.0 brd 0.0.0.0<br>5: gre0: <noarp> mtu 1476 qdisc noop state DOWN<br>  link/gre 0.0.0.0 brd 0.0.0.0<br>6: br-lan: <broadcast,multicast,up,lower_up> mtu 1500 qdisc noqueue state UP<br>  link/ether d4:ee:07:07:75:c2 brd ff:ff:ff:ff:ff:ff<br>  inet 10.1.1.1/24 brd 10.1.1.255 scope global br-lan<br>  inet6 fe80::d6ee:7ff:fe07:75c2/64 scope link </broadcast,multicast,up,lower_up></noarp></noarp></broadcast,multicast,up,lower_up></p>
<pre><code> valid_lft <span class="keyword">forever</span> preferred_lft <span class="keyword">forever</span>
</code></pre><p>7: eth2.1@eth2: <broadcast,multicast,up,lower_up> mtu 1500 qdisc noqueue master br-lan state UP<br>  link/ether d4:ee:07:07:75:c2 brd ff:ff:ff:ff:ff:ff<br>8: eth2.2@eth2: <broadcast,multicast,up,lower_up> mtu 1500 qdisc noqueue state UP<br>  link/ether d4:ee:07:07:75:c3 brd ff:ff:ff:ff:ff:ff<br>  inet 192.168.199.223/24 brd 192.168.199.255 scope global eth2.2<br>  inet6 fe80::d6ee:7ff:fe07:75c3/64 scope link </broadcast,multicast,up,lower_up></broadcast,multicast,up,lower_up></p>
<pre><code> valid_lft <span class="keyword">forever</span> preferred_lft <span class="keyword">forever</span>
</code></pre><p>9: ra1: <broadcast,multicast> mtu 1500 qdisc noop state DOWN qlen 1000<br>  link/ether d6:ee:07:04:75:c2 brd ff:ff:ff:ff:ff:ff<br>10: apcli0: <broadcast,multicast> mtu 1500 qdisc noop state DOWN qlen 1000<br>  link/ether d6:ee:07:05:75:c2 brd ff:ff:ff:ff:ff:ff</broadcast,multicast></broadcast,multicast></p>
</li>
</ul>
<h1 id="Bridging">Bridging</h1>
<ul>
<li>A bridge behaves like a virtual network switch, 一样.<br>Bridging is a router using MAC address at L2 in essence.<br>A bridge transparently relays traffic between multiple network interfaces.<br>In plain English this means that a bridge connects two or more physical Ethernets together to form one bigger (logical) Ethernet.</li>
</ul>
<h2 id="Spanning_tree_protocol(Rapid_STP,Multiple_STP)">Spanning tree protocol(Rapid STP,Multiple STP)</h2>
<p>the algorithm is not executed on a single host that later distributes the result to all the others;<br>instead, this is a distributed protocol.</p>
<h2 id="BPUD_Bridge_protocol_data_units">BPUD Bridge protocol data units</h2>
<ul>
<li><p>Configuration BPDU<br>Used to define the loop-free topology.<br>Topology Change Notification (TCN) BPDU<br>Used by a bridge to notify the root bridge about a detected topology change. </p>
</li>
<li><p>BPDU Aging<br>On a stable network, the time depends mainly on how loaded the bridges are and how fast they can process BPDUs.</p>
</li>
<li><p>Root Bridge<br>The root bridge is the only bridge that generates BPDUs<br>The root bridge makes sure each bridge in the network comes to know about a topology change when one occurs</p>
</li>
<li><p>Designated Bridges<br>While each tree has only one root bridge, there is one designated bridge for each LAN,<br>which becomes the bridge all hosts and bridges on the LAN use to reach the root.<br>The designated bridge is chosen by determining which bridge on the LAN has the lowest path cost to the root bridge.</p>
</li>
<li><p>Bridge Port<br>While root ports lead toward the root of the tree (i.e., the root bridge), designated ports lead toward the leaves.</p>
</li>
</ul>
<h2 id="Function">Function</h2>
<p>Rassive learning<br>Flooding<br>Aging<br>Bridging Loops<br>Switch:</p>
<h2 id="Details">Details</h2>
<p>newe_bridge_dev() create net_device and net_bridge.</p>
<h1 id="vlan">vlan</h1>
<p>Vlans are a way to split up a layer2 broadcasting domain, VLANs allow you to create multiple separated networks with only a single switch.<br>In a vlan-capable network there are 2 types of connections : “access” connections and “trunk” connections<br>Vlan packet</p>
<h2 id="Vlan_packet">Vlan packet</h2>
<p>Preamble 56 alternating bits | SFD10101011 | dst mac | src mac | TPID 0x8100 | TCI:PCP DEI VID| Ether type 0x86DD ipv6 …|CRC FCS</p>
<h2 id="802-1Q/Vlan_header">802.1Q/Vlan header</h2>
<p>TPID is the same as 0x86DD just a Ether type 0x8100  | PCP 3bis  DEI 1bit VID 12bis</p>
<h2 id="Access_connection">Access connection</h2>
<p>An access connection looks like a normal connection to an ethernet switch,<br>only that switch will only forward your packets within the same vlan, so they will not be able to reach ports that are in a different vlan.<br>For access ports, the switch will add (or overwrite) this tag value on any incoming(it means transfer out of host) packet before forwarding</p>
<h2 id="Trunk_connnection">Trunk connnection</h2>
<p>“Trunk” ports can communicate with multiple vlans, but you need to send special packets that contain<br>both the packet and an indication in what vlan they are to be forwarded.<br>For trunk ports, the value is supposed to be present. If it is not, the value of the “native vlan” will be added.</p>
<h2 id="Split_up_a_layer2_broadcasting_domain">Split up a layer2 broadcasting domain</h2>
<p>vlan 什么都别想, 你总的有个vlan吧. 对上来就创建一个vlan-device.<br>vconfig add eth0 vid<br>for trunk routing between the different vlans we need ip_forward</p>
<h2 id="Details_of_implemention">Details of implemention</h2>
<p>net/8021q/</p>
<h3 id="initialize">initialize</h3>
<p>vlan_proto_init()<br>这个函数最重要的是映射了iocctl函数， 因为接下来的所有操作都要用到ioctl。</p>
<h3 id="application">application</h3>
<p>vconfig eth0 1<br>vlan_ioctl_handler()-&gt;register_vlan_device():<br>alloc net_device.<br>vlan_setup()函数非常重要，设置dev-&gt;priv_flags 为 802.1q！tx queue 为0.<br>设置open函数为vlan_dev_open;<br>register_vlan_dev(）把这个设备注册到内核。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/net/">net</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/net/">net</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/02/27/net/netdevice/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/02/27/net/l2/" title="Data link layer" itemprop="url">Data link layer</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/116338260303228780000?rel=author" title="Firo Yang" target="_blank" itemprop="author">Firo Yang</a>
		
  <p class="article-time">
    <time datetime="2015-02-27T07:46:13.000Z" itemprop="datePublished"> Published Feb 27 2015</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="data_link_layer">data link layer</h1>
<h2 id="Reference">Reference</h2>
<ul>
<li>IEEE 802 suite<br>IEEE 802.1—概述、体系结构和网络互连，以及网络管理和性能测量。<br>IEEE 802.2—逻辑链路控制LLC。最高层协议与任何一种局域网MAC子层的接口。<br>IEEE 802.3—CSMA/CD网络，定义CSMA/CD总线网的MAC子层和物理层的规范。<br>IEEE 802.4—令牌总线网。定义令牌传递总线网的MAC子层和物理层的规范。<br>IEEE 802.5—令牌环形网。定义令牌传递环形网的MAC子层和物理层的规范。<br>IEEE 802.6—城域网。<br>IEEE 802.7—宽带技术。<br>IEEE 802.8—光纤技术。<br>IEEE 802.9—综合话音数据局域网。<br>IEEE 802.10—可互操作的局域网的安全。<br>IEEE 802.11—无线局域网。<br>IEEE 802.12—优先高速局域网(100Mb/s)。<br>IEEE 802.13—有线电视(Cable-TV)。 </li>
</ul>
<h2 id="Common_concepts">Common concepts</h2>
<ul>
<li><p>The link layer<br>is the group of methods and communications protocols that only operate on the link that a host is physically connected to. </p>
</li>
<li><p>The link<br>is the physical and logical network component used to interconnect hosts or nodes in the network </p>
</li>
<li><p>a link protocol<br>is a suite of methods and standards that operate only between adjacent network nodes of a local area network segment<br>or a wide area network connection.</p>
</li>
<li><p>MTU<br>This limits the number of bytes of data to 1500(Ethernet II) and 1492(IEEE 802), respectively.<br>This characteristic of the link layer is called the MTU, its maximum transmission unit.</p>
</li>
<li><p>PMTU<br>/proc/sys/net/ipv4/ip_no_pmtu_disc<br>0 enable, 1 disable</p>
</li>
</ul>
<p>cat /proc/sys/net/core/warnings</p>
<p>/proc/sys/net/ipv4/tcp_mtu_probing<br>!0 enable tcp_mtu_probing()<br>If you are using Jumbo Frames, we recommend setting tcp_mtu_probing = 1 to<br>help avoid the problem of MTU black holes. Setting it to 2 sometimes causes performance problems.</p>
<p>net/ipv4/icmp.c<br>icmp_unreach(<br>type 3, code 4<br>icmph-&gt;type == ICMP_DEST_UNREACH //3<br>case ICMP_FRAG_NEEDED //4<br>icmp_err,</p>
<h2 id="Frame">Frame</h2>
<p><a href="http://www.infocellar.com/networks/ethernet/frame.htm" target="_blank" rel="external">Ethernet Frame</a></p>
<ul>
<li>一种不太确定的非严格的真实划分<br>TCP/IP -&gt; Ethenet II frame<br>IPX/APPLETALK -&gt; 802.3/LLC(802.2), SNAP, mac 发来的包走这条路.</li>
</ul>
<ul>
<li>jumbo frame?</li>
</ul>
<h1 id="net_device">net_device</h1>
<p>link -&gt; net<em>device -&gt; if<br>driver -&gt; manipulate dev-&gt;state through netif</em>*_on/off -&gt; dev-&gt;flags<br>+rfc2863</p>
<ul>
<li><a href="https://www.kernel.org/doc/Documentation/networking/operstates.txt" target="_blank" rel="external">operational state</a></li>
<li><a href="https://support.cumulusnetworks.com/hc/en-us/articles/202693826-Monitoring-Interface-Administrative-State-and-Physical-State-on-Cumulus-Linux" target="_blank" rel="external">Monitoring Interface Administrative State and Physical State on Cumulus Linux</a></li>
</ul>
<ul>
<li><p>dev-&gt;operstate<br>admin state is if flag<br>operate state is link_state<br>Administrative state is the result of “ip link set dev<br><dev> up or down” and reflects whether the administrator wants to use<br>the device for traffic.<br>enp9s0: <no-carrier,broadcast,multicast,up> mtu 1500 qdisc mq state DOWN mode DEFAULT group default qlen 1000<br>operate is DOWN, amdin is UP&gt;<br>Operational state<br>shows the ability of an interface to transmit this user data.<br>  “UNKNOWN”, “NOTPRESENT”, “DOWN”, “LOWERLAYERDOWN”,<br>  “TESTING”, “DORMANT”,    “UP”<br>IF_OPER_UNKNOWN,<br>see rfc2863</no-carrier,broadcast,multicast,up></dev></p>
</li>
<li><p>dev-&gt;link_mode<br>IF_LINK_MODE_DORMANT wifi<br>IF_LINK_MODE_DEFAULT wire<br>对应dev-&gt;operstate in 转化方法rfc2863_policy()</p>
</li>
<li><p>dev-&gt;state<br><strong>LINK_STATE_START,     这是内核自身的标记位</strong>dev_open init_dummy_netdev <strong>dev_close_many      
</strong>LINK_STATE_PRESENT,         也是内核自己的, 用的比 START早<br><strong>LINK_STATE_NOCARRIER,        
</strong>LINK_STATE_LINKWATCH_PENDING, 也是辅助状态不明, nocarrier和dormant都可接收的<br>__LINK_STATE_DORMANT</p>
</li>
<li><p>dev-&gt;flags dev_get_flags()</p>
</li>
</ul>
<ul>
<li><p>if flags form man netdevice or or kernel src codes<br>/sys/class/net/<dev>/flags</dev></p>
<pre><code>        IFF_UP            Interface is running.
        IFF_BROADCAST     Valid broadcast address <span class="operator"><span class="keyword">set</span>.
        IFF_DEBUG         Internal debugging flag.
        IFF_LOOPBACK      Interface <span class="keyword">is</span> a loopback interface.
        IFF_POINTOPOINT   Interface <span class="keyword">is</span> a point-<span class="keyword">to</span>-point link.
        IFF_RUNNING       Resources allocated.
        IFF_NOARP         <span class="keyword">No</span> arp protocol, L2 destination address <span class="keyword">not</span> <span class="keyword">set</span>.
        IFF_PROMISC       Interface <span class="keyword">is</span> <span class="keyword">in</span> promiscuous <span class="keyword">mode</span>.
        IFF_NOTRAILERS    Avoid <span class="keyword">use</span> <span class="keyword">of</span> trailers.
        IFF_ALLMULTI      Receive <span class="keyword">all</span> multicast packets.
        IFF_MASTER        <span class="keyword">Master</span> <span class="keyword">of</span> a <span class="keyword">load</span> balancing bundle.
        IFF_SLAVE         <span class="keyword">Slave</span> <span class="keyword">of</span> a <span class="keyword">load</span> balancing bundle.

        IFF_MULTICAST     Supports multicast
        IFF_PORTSEL       <span class="keyword">Is</span> able <span class="keyword">to</span> <span class="keyword">select</span> media type via ifmap.
        IFF_AUTOMEDIA     Auto media selection active.
        IFF_DYNAMIC       The addresses <span class="keyword">are</span> lost <span class="keyword">when</span> the interface goes
                          down.
        IFF_LOWER_UP      Driver signals L1 up (since Linux <span class="number">2.6</span><span class="number">.17</span>)
        IFF_DORMANT       Driver signals dormant (since Linux <span class="number">2.6</span><span class="number">.17</span>)
        IFF_ECHO          Echo sent packets (since Linux <span class="number">2.6</span><span class="number">.25</span>)</span>
</code></pre></li>
</ul>
<ul>
<li><p>netdev_queue-&gt;state<br><a href="http://thread.gmane.org/gmane.linux.kernel/709444/focus=714632" target="_blank" rel="external">Understand __QUEUE_STATE_FROZEN</a><br>  <strong>QUEUE_STATE_DRV_XOFF,     netif_tx_stop_queue
  </strong>QUEUE_STATE_STACK_XOFF,<br>  __QUEUE_STATE_FROZEN,<br>可以确定这个frozen这个标志位就是为了dev_watchdog服务, 从所有内核态代码调用的位置得出的.</p>
</li>
<li><p>dev_watchdog,</p>
</li>
</ul>
<h1 id="Neighbor">Neighbor</h1>
<ul>
<li>ip_output_finish2 -&gt; __neigh_create -&gt; tbl-&gt;constructor -&gt; arp_constructor{<br>if !dev-&gt;header_ops   //slip is the case, see sl_setup<br>  neigh-&gt;ops = &amp;arp_direct_ops<br>  neigh-&gt;output = neigh_direct_output<br>else if ARPHRD_ROSE/AX25/NETROM<br>  arp_broken_ops<br>  neigh-&gt;ops-&gt;output<br>else if dev-&gt;header_ops-&gt;cache<br>  neigh-&gt;ops = &amp;arp_hh_ops<br>else<br>  arp_generic_ops</li>
</ul>
<p>if (neigh-&gt;nud_state &amp; NUD_VALID)<br>    neigh-&gt;output = neigh-&gt;ops-&gt;connected_output;<br>else<br>    neigh-&gt;output = neigh-&gt;ops-&gt;output;<br>}</p>
<ul>
<li><p>ip_output_finish2 -&gt; dst_neigh_output -&gt; neigh_resolve_output</p>
</li>
<li><p>ipv4 Neighbor output instance of ethernet<br>see alloc_etherdev_mqs-&gt; ether_setup{<br>dev-&gt;header_ops = &amp;eth_header_ops;<br>dev-&gt;type       = ARPHRD_ETHER;<br>eth_header_ops.cache = eth_header_cache<br>}<br>so neigh-&gt;ops = &amp;arp_hh_ops; neigh-&gt;output = neigh_resolve_output in arp_hh_ops</p>
<p> //tg3_init_one<br> dev-&gt;netdev_ops = &amp;tg3_netdev_ops;<br> dev-&gt;ethtool_ops = &amp;tg3_ethtool_ops;<br> dev-&gt;watchdog_timeo = TG3_TX_TIMEOUT;</p>
<p> //In ppp<br>static void ppp_setup(struct nethernetet_device *dev)<br>{<br> dev-&gt;netdev_ops = &amp;ppp_netdev_ops;<br> dev-&gt;hard_header_len = PPP_HDRLEN;<br> dev-&gt;mtu = PPP_MRU;<br> dev-&gt;addr_len = 0;<br> dev-&gt;tx_queue_len = 3<br> dev-&gt;type = ARPHRD_PPP<br>}</p>
</li>
</ul>
<h1 id="PPP_SLIP">PPP SLIP</h1>
<h1 id="Data_Framing">Data Framing</h1>
<p>dst_neigh_output-&gt;dev_hard_header -&gt;  eth_header</p>
<h1 id="TC_Qdisc">TC Qdisc</h1>
<h2 id="Bibliography">Bibliography</h2>
<p><a href="http://tldp.org/HOWTO/Traffic-Control-HOWTO/intro.html" target="_blank" rel="external">http://tldp.org/HOWTO/Traffic-Control-HOWTO/intro.html</a><br>lartc.rog<br><a href="http://ace-host.stuart.id.au/russell/files/tc/" target="_blank" rel="external">http://ace-host.stuart.id.au/russell/files/tc/</a></p>
<h2 id="Common_concepts-1">Common concepts</h2>
<p>Shaping: Shapers delay packets to meet a desired rate.<br>Scheduling: Schedulers arrange and/or rearrange packets for output.<br>Classifying: Classifiers sort or separate traffic into queues.<br>Policing: Policers measure and limit traffic in a particular queue.<br>Dropping: Dropping discards an entire packet, flow or classification.<br>Marking: Marking is a mechanism by which the packet is altered.</p>
<h2 id="Add_new_qdisc">Add new qdisc</h2>
<p>RTM_NEWQDISC -&gt; tc_modify_qdisc</p>
<h2 id="The_execution_of_u32_tc_rule">The execution of u32 tc rule</h2>
<h3 id="user_space_tc_qidsc_add">user space tc qidsc add</h3>
<p> u32_parse_opt<br>{<br>    -&gt; parse_selector -&gt;…-&gt; parse_ip<br>    struct nlmsghdr *n<br>    rta = NLMSG_TAIL(n)<br>    rta-&gt;type = TCA_U32_SEL</p>
<p>}</p>
<h3 id="kernel_space">kernel space</h3>
<p>NETLINK_ROUTE -&gt; RTM_NEWTFILTER: see tc_filter_init -&gt; tc_ctl_tfilter-&gt;(tp-&gt;ops-&gt;change = u32_change in net/sched/cls_u32.c)<br>tcf_exts_validate: init police and action of this shel tc command,<br>put sel in tc_u_knode;<br>tc_u_knode insert in tc_u_hnode<br>root is tcf_proto 入殓 by prior.<br>tcf_proto -&gt; tc_u_hnode -&gt; tc_u_knode -&gt; sel<br>也就是用户太的selector没变存到内核中了.<br>enqueue -&gt; filter_list -&gt;u32-&gt;classify() this classify is implement by u32!<br>tcf_proto_ops-&gt;.kind = “u32”, .classify   =   u32_classify,<br>police and action invoke in tcf_action_exec , act register by tcf_register_action.</p>
<ul>
<li>TCA_U32_CLASSID in u32_set_parms<br>filter classid and flowid is the same meaning in russell tc doc</li>
<li>TCA_KIND in filter is u32…register_tcf_proto_ops</li>
</ul>
<h2 id="FAQ">FAQ</h2>
<ul>
<li>conflict tc qidsc del with softnet_data-&gt;softnet_data<br>[PATCH] pkt_sched: Destroy gen estimators under rtnl_lock().<br><a href="http://thread.gmane.org/gmane.linux.network/102444/focus=102592" target="_blank" rel="external">http://thread.gmane.org/gmane.linux.network/102444/focus=102592</a><br>After synchronize_rcu() in dev_deactivate() we are sure any qdisc_run(),<br>from dev_queue_xmit() or net_tx_action() can only see and lock noop_qdisc.<br>This was happened in dev_deactivate_many()</li>
<li>difference between synchronize_net and  synchronize_rcu?<br><a href="http://article.gmane.org/gmane.linux.network/196309/match=net_device+dismantle" target="_blank" rel="external">http://article.gmane.org/gmane.linux.network/196309/match=net_device+dismantle</a><br>In this patch, we replace synchronize_rcu with synchronize_net().</li>
</ul>
<h1 id="LLC_(TCP/IP_rarely_use_this_sub_layer)">LLC (TCP/IP rarely use this sub layer)</h1>
<ul>
<li>ptype MAC layer 之上, 可能是data link(llc) or network layer(ip)<br>定义了所有从驱动上来的packet接收函数, 这里有ip_rcv 还有pppoe_rcv,llc_rcv, NO snap_rcv<br>dev_add_pack<br>llc_rcv{snap_rcv}<br>netif_receive_skb -&gt;ip/llc_rcv</li>
</ul>
<h1 id="NAPI">NAPI</h1>
<h2 id="Etymology">Etymology</h2>
<ul>
<li><p>Bounary<br>Bound means limit, -ary stands for pertaining to;</p>
</li>
<li><p>Interface<br>Latin inter (prep., adv.) “among, between, betwixt, in the midst of,” from PIE *enter “between, among”</p>
</li>
</ul>
<p><a href="http://www.webopedia.com/TERM/I/interface.html" target="_blank" rel="external">Interface</a>: A boundary across which two independent systems meet and act on or communicate with each other.<br>In computing, an <a href="https://en.wikipedia.org/wiki/Interface_(computing\" target="_blank" rel="external">interface</a> ) is a shared boundary across which two separate components of a computer system exchange information. </p>
<ul>
<li>interrupt coalescing</li>
</ul>
<h2 id="Defination">Defination</h2>
<ul>
<li>New API (NAPI) is an interface to use interrupt mitigation techniques for networking devices in the Linux kernel. </li>
</ul>
<h2 id="Simlar_interface">Simlar interface</h2>
<p>Add <a href="https://lwn.net/Articles/346187/" target="_blank" rel="external">blk-iopoll</a>, a NAPI like approach for block devices</p>
<h2 id="Why_NAPI?">Why NAPI?</h2>
<p>Such an approach is intended to reduce the overhead of packet receiving. </p>
<h2 id="Dialectic_-_Abstract-Negative-Concrete">Dialectic - Abstract-Negative-Concrete</h2>
<p>Lower load<br>less likely to be re-order<br>overwritten in the network card’s incoming ring buffer while heavlily load.</p>
<h2 id="How_NAPI_work">How NAPI work</h2>
<ul>
<li>The idea is to defer incoming message handling until there is a sufficient amount of them so that it is worth handling them all at once.<h3 id="Implemention">Implemention</h3>
Custom queue and poll function</li>
</ul>
<h1 id="Driver">Driver</h1>
<ul>
<li>skb-&gt;protocol</li>
</ul>
<ul>
<li>assignment in ip_output by = htons(ETH_P_IP)</li>
<li>assignment in driver by = eth_type_trans() </li>
</ul>
<h1 id="MAC">MAC</h1>
<ul>
<li>Addressing,LAN switching</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/net/">net</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/net/">net</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/02/27/net/l2/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/02/27/net/l4/" title="Transport layer" itemprop="url">Transport layer</a>
  </h1>
  <p class="article-author">By
       
		<a href="https://plus.google.com/116338260303228780000?rel=author" title="Firo Yang" target="_blank" itemprop="author">Firo Yang</a>
		
  <p class="article-time">
    <time datetime="2015-02-27T07:46:13.000Z" itemprop="datePublished"> Published Feb 27 2015</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Transport_layer_—_common">Transport layer — common</h1>
<ul>
<li>Multiplexing —  Ports can provide multiple endpoints on a single node.<br>inet_hash_connect()</li>
<li>Encapuslation to segment in skb<br>  tcp_sendmsg-&gt;skb_add_data_nocache()</li>
</ul>
<h1 id="TCP_—_or_some_connetion_scok">TCP — or some connetion scok</h1>
<h2 id="Componets">Componets</h2>
<h3 id="Handshak">Handshak</h3>
<ul>
<li>kproxy reorder<br>chome -&gt;syn(kproxy reocrd syn) -&gt; firoyang.org<br>firoyang.org -&gt;sync ack -&gt; chrome<br>chrome -&gt; ack -&gt; firoyang.org<br>chrome -&gt; GET(firoyang.org) kproxy match then send record syn then setup natinfo -&gt;nginx<br>nginx -&gt; tcp send fake syn ack-&gt;chrome<br>chrome -&gt; ack -&gt; nginx(then -&gt; firoyang.org)<br>tcp_v4_do_rcv{<br>  sk-&gt;sk_state == TCP_ESTABLISHED<br>  tcp_rcv_established{<br>  len &lt;= tcp_header_len =&gt;<br>  tcp_ack -&gt; tcp_fastretrans_alert{retrans ack and GET(firoyang) -&gt; nginx<br>  }<br>}<br>nginx-&gt;GET -&gt;firoyang.org<br>firoyang.org-&gt;nginx-&gt;chrome</li>
</ul>
<h3 id="Sliding_window_protocol">Sliding window protocol</h3>
<p>Sliding window protocols are used where reliable in-order delivery of packets is required.<br>For every ack packet received, the window slides by one packet (logically) to transmit one new packet.</p>
<h3 id="ARQ">ARQ</h3>
<p>ack and timeout<br>Sliding window protocol is based on automatic repeat request/ARQ<br>My conclusion: in practice TCP is a mixture between both GBN and SR.<br>*Go-Back-N</p>
<ul>
<li>Selective repeat<h3 id="Congestion_control">Congestion control</h3>
icsk_ca_ops;<br>tcp_ack {<br>tcp_cong_avoid<br>tcp_fastretrans_alert<br>tcp_slow_start}<br>TCP send queue len /proc/sys/net/core/wmem_default</li>
</ul>
<h2 id="Services">Services</h2>
<ul>
<li>Connection-oriented communication — Session and virtual circuits<br>Connection-oriented (CO-mode[1]) communication is a network communication mode in telecommunications and computer networking, where a communication session or a semi-permanent connection is established before any useful data can be transferred, and where a stream of data is delivered in the same order as it was sent<br>Connection-oriented communication may be a circuit switched connection, or a packet-mode virtual circuit connection.<br>Layer 4 virtual circuits uses segment number fix routed reorder delivery. Same order delivery.</li>
<li>In-order</li>
<li>Flow control</li>
<li>Congestion avoidence</li>
<li>Reliability — assured,Error detection and correction<br>Error —  checksum, the transport protocol may check that the data is not corrupted<br>ACK is an indiction of segments lost.<br>correction — Retransmission, ARQ, Automatic repeat request schemes may be used to retransmit lost or corrupted data.<br>verify correct receipt by sending an ACK or NACK message to the sender.<h2 id="FAQ">FAQ</h2>
</li>
<li>What about TCP sequence number warp around<br>PAWS use timestamp and RTT to solve this problem.<h2 id="Timer">Timer</h2>
*sk_timer<br>listen: synack<br>estblished: keepalive<br>timewait:</li>
</ul>
<h2 id="FIXME">FIXME</h2>
<ul>
<li>Create TCP options<br>tcp_syn_build_options()</li>
<li>Receive ack<br>tcp_ack()<br>记录ack的数据大小mss or tcp abc<br>update snd_wl1 and snd_una<br>slow path update mtu mss tcp_skb_cb.sacked</li>
<li>Active send data<br>tcp_sendpage()/tcp_sendmsg()-&gt;tcp_write_xmit()/tcp_push_one()-&gt;tcp_transmit_skb</li>
<li>Timer expiring retransmiter<br>tcp_retransmiter_timer()…-&gt;tcp_transmit_skb()</li>
<li>reponse for receiving an ACK<br>tcp_data_snd_check()-&gt;tcp_write_xmit()</li>
<li>tcp_v4_rcv<br><a href="http://thread.gmane.org/gmane.linux.network/85613/focus=85614" target="_blank" rel="external">skb-&gt;dev = NULL;</a></li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/net/">net</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/net/">net</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/02/27/net/l4/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/"><span></span>Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/cs/" title="cs">cs<sup>7</sup></a></li>
		  
		
		  
			<li><a href="/categories/firo/" title="firo">firo<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/howto/" title="howto">howto<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/kernel/" title="kernel">kernel<sup>9</sup></a></li>
		  
		
		  
			<li><a href="/categories/list/" title="list">list<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/net/" title="net">net<sup>7</sup></a></li>
		  
		
		  
			<li><a href="/categories/philosophy/" title="philosophy">philosophy<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/kernel/" title="kernel">kernel<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/net/" title="net">net<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/cs/" title="cs">cs<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/comic/" title="comic">comic<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/animation/" title="animation">animation<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/howto/" title="howto">howto<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/firo/" title="firo">firo<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.snooda.com" target="_blank" title="Snooda">Snooda</a>
            
          </li>
        
          <li>
            
            	<a href="http://ifind.cc" target="_blank" title="江长顺">江长顺</a>
            
          </li>
        
    </ul>
</div>

  

<div class="doubanshow">
<p class="asidetitle">豆瓣秀</p>
<div>
<script type="text/javascript" src="http://www.douban.com/service/badge/firodb/?show=collection&amp;n=12&amp;columns=3&amp;hidelogo=yes&amp;hideself=yes&amp;cat=book|movie" ></script>
</div>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		<a href="https://github.com/firogh" target="_blank" class="icon-github" title="github"></a>
		
		
		<a href="http://stackoverflow.com/users/1025001" target="_blank" class="icon-stack-overflow" title="stackoverflow"></a>
		
		
		<a href="https://twitter.com/firoter" target="_blank" class="icon-twitter" title="twitter"></a>
		
		
		
		<a href="https://www.linkedin.com/in/firoli" target="_blank" class="icon-linkedin" title="linkedin"></a>
		
		
		<a href="https://www.douban.com/people/firodb" target="_blank" class="icon-douban" title="豆瓣"></a>
		
		
		
		<a href="https://plus.google.com/116338260303228780000?rel=author" target="_blank" class="icon-google_plus" title="Google+"></a>
		
		
		<a href="mailto:firogm@gmail.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2015 
		
		<a href="/about" target="_blank" title="Firo Yang">Firo Yang</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>





<script type="text/javascript">

var disqus_shortname = 'firoyang';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->

<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-63396532-1', 'firoyang.org');  
ga('send', 'pageview');
</script>



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F170c29f9e12f3a9c2477a313ab84017e' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
