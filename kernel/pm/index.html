<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kernel, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Power management : firoyang.org"/>
<meta property="og:site_name" content="Firo Website"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://firoyang.org/kernel/pm/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2015-02-27"/>
<meta property="article:modified_time" content="2015-02-27"/>



<meta property="article:tag" content="kernel">





    <base href="http://firoyang.org/">
    <title> Power management - Firo</title>
    <link rel="canonical" href="http://firoyang.org/kernel/pm/">
    

    <link href='http://fonts.useso.com/css?family=Fjalla+One|Open+Sans:300' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/static/css/style.css">

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    
</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
<header id="header">
	<link rel="stylesheet" href="static/css/font-awesome.min.css">
	<nav id="nav">
	<div id="title"><a href="/">Firo Notes</a></div>
	<div>
	
	</div>
	</nav>
	<nav id="nav">
    	        <ul id="mainnav">
            <li>
            <a href="/review/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-thumbs-o-up"></i></span>
                <span> review</span>
            </a>
            </li>
	
            <li>
            <a href="/history/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-institution"></i></span>
                <span> history </span>
            </a>
            </li>
            <li>
            <a href="/about">
                <span class="icon"> <i aria-hidden="true" class="fa fa-rocket"></i></span>
                <span> Firo </span>
            </a>
            </li>
            <li>
                <a href="/howto/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-gamepad"></i></span>
                <span> howto </span>
            </a>
            </li>
            <li>
            <a href="/kernel/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-linux"></i></span>
                <span> kernel </span>
            </a>
            </li>
            <li>
            <a href="/net/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-globe"></i></span>
                <span> net </span>
            </a>
            </li>
            <li>
            <a href="/philosophy/">
                <span class="icon"> <i aria-hidden="true" class="icon-leaf"></i></span>
                <span> philosophy </span>
            </a>
            </li>
            <li>
                <a href="/cs/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-laptop"></i></span>
                <span> cs </span>
            </a>
            </li>
        </ul>

	</nav>
	<nav id="nav">
       
	</nav>
</header>



<section id="main">
  <h1 itemprop="name" >Power management</h1>
  

<aside id="meta">

    <div>
        <section id="datecount">
          <h4 id="date"> Fri Feb 27, 2015 </h4>
          
        </section>
        
        <ul id="tags">
          
            <li> <a href="http://firoyang.org//tags/kernel">kernel</a> </li>
          
        </ul>

    </div>


</aside>

<meta itemprop="wordCount" content="392">
<meta itemprop="datePublished" content="2015-02-27">
<meta itemprop="url" content="http://firoyang.org/kernel/pm/">


  <div>
        <article itemprop="articleBody" id="content">
           

<h1 id="reference:243fc1ea57e1b68ab2b7a4065db2e761">Reference</h1>

<p><a href="http://www.wowotech.net/pm_subsystem/generic_pm_architecture.html">wowotech</a>
<a href="https://lwn.net/Articles/384146/">The cpuidle subsystem</a>cpuidle—Do nothing, efficiently
<a href="http://www.marvell.com/embedded-processors/armada-xp/assets/HW_MV78460_OS.PDF">Hardware Specifications 9.4</a>
<a href="http://www.marvell.com/embedded-processors/armada-xp/assets/ARMADA-XP-Functional-SpecDatasheet.pdf">Functional Specifications 34</a>
Documentation/power
Controlling Processor C-State Usage in Linux
<a href="http://doc.opensuse.org/documentation/html/openSUSE_114/opensuse-tuning/cha.tuning.power.html">Chapter 11. Power Management</a></p>

<p>C-states: idle core power state</p>

<h1 id="the-structure-of-pm-source-codes:243fc1ea57e1b68ab2b7a4065db2e761">The structure of PM source codes</h1>

<ul>
<li>Interface<br />
syscall /sys/power</li>
<li>PM core
kernel/power
main.c suspend.c suspend_test.c console.c process.c</li>
<li>Device PM
driver/base/power &ndash; Power management interface, firo
power management 是针对device, bus, driver这部分的. 在suspend_devices_and_enter用到dpm_suspend_start.
driver/各种设备的驱动
driver/cpuidle &ndash;firo</li>
<li>Platform PM
include/linux/suspend.h&mdash;-定义platform dependent PM有关的操作函数集
就是他platform_suspend_ops
arch/xxx/mach-xxx/xxx.c or arch/xxx/plat-xxx/xxx.c&mdash;-平台相关的电源管理操作</li>
<li>CPU control</li>
</ul>

<h1 id="important-data-structure:243fc1ea57e1b68ab2b7a4065db2e761">Important data structure</h1>

<ul>
<li>Platform PM
platform_suspend_ops, platform plat-* is equivalent to mach-* and microarchitecture.
plat-* is abustruct from mach-*1 and mach-<em>2 and so on.
mach-</em> is more closer to Board!
所以这个platform_suspend_ops, 是非常重要的, 他包含了所有BSP底层的内容.
竟然是用suspend_ops这个全局变量, 来承载所有platform相关的内容.</li>

<li><p>Device PM
dev_pm_ops这个和上面是完全不同的两条调用路线,在suspend_devices_and_enter用到dpm_suspend_start.</p>

<h1 id="steps-of-suspend:243fc1ea57e1b68ab2b7a4065db2e761">Steps of suspend</h1></li>

<li><p>Function steps
state_store-&gt;pm_suspend-&gt;enter_state-&gt;
{
valid_state &amp; suspend_prepare
suspend_devices_and_enter-&gt; {
    suspend_console &amp; ftrace_stop &amp; dpm_suspend_start
    suspend_enter-&gt;
    {
        disable_nonboot_cpus &amp; arch_suspend_disable_irqs
    }
}
}</p></li>

<li><p>PM core
freeze userspace
console</p></li>

<li><p>Device PM
suspend device
before and first part in suspend_enter</p></li>

<li><p>Mass stuffs
CPU &amp; IRQ disable
syscore
Device PM check wakeup pendings
middle part in suspend_enter</p></li>

<li><p>Platform PM
last part in suspend_enter</p>

<h1 id="steps-of-resume:243fc1ea57e1b68ab2b7a4065db2e761">Steps of resume</h1></li>
</ul>

<h1 id="knowledge:243fc1ea57e1b68ab2b7a4065db2e761">Knowledge</h1>

<p>console switch、process freeze、CPU hotplug、wakeup</p>

<h1 id="introdution:243fc1ea57e1b68ab2b7a4065db2e761">Introdution</h1>

<p>电源管理都涉及到那些内容?
PMU MP and DEV, CPU cores, L2 cache, Coherency Fabric, Devices
Core Power Modes: run, idle/WFI/WFE/stadnby, deep idle/power down
* WFI: core power down except snoop and interrupt cache working
disable clocks of the CPU
snoop other Cores and io agent.
only snoop block are temporarily woken up and the block back to WFI mode after complete snoop.
can recognize interrupt.
* Power down: core power down, l1 flush, cache not mantained/snoop stoped, but l2 &amp; fabric
can not recognize interrupt, recovery is fully depended on MP_PMU</p>

<p>In hardware layer, we need <a href="https://en.wikipedia.org/wiki/Power_Management_Unit">PMU</a> to complete power management.
What is the relation of PMU and CPU?
armadaxp的PMU与CPU物理上与逻辑上是独立的.
The Power Management functions are provided by two power manager units:
The Device Power Management Unit (DEV_PMU)
The Multiprocessor Power Management Service Unit (MP_PMU).
PMU省电模式:</p>

<h1 id="kernel-cpuidle-subsystem:243fc1ea57e1b68ab2b7a4065db2e761">kernel cpuidle subsystem</h1>

<h2 id="steps-of-cpuilde:243fc1ea57e1b68ab2b7a4065db2e761">Steps of cpuilde</h2>

<ul>
<li><p>interface
kernel sched and sysfs</p></li>

<li><p>cpuidle core
cpuidle.c、driver.c、governor.c、sysfs.c。
抽象出cpuidle device、cpuidle driver、cpuidle governor三个实体
一个core对应一个cpuidle device drivers/cpuidle/cpuidle.c.
device 和driver隔离, 通过全局变量联系 ifndef CONFIG_CPU_IDLE_MULTIPLE_DRIVERS
管理cpuidle driver 和governor
上层sched模块 和sysfs 提供接口</p></li>

<li><p>cpuidle governors</p></li>

<li><p>cpuidle drivers
drivers/cpudile/cpuidle-xxx.c or
arch/arm/plat-armada/cpuidle.c
如何进入idle状态
什么条件下会退出</p></li>
</ul>

<h2 id="source-code-layout:243fc1ea57e1b68ab2b7a4065db2e761">Source code layout</h2>

<ul>
<li>drivers/cpuidle
include/linux/cpuidle.h
cpuidle core、cpuidle governors和cpuidle drivers三个模块</li>
<li>kernel\sched\idle.c
kernel sched中的cpuidle entry</li>
</ul>

<h2 id="important-data-structre:243fc1ea57e1b68ab2b7a4065db2e761">Important data structre</h2>

<p>struct cpuidle_driver
struct cpuidle_state
struct cpuidle_device used by ladder or menu</p>

<p>device_initcall -&gt; armadaxp_init_cpuidle -&gt; cpuidle_register_driver  cpuidle_register_device
cpu_idle -&gt; cpuidle_idle_call</p>

        </article>
  </div>
</section>

<aside id=comments>
    <div><h2> Comments </h2></div>
    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'firoyang';
    var disqus_identifier = 'http:\/\/firoyang.org\/kernel\/pm\/';
    var disqus_title = 'Power management';
    var disqus_url = 'http:\/\/firoyang.org\/kernel\/pm\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</aside>

<footer>
  <div>
    <p>
    &copy; 2014 ~ 2016 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Firo Yang</span></span>
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/80x15.png" /></a>. Powered by <a href="http://gohugo.io">Hugo</a>.
        Theme by <a href="http://spf13.com">Steve Francia <a href="http://firoyang.org">Firo Yang</a>.
    </p>
  </div>
</footer>
<script type="text/javascript">
(function(){var j=function(a,b){return window.getComputedStyle?getComputedStyle(a).getPropertyValue(b):a.currentStyle[b]};var k=function(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else a.attachEvent('on'+b,c)};var l=function(a,b){for(key in b)if(b.hasOwnProperty(key))a[key]=b[key];return a};window.fitText=function(d,e,f){var g=l({'minFontSize':-1/0,'maxFontSize':1/0},f);var h=function(a){var b=e||1;var c=function(){a.style.fontSize=Math.max(Math.min(a.clientWidth/(b*10),parseFloat(g.maxFontSize)),parseFloat(g.minFontSize))+'px'};c();k(window,'resize',c)};if(d.length)for(var i=0;i<d.length;i++)h(d[i]);else h(d);return d}})();
fitText(document.getElementById('title'), 1)
</script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63396532-1', 'auto');
  ga('send', 'pageview');

</script>


</body>
</html>


<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>

</body>
