<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Kernel hacking : firoyang.org"/>
<meta property="og:site_name" content="Firo Website"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://firoyang.org/kernel/hacking/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2015-04-25"/>
<meta property="article:modified_time" content="2015-04-25"/>





    <base href="http://firoyang.org/">
    <title> Kernel hacking</title>
    <link rel="canonical" href="http://firoyang.org/kernel/hacking/">
    

    
<link rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/static/css/style.css">


    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
     
</head>

<body style="background-color:#FFFFF0;" lang="en" itemscope itemtype="http://schema.org/Article">
<body lang="en" itemscope itemtype="http://schema.org/Article">
<header id="header">
	<link rel="stylesheet" href="static/css/font-awesome.min.css">
	<nav id="nav">
	<div id="title"><a href="/" style="color:#B22222">Firo Notes</a></div>


	<div>
	
	</div>
	</nav>
	<nav id="nav">
    	        <ul id="mainnav">
            <li>
            <a href="/review/" style="background-color:#B22222">
                <span class="icon"> <i aria-hidden="false" class="fa fa-thumbs-o-up"></i></span>
                <span> review</span>
            </a>
            </li>
            <li>
            <a href="/firo/" style="background-color:#B22222">
                <span class="icon"> <i aria-hidden="true" class="fa fa-male"></i></span>
                <span> firo </span>
            </a>
            </li>
            <li>
            <a href="/history/" style="background-color:#B22222">
                <span class="icon"> <i aria-hidden="false" class="fa fa-institution"></i></span>
                <span> history </span>
            </a>
            </li>
            <li>
            <a href="/about" style="background-color:#B22222">
                <span class="icon"> <i aria-hidden="true" class="fa fa-rocket"></i></span>
                <span> Firo </span>
            </a>
            </li>
            <li>
                <a href="/howto/" style="background-color:#B22222">
                <span class="icon"> <i aria-hidden="true" class="fa fa-gamepad"></i></span>
                <span> howto </span>
            </a>
            </li>
            <li>
            <a href="/kernel/" style="background-color:#B22222">
                <span class="icon"> <i aria-hidden="true" class="fa fa-linux"></i></span>
                <span> kernel </span>
            </a>
            </li>
            <li>
            <a href="/net/" style="background-color:#B22222">
                <span class="icon"> <i aria-hidden="true" class="fa fa-globe"></i></span>
                <span> net </span>
            </a>
            </li>
            <li>
            <a href="/philosophy/" style="background-color:#B22222">
                <span class="icon"> <i aria-hidden="true" class="icon-leaf"></i></span>
                <span> philosophy </span>
            </a>
            </li>

            <li>
                <a href="/lyubishchev/" style="background-color:#B22222">
                <span class="icon"> <i aria-hidden="true" class="fa fa-hourglass-half"></i></span>
                <span> lyubishchev </span>
            </a>
            </li>
            <li>
                <a href="/cs/" style="background-color:#B22222">
                <span class="icon"> <i aria-hidden="true" class="fa fa-laptop"></i></span>
                <span> cs </span>
            </a>
            </li>
	    <li>
                <a href="/linguistics/" style="background-color:#B22222">
                <span class="icon"> <i aria-hidden="true" class="fa fa-language"></i></span>
                <span> linguistics </span>
            </a>
            </li>
        </ul>

	</nav>
	<nav id="nav">
       
	</nav>
</header>



 <link rel="stylesheet" href="highlight.js/styles/monokai-sublime.css">
    <script src="highlight.js/highlight.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
	<section id="main">
	  <h1 itemprop="name" style="color:#B22222;" >Kernel hacking</h1>
	  

<aside id="meta">

    <div>
        <section id="datecount">
          <h4 id="date"> Sat Apr 25, 2015 </h4>
          
        </section>
        
        <ul id="tags">
          
        </ul>

    </div>


</aside>

<meta itemprop="wordCount" content="572">
<meta itemprop="datePublished" content="2015-04-25">
<meta itemprop="url" content="http://firoyang.org/kernel/hacking/">


	  <div>
		<article itemprop="articleBody" id="content">
		   

<h1 id="kernel-hacker之路">kernel hacker之路</h1>

<p>我实在太想聊这个话题 &ndash; 内核hacker的成长之路!<br />
不是教你写第一个kernel module, 就灭火了. 而是持续的一步步成长为<br />
内核的中坚力量, 甚至是maintainer.<br />
作为一个内核爱好者, 从接触到现在已经3年半了. 然而, 我对自己是非常失望的.<br />
因为我看了3年多的书, 从今年(15)5月才开始, 给社区提补丁.<br />
起始我在12年的11月份曾经给社区, 提过几次补丁. 后来有那么两三次, 想帮着修复<br />
kernel panic 和oops的问题, 基本上个人感觉难度非常太大就无极而终了.<br />
5月份这次, 我是因为实在不想在看书籍了, 市面上稍微有点名的书籍, 我都看过.<br />
实在太厌烦再看书了, 我把自己和另外一个内核hacker 王聪做了对比, 得出结论:</p>

<pre><code>赶快滚去给社区提patch! 
</code></pre>

<p>我挨个看了王聪给社区提的前50个patch. 都是很简单的修改.<br />
我几次挫败都是, 因为没能找到合适内核事情去做, 最终没有下文了.<br />
今天, 我在给社区提了20个左右的patch 10几个被接收了. 我现在找到了一条成长路.</p>

<h2 id="内核我现在认为可以给新人做得事">内核我现在认为可以给新人做得事</h2>

<p><a href="https://lwn.net/Articles/284099/">https://lwn.net/Articles/284099/</a>  这个帖子, 提供了新手可以做得事情, 我觉得非常好.<br />
smatch coccinelle的分析结果.<br />
源码中标注的FIXME和TODO, 简单的提过去很难被接受, 难的这些开发者自己都没搞定, 新人更难.<br />
这也不是一条好路.<br />
内核bugzilla kerneloops上问题, 这个很难.<br />
找一个和内核相关的工作驱动啊, 网络开发, 虚拟化, 存储都非常赞.<br />
自己搞个feature, 感觉更难, 这个需要需求驱动.<br />
没有一条轻松的路让你走, 但你却不应该光着脚走在上面!!!<br />
内核之外有很多值得珍惜的. 尽力做好, 你能做的, 开始点滴积累.<br />
终有一天会聚成沧海, 前提是你等得到那天, 不要亏待自己.<br />
内核之路始终时不那么清晰, 但是反思过后, 你便知道, 该去做什么了.<br />
这也许是最难受的情况了.<br />
Linus 之前说过, 搞得内核你得用起来. uml 是个不错的开端.<br />
用起来才是王道!</p>

<p>#git<br />
<a href="http://git-scm.com/docs/gittutorial">gittutorial - A tutorial introduction to Git</a></p>

<h1 id="linux-source-code">linux source code</h1>

<p><a href="https://www.kernel.org/doc/man-pages/linux-next.html">Working with linux-next</a><br />
要add git://git.kernel.org/pub/scm/linux/kernel/git/next/linux-next.git不是https.<br />
我之前改了好多bug基于linus的分支, 提交后被告知别人已改. 后来Julia告诉我要基于linux-next开发.<br />
我的linux next remote 就叫next, 基于其创建开发分支.</p>

<pre><code>git branch now next/master
git pull next master:now
</code></pre>

<h1 id="你提patch-社区的困惑是什么">你提patch, 社区的困惑是什么?</h1>

<p>每个kernel newbie 都应该完整看完这个mail list<br />
<a href="http://thread.gmane.org/gmane.linux.kernel/683798/focus=684297">http://thread.gmane.org/gmane.linux.kernel/683798/focus=684297</a><br />
你能看到鹰派的Al还有温和派Andrew Morton.<br />
为什么<a href="http://kernelnewbies.org/这么重要网站">http://kernelnewbies.org/这么重要网站</a>, 不做的好一点, 至少界面友好点.<br />
应该找个机会, 整一下.</p>

<h1 id="fix-kernel-mistakes">Fix kernel mistakes</h1>

<p>内核至今如此优秀就是因为, 成千上万前赴后继的开发者笔耕不缀的结果.<br />
别当豆包不当干粮, 虽然, 你不能设计出很牛的算法, or 什么子系统,<br />
但是内核还有很多问题有待解决, 正所谓老虎也要打, 苍蝇也要拍; 千里之堤毁于蚁穴.<br />
我提过好些这种patch Dan Carpenter都告诉我Linus已经改了.</p>

<h2 id="kernel-newbie上有个list">kernel newbie上有个list</h2>

<p><a href="http://kernelnewbies.org/KernelJanitors/Todo">KernelJanitors/Todo</a><br />
* Style fix<br />
如:<br />
remove_wait_queue(entry-&gt;wait_address,&amp;entry-&gt;wait);<br />
remove_wait_queue(entry-&gt;wait_address, &amp;entry-&gt;wait);</p>

<h2 id="smatch">Smatch</h2>

<p>smatch这个工具是Dan写的主要就是为了找到内核的小问题, 基本用法:</p>

<pre><code>    make CHECK=&quot;~/path/to/smatch/smatch -p=kernel&quot; C=1 \
            bzImage modules | tee warns.txt
</code></pre>

<p>smatch 会产生好多可疑的问题, 细心寻找吧.<br />
你找到了, 那么就是修改了.<br />
记住在smatch之前一点要git pull next master:now一下, 保证checkout到了now的分支.</p>

<h2 id="coccinelle">Coccinelle</h2>

<p>Coccinelle是 Julia Lawall 写的静态检测工具.very nice.<br />
自己研究吧<br />
Documentation/coccinelle.txt<br />
<a href="http://pagesperso-systeme.lip6.fr/Julia.Lawall/tutorial.pdf">http://pagesperso-systeme.lip6.fr/Julia.Lawall/tutorial.pdf</a></p>

<h2 id="生成patch">生成patch</h2>

<p>先修改.<br />
之后git add<br />
在commit 之前你要 git log &ndash;online path/to/modification/file<br />
看下提交的titile:</p>

<pre><code>git log  --oneline drivers/base/firmware_class.c
5455c8c firmware: Fix memory leak in error path
e0fd9b1 firmware: use const for remaining firmware names
f9692b2 firmware: fix possible use after free on name on a
</code></pre>

<p>主义冒号:后一定要有一个空格!<br />
你会还是看下Document下的submitting的文档.<br />
之后commit:<br />
先是类似上面的一行oneline 简要说明<br />
空一行.<br />
之后具体描述下.<br />
commit后, 生成patch<br />
如果你只提交了一次:</p>

<pre><code>git format-patch HEAD^..HEAD
</code></pre>

<p>这个命令就ok了.<br />
如果commit多次, 自己斟酌两次diff的commit id了, HEAD^ 和HEAD都是commit id.<br />
这样就生成了patch, 一般叫做0001-xxx-ooo.patch之类的<br />
如我这个, 已被接收:</p>

<pre><code>0001-firmware-Fix-memory-leak-in-error-path.patch
</code></pre>

<p>commit id 是5455c8c3284a63e2673d1be7f040fb245cbf9be9</p>

<h2 id="测试patch">测试patch</h2>

<p>复杂的patch要编译内核, 安装的机器上跑一下.</p>

<h2 id="发送patch">发送patch</h2>

<p>天朝用户自己打梯子吧proxychains shadowsocks.<br />
基本步骤是<br />
先编译一下:<br />
make path/to/modification/file.o<br />
之后<br />
./scripts/checkpatch.pl<br />
之后 get maintainer<br />
./scripts/get_maintainer.pl</p>

<p>发送的时候, 发给维护者 &ndash;cc其他人, 还有cc 一个mailist, 如果没有合适的list的话,<br />
就cc到linux-kernel@vger.kernel.org, 这是个开放的list, 有合适的list了, 就不要cc它了.</p>

<pre><code>proxychains git send-email --to ming.lei@canonical.com --cc gregkh@linuxfoundation.org --cc kernel-janitors@vger.kernel.org 0001-firmware-Fix-memory-leak-in-error-path.patch
</code></pre>

<p>免不了你要返工重新修改.这时候, 新生成的patch这样:</p>

<pre><code>git format-patch --subject-prefix=&quot;PATCH v2&quot; HEAD^..HEAD
</code></pre>

<p>改几次就v几.<br />
和社区交流的时候, 要注意礼貌, 而且要感谢别人对你的patch做出的建议,<br />
没有人的时间是被猪拱来的.</p>

<p>这些都是比较简单(代码量上)的patch, 要想提交深度的还需要对某方面的深度.<br />
基本上这就完了, 你的真正的patch就给社区了.</p>

<h1 id="进阶decent">进阶decent</h1>

<p>这个是昨天晚上改drivers代码时候, 看到TODO的注释猛然想到的.</p>

<pre><code>grep -nr 'FIXME' --include=&quot;*.c&quot;  ./ | tee fixmek.log
grep -nr 'TODO' --include=&quot;*.c&quot; ./ | tee todok.log
wc -l fixmek.log 
</code></pre>

<p>有6000多个.</p>

<h1 id="deeply-involved">Deeply involved</h1>

<p><a href="http://vger.kernel.org/~davem/net_todo.html">http://vger.kernel.org/~davem/net_todo.html</a><br />
这个列表上的基本都过期了&hellip;.哎<br />
往深了走不是难事, 主要是意识到内核, 不是什么神秘的东西, 选好一个方向<br />
简单看看概念见我的&lt;如何学习&gt; 就可以实践.<br />
必须要意识到, 动手比看再多概念管用, 我就是之前看了太多, 还发展出一个哲学<br />
体系出来:-) 确实随着现代信息科学给社会带来的巨大变化, 哲学也必须要更新.<br />
才能更好的服务于人.<br />
这几天就在, 找内核哪里还不完善, 自己能补上, 今天6号了.<br />
#patch formate advices<br />
* Julia Lawall Sorry to be picky,<br />
but normally people put a space after the colon.  Also,<br />
the subject line could be shorter: Remove unneeded cast.<br />
The description part of the subject doesnt have to be unique,<br />
just the whole thing, asfter the [PATCH] part.<br />
* Dan Carpenter<br />
Otherwise your patch was fine, btw.  Other improvements.<br />
Don&rsquo;t put &ldquo;Drivers:&rdquo; in the subject.<br />
On Wed, Apr 22, 2015 at 09:10:50PM +0800, Firo Yang wrote:<br />
&gt; From: Firo Yang <a href="mailto:firogm@gmail.com">firogm@gmail.com</a><br />
Don&rsquo;t include this line.  We can get it from you email address.</p>

<p>Include everyone from the ./scripts/get_maintainer.pl output except<br />
don&rsquo;t include linux-kernel@vger.kernel.org if there is another mailing<br />
list there already.<br />
* To find  patch prefix</p>

<pre><code>git log --oneline  path/to/file.c
</code></pre>

<ul>
<li><p>更新patch 要加v几</p>

<p>git format-patch &ndash;subject-prefix=&ldquo;PATCH v2&rdquo; xxx..ooo</p></li>

<li><p>提交多个patch 要手动生成一个[PATCH 0/N], 这个0就是要写简要描述的.</p>

<p>proxychains git send-email &ndash;subject &ldquo;[PATCH v2 0/15] Remove unneeded casts of memory-alloc function return values&rdquo; &ndash;thread &ndash;compose &ndash;confirm=compose &ndash;to firogm@gmail.com *.patch</p></li>

<li><p>Dave Miller偏好<br />
@@ -325,13 +325,15 @@ static inline void empty_child_dec(struct key_vector *n)<br />
static struct key_vector *leaf_new(t_key key, struct fib_alias *fa)<br />
{</p></li>

<li><p>struct tnode *kv = kmem_cache_alloc(trie_leaf_kmem, GFP_KERNEL);</p></li>

<li><p>struct key_vector *l = kv-&gt;kv;</p></li>

<li><p>struct tnode *kv;</p></li>

<li><p>struct key_vector *l;<br />
Dave Miller usually prefers it if variables are ordered from longest to shortest.<br />
So you should probably have l defined first, and then kv.</p></li>
</ul>

		</article>
	  </div>
	</section>

<aside id=comments>
    <div><h2> Comments </h2></div>
    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'firoyang';
    var disqus_identifier = 'http:\/\/firoyang.org\/kernel\/hacking\/';
    var disqus_title = 'Kernel hacking';
    var disqus_url = 'http:\/\/firoyang.org\/kernel\/hacking\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</aside>

<footer>
  <div>
    <p>
    &copy; 2014 ~ 2016 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Firo Yang </span></span><a href="http://creativecommons.org/licenses/by/4.0/">Some rights reserved</a>. 
	Powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://fortawesome.github.io/Font-Awesome/">Font Awesome</a>.
        Theme by <a href="http://spf13.com">Steve Francia <a href="http://firoyang.org">Firo Yang</a>.
    </p>
  </div>
</footer>
<script type="text/javascript">
(function(){var j=function(a,b){return window.getComputedStyle?getComputedStyle(a).getPropertyValue(b):a.currentStyle[b]};var k=function(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else a.attachEvent('on'+b,c)};var l=function(a,b){for(key in b)if(b.hasOwnProperty(key))a[key]=b[key];return a};window.fitText=function(d,e,f){var g=l({'minFontSize':-1/0,'maxFontSize':1/0},f);var h=function(a){var b=e||1;var c=function(){a.style.fontSize=Math.max(Math.min(a.clientWidth/(b*10),parseFloat(g.maxFontSize)),parseFloat(g.minFontSize))+'px'};c();k(window,'resize',c)};if(d.length)for(var i=0;i<d.length;i++)h(d[i]);else h(d);return d}})();
fitText(document.getElementById('title'), 1)
</script>




</body>
</html>


<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>

</body>
