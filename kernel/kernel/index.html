<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kernel, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="kernel : firoyang.org"/>
<meta property="og:site_name" content="Firo Website"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://firoyang.org/kernel/kernel/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2015-02-27"/>
<meta property="article:modified_time" content="2015-02-27"/>



<meta property="article:tag" content="kernel">





    <base href="http://firoyang.org/">
    <title> kernel - Firo</title>
    <link rel="canonical" href="http://firoyang.org/kernel/kernel/">
    

    <link href='http://fonts.useso.com/css?family=Fjalla+One|Open+Sans:300' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/static/css/style.css">

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    
</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
<header id="header">
	<link rel="stylesheet" href="static/css/font-awesome.min.css">
	<nav id="nav">
	<div id="title"><a href="/">Firo Notes</a></div>
	<div>
	
	</div>
	</nav>
	<nav id="nav">
    	        <ul id="mainnav">
            <li>
                <a href="/cs/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-laptop"></i></span>
                <span> cs </span>
            </a>
            </li>
            <li>
            <a href="/firo/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-male"></i></span>
                <span> firo </span>
            </a>
            </li>
            <li>
            <a href="/history/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-hourglass-half"></i></span>
                <span> history </span>
            </a>
            </li>
            <li>
            <a href="/about">
                <span class="icon"> <i aria-hidden="true" class="fa fa-rocket"></i></span>
                <span> About </span>
            </a>
            </li>
            <li>
                <a href="/howto/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-gamepad"></i></span>
                <span> howto </span>
            </a>
            </li>
            <li>
            <a href="/kernel/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-linux"></i></span>
                <span> kernel </span>
            </a>
            </li>
            <li>
            <a href="/net/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-globe"></i></span>
                <span> net </span>
            </a>
            </li>
            <li>
            <a href="/philosophy/">
                <span class="icon"> <i aria-hidden="true" class="icon-leaf"></i></span>
                <span> philosophy </span>
            </a>
            </li>
            <li>
            <a href="/review/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-thumbs-o-up"></i></span>
                <span> review</span>
            </a>
            </li>
        </ul>

	</nav>
	<nav id="nav">
       
	</nav>
</header>



<section id="main">
  <h1 itemprop="name" >kernel</h1>
  

<aside id="meta">

    <div>
        <section id="datecount">
          <h4 id="date"> Fri Feb 27, 2015 </h4>
          
        </section>
        
        <ul id="tags">
          
            <li> <a href="http://firoyang.org//tags/kernel">kernel</a> </li>
          
        </ul>

    </div>


</aside>

<meta itemprop="wordCount" content="605">
<meta itemprop="datePublished" content="2015-02-27">
<meta itemprop="url" content="http://firoyang.org/kernel/kernel/">


  <div>
        <article itemprop="articleBody" id="content">
           

<h1 id="reference:58a3cfc985b676d6d801b8fd6c47f42a">Reference</h1>

<p><a href="https://en.wikipedia.org/wiki/Kernel_(operating_system">Kernel in Wikipedia</a>
* Book
* Website
<a href="http://lwn.net/">http://lwn.net/</a>
<a href="http://elinux.org/Kernel_Debugging_Tips">http://elinux.org/Kernel_Debugging_Tips</a>
<a href="https://www.kernel.org/doc/">https://www.kernel.org/doc/</a>
<a href="http://kernelnewbies.org/KernelJanitors/Todo">http://kernelnewbies.org/KernelJanitors/Todo</a>
<a href="http://eudyptula-challenge.org/">http://eudyptula-challenge.org/</a>
<a href="http://wangcong.org/2007/03/09/-e8-b5-b0-e8-bf-91linux-e5-86-85-e6-a0-b8/">走近Linux内核&ndash; 王聪</a></p>

<h1 id="cpu-freq:58a3cfc985b676d6d801b8fd6c47f42a">CPU freq</h1>

<ul>
<li>onset
device_initcall: intel_pstate_init-&gt;cpufreq_register_driver</li>

<li><p>nuclus
** onset
__cpufreq_add_dev -&gt; cpufreq init= intel_pstate_cpu_init-&gt;intel_pstate_init_cpu
** coda
_cpu_down-&gt;
{
cpu_notify_nofail(CPU_DEAD | mod, hcpu)-&gt;timer_cpu_notify
cpu_notify_nofail(CPU_POST_DEAD | mod, hcpu)-&gt;cpufreq_cpu_callback-&gt;cpufreq exit = intel_pstate_cpu_exit,
}</p></li>

<li><p>coda</p></li>
</ul>

<h1 id="kernel-panic-3-10-62:58a3cfc985b676d6d801b8fd6c47f42a">kernel panic 3.10.62</h1>

<p>general protection fault and page fault
1498 errorentry general_protection do_general_protection
1499 errorentry page_fault do_page_fault
static const struct stacktrace_ops print_trace_ops = {
        .stack                  = print_trace_stack,
        .address                = print_trace_address,
        .walk_stack             = print_context_stack,
};
no_context-&gt;
{
    show_fault_oops-&gt;
    __die-&gt;
    {
        print_modules
        show_regs
        {
            printk(KERN_DEFAULT &ldquo;Stack:\n&rdquo;);
            show_stack_log_lvl-&gt;
            {
                show_trace_log_lvl-&gt;
                {
                    printk(&ldquo;%sCall Trace:\n&rdquo;, log_lvl);
                    // arch/x86/kernel/dumpstack_64.c
                    dump_trace-&gt;&amp;print_trace_ops
                }
            }
            printk(KERN_DEFAULT &ldquo;Code: &ldquo;);
        }
    }
}</p>

<h1 id="contents:58a3cfc985b676d6d801b8fd6c47f42a">Contents</h1>

<p>What&rsquo;s the difference between kernel and OS?
cpu: syscall, process, ipc, smp
memory:  mm
io: buffer cache, fs, io subsys</p>

<h1 id="design-pattern:58a3cfc985b676d6d801b8fd6c47f42a">Design pattern</h1>

<p><a href="http://lwn.net/Articles/336224/">Linux kernel design patterns</a>
<a href="http://www.cs.fsu.edu/~baker/devices/notes/patterns.html#">Linux Kernel Programming Patterns</a></p>

<h1 id="interface:58a3cfc985b676d6d801b8fd6c47f42a">Interface</h1>

<p>Latin inter (prep., adv.) &ldquo;among, between, betwixt, in the midst of,&rdquo; from PIE *enter &ldquo;between, among&rdquo;
<a href="http://www.webopedia.com/TERM/I/interface.html">Interface</a>:A boundary across which two independent systems meet and act on or communicate with each other.
In computing, an <a href="https://en.wikipedia.org/wiki/Interface_(computing)">interface</a> is a shared boundary across which two separate components of a computer system exchange information.
##API
system call
+ procfs are ultimately accessed via system calls
##ABI
elf, cpu specific</p>

<h3 id="x32-abi:58a3cfc985b676d6d801b8fd6c47f42a">x32 ABI</h3>

<p>ILP32
LP64</p>

<h2 id="system-call:58a3cfc985b676d6d801b8fd6c47f42a">System call</h2>

<h1 id="find-bug:58a3cfc985b676d6d801b8fd6c47f42a">Find bug</h1>

<ul>
<li>Considered fault types
Block “To avoid deadlock, do not call blocking functions with interrupts disabled or a spinlock held.”
Null “Check potentially NULL pointers returned from routines”
Var “Do not allocate large stack variables (&gt;1K) on the fixed-size kernel stack.”
INull “Do not make inconsistent assumptions about whether a pointer is NULL.”
Range “Always check bounds of array indices and loop bounds derived from user data.”
Lock “Release acquired locks; do not double-acquire locks.”
Intr “Restore disabled interrupts.”
Free “Do not use freed memory.”
Float “Do not use floating point in the kernel.”
Size “Allocate enough memory to hold the type for which you are allocating.”</li>
</ul>

<p>##KSM</p>

<p>#Signal
* struct signal_sturct:
The &ldquo;struct signal_struct&rdquo; is the random <em>leftovers</em> from all the other stuff.
<a href="http://thread.gmane.org/gmane.linux.kernel/512831/focus=513990">http://thread.gmane.org/gmane.linux.kernel/512831/focus=513990</a>
* sigpending
Store blocked signal info
* Non-mask signal
SIGKILL, SIGSTOP
##Generate signal
<strong>send_signal();
##Process siganl
* SIGKILL (may be some other)
process in _send_signal()-&gt; complete_signal() tsk-&gt;state |= TASK_WAKEKILL
<a href="http://lwn.net/Articles/288056/">http://lwn.net/Articles/288056/</a>
<a href="http://www.ibm.com/developerworks/library/l-task-killable/">http://www.ibm.com/developerworks/library/l-task-killable/</a>
* others
each time a switch is made from kernel mode to user mode,
arch-specific: entry.S -&gt; do_siganl()
{
    get_signal_deliver()
    {
        if fatal -&gt; do_greoup_exit()-&gt;&hellip;</strong>cleanup_sighand()
    }</p>

<pre><code>handle_signal() -&gt; k-&gt;u(hanle)-sigreturn-&gt;k
</code></pre>

<p>}</p>

<p>#Netlink
* Group
enum rtnetlink_groups
##What is netlink
Networking related kernel configuration and monitoring interfaces.
* IPC between kernel and user spacess process.
ioctl
* prarts
    libnl
    libnl-route
    libnl-genl
    libnl-nf</p>

<ul>
<li>How many parts does libnl-route has?
Address,  links, neighboring, routing, TC</li>
</ul>

<h2 id="need-patch:58a3cfc985b676d6d801b8fd6c47f42a">Need patch</h2>

<p>skbedit action
cgroup classifier
tun/tap dev
gre tunnel dev
tc classifier/action</p>

<p>#Namespace</p>

<p>#Module
##pre-require
modules.alias
<a href="http://doc.opensuse.org/documentation/html/openSUSE_113/opensuse-reference/cha.udev.html">http://doc.opensuse.org/documentation/html/openSUSE_113/opensuse-reference/cha.udev.html</a></p>

<p><a href="http://blog.chinaunix.net/uid-22954220-id-4380202.html">http://blog.chinaunix.net/uid-22954220-id-4380202.html</a>
运行时, 插入u盘也是这样.</p>

<ol>
<li>内核自己加载比如缺少模块的时候 网络协议, fs
<a href="https://unix.stackexchange.com/questions/90027/what-is-the-sequence-loading-linux-kernel-module-on-startup-how-priority-is-set/90037#90037">https://unix.stackexchange.com/questions/90027/what-is-the-sequence-loading-linux-kernel-module-on-startup-how-priority-is-set/90037#90037</a></li>
</ol>

<p>3 rc 里面smartqos之类的.</p>

<p>##Load module into kernel
vmlinux.lds.h linker scipts include helper macros.</p>

<p>#Data structures
* u32 __u32
__u32 is used for user-space. declare a variabe used by icotl. qosmark.
u32 is used for kernel.
deatils in ldd3e chapter 10</p>

<p>#Panic
kernel/kernel/panic.c</p>

<p>#init
##initcall</p>

<p>##disk
subsys_initcall 4 genhd_device_init with base_probe{ request_module()}
module_init 6 -&gt;init_sd-&gt;sync_schedule_domain(sd_probe_async</p>

<p>##cmdline
root= name_to_dev_t, mount_root in prepare_namespace
如果/init不能 sys_access, 则prepare_namespace,切换到真正的root=指定的设备上设备在sd_probe上初始化了.
systemd负责挂在文件系统, 切换.</p>

<p>#src-tree
include/linux: share with userspace
include/net: kernel stuff</p>

<h1 id="assembly-in-kernel:58a3cfc985b676d6d801b8fd6c47f42a">Assembly in kernel</h1>

<p>为了简单! 内核修改特权寄存器和指令, 用汇编实现简单.
尽可能加速. c到汇编, 编译器相对保守,</p>

<h1 id="the-principle-of-kernel-driver-backport:58a3cfc985b676d6d801b8fd6c47f42a">The principle of kernel &amp; driver backport</h1>

<p>将高本版kernel的feature移植到低版本的kernel的过程就是backport.
1. 尽量保持与mainline的代码一致
2. 做好取舍不要引入太多patch.</p>

<h2 id="开发流程:58a3cfc985b676d6d801b8fd6c47f42a">开发流程</h2>

<p>理清所引入feature的代码. 主要数据结构以及功能流程.</p>

<h1 id="arm:58a3cfc985b676d6d801b8fd6c47f42a">ARM</h1>

<h2 id="smp-ops:58a3cfc985b676d6d801b8fd6c47f42a">smp_ops</h2>

<p>Machine: Marvell Armada XP Development Board
MACHINE_START(_type,_name)
<strong>section</strong>(&ldquo;.arch.info.init&rdquo;)
arch/arm/tools/mach-types
armada_xp_db            MACH_ARMADA_XP_DB       ARMADA_XP_DB            3036</p>

<h2 id="smp:58a3cfc985b676d6d801b8fd6c47f42a">smp</h2>

<p>An Implementation Of Multiprocessor Linux Alan Cox</p>

<h3 id="cpumask:58a3cfc985b676d6d801b8fd6c47f42a">cpumask</h3>

<h2 id="interrupt:58a3cfc985b676d6d801b8fd6c47f42a">Interrupt</h2>

<p>SPI and PPI or IPI, difference?</p>

<h1 id="faq:58a3cfc985b676d6d801b8fd6c47f42a">Faq</h1>

<p>MACHINE_START</p>

<h2 id="kernel-system-boot-hang-freeze:58a3cfc985b676d6d801b8fd6c47f42a">Kernel/system boot hang/freeze</h2>

<h3 id="sysrq:58a3cfc985b676d6d801b8fd6c47f42a">Sysrq</h3>

<p>Whe sysrq work?</p>

<h3 id="bootargs:58a3cfc985b676d6d801b8fd6c47f42a">bootargs</h3>

<p>debug initcall_debug</p>

<h3 id="printk:58a3cfc985b676d6d801b8fd6c47f42a">printk</h3>

        </article>
  </div>
</section>

<aside id=comments>
    <div><h2> Comments </h2></div>
    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'firoyang';
    var disqus_identifier = 'http:\/\/firoyang.org\/kernel\/kernel\/';
    var disqus_title = 'kernel';
    var disqus_url = 'http:\/\/firoyang.org\/kernel\/kernel\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</aside>

<footer>
  <div>
    <p>
    &copy; 2015 2016 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Firo Yang</span></span>
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/80x15.png" /></a>. Powered by <a href="http://gohugo.io">Hugo</a>.
        Theme by <a href="http://spf13.com">Steve Francia <a href="http://firoyang.org">Firo Yang</a>.
    </p>
  </div>
</footer>
<script type="text/javascript">
(function(){var j=function(a,b){return window.getComputedStyle?getComputedStyle(a).getPropertyValue(b):a.currentStyle[b]};var k=function(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else a.attachEvent('on'+b,c)};var l=function(a,b){for(key in b)if(b.hasOwnProperty(key))a[key]=b[key];return a};window.fitText=function(d,e,f){var g=l({'minFontSize':-1/0,'maxFontSize':1/0},f);var h=function(a){var b=e||1;var c=function(){a.style.fontSize=Math.max(Math.min(a.clientWidth/(b*10),parseFloat(g.maxFontSize)),parseFloat(g.minFontSize))+'px'};c();k(window,'resize',c)};if(d.length)for(var i=0;i<d.length;i++)h(d[i]);else h(d);return d}})();
fitText(document.getElementById('title'), 1)
</script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63396532-1', 'auto');
  ga('send', 'pageview');

</script>


</body>
</html>


<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>

</body>
