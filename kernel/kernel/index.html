<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kernel, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="kernel : firoyang.org"/>
<meta property="og:site_name" content="Firo Website"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://firoyang.org/kernel/kernel/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2015-02-27"/>
<meta property="article:modified_time" content="2015-02-27"/>


<meta property="article:tag" content="kernel">





    <base href="http://firoyang.org/">
    <title> kernel</title>
    <link rel="canonical" href="http://firoyang.org/kernel/kernel/">
    

    <link href='http://fonts.useso.com/css?family=Fjalla+One|Open+Sans:300' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/static/css/style.css">

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
     
</head>


<body style="background-color:rgb(235,238,210);" lang="en" itemscope itemtype="http://schema.org/Article">
<header id="header">
	<link rel="stylesheet" href="static/css/font-awesome.min.css">
	<nav id="nav">
	<div id="title"><a href="/">Firo Notes</a></div>


	<div>
	
	</div>
	</nav>
	<nav id="nav">
    	        <ul id="mainnav">
            <li>
            <a href="/review/">
                <span class="icon"> <i aria-hidden="false" class="fa fa-thumbs-o-up"></i></span>
                <span> review</span>
            </a>
            </li>
	
            <li>
            <a href="/history/">
                <span class="icon"> <i aria-hidden="false" class="fa fa-institution"></i></span>
                <span> history </span>
            </a>
            </li>
            <li>
            <a href="/about">
                <span class="icon"> <i aria-hidden="true" class="fa fa-rocket"></i></span>
                <span> Firo </span>
            </a>
            </li>
            <li>
                <a href="/howto/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-gamepad"></i></span>
                <span> howto </span>
            </a>
            </li>
            <li>
            <a href="/kernel/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-linux"></i></span>
                <span> kernel </span>
            </a>
            </li>
            <li>
            <a href="/net/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-globe"></i></span>
                <span> net </span>
            </a>
            </li>
            <li>
            <a href="/philosophy/">
                <span class="icon"> <i aria-hidden="true" class="icon-leaf"></i></span>
                <span> philosophy </span>
            </a>
            </li>
            <li>
                <a href="/cs/">
                <span class="icon"> <i aria-hidden="true" class="fa fa-laptop"></i></span>
                <span> cs </span>
            </a>
            </li>
        </ul>

	</nav>
	<nav id="nav">
       
	</nav>
</header>



 <link rel="stylesheet" href="highlight.js/styles/monokai-sublime.css">
    <script src="highlight.js/highlight.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
	<section id="main">
	  <h1 itemprop="name" >kernel</h1>
	  

<aside id="meta">

    <div>
        <section id="datecount">
          <h4 id="date"> Fri Feb 27, 2015 </h4>
          
        </section>
        
        <ul id="tags">
          
            <li> <a href="http://firoyang.org//tags/kernel">kernel</a> </li>
          
        </ul>

    </div>


</aside>

<meta itemprop="wordCount" content="605">
<meta itemprop="datePublished" content="2015-02-27">
<meta itemprop="url" content="http://firoyang.org/kernel/kernel/">


	  <div>
		<article itemprop="articleBody" id="content">
		   

<h1 id="reference:58a3cfc985b676d6d801b8fd6c47f42a">Reference</h1>

<p><a href="https://en.wikipedia.org/wiki/Kernel_(operating_system">Kernel in Wikipedia</a><br />
* Book<br />
* Website<br />
<a href="http://lwn.net/">http://lwn.net/</a><br />
<a href="http://elinux.org/Kernel_Debugging_Tips">http://elinux.org/Kernel_Debugging_Tips</a><br />
<a href="https://www.kernel.org/doc/">https://www.kernel.org/doc/</a><br />
<a href="http://kernelnewbies.org/KernelJanitors/Todo">http://kernelnewbies.org/KernelJanitors/Todo</a><br />
<a href="http://eudyptula-challenge.org/">http://eudyptula-challenge.org/</a><br />
<a href="http://wangcong.org/2007/03/09/-e8-b5-b0-e8-bf-91linux-e5-86-85-e6-a0-b8/">走近Linux内核&ndash; 王聪</a></p>

<h1 id="cpu-freq:58a3cfc985b676d6d801b8fd6c47f42a">CPU freq</h1>

<ul>
<li>onset<br />
device_initcall: intel_pstate_init-&gt;cpufreq_register_driver<br /></li>

<li><p>nuclus<br />
** onset<br />
__cpufreq_add_dev -&gt; cpufreq init= intel_pstate_cpu_init-&gt;intel_pstate_init_cpu<br />
** coda<br />
_cpu_down-&gt;<br />
{<br />
cpu_notify_nofail(CPU_DEAD | mod, hcpu)-&gt;timer_cpu_notify<br />
cpu_notify_nofail(CPU_POST_DEAD | mod, hcpu)-&gt;cpufreq_cpu_callback-&gt;cpufreq exit = intel_pstate_cpu_exit,<br />
}</p></li>

<li><p>coda</p></li>
</ul>

<h1 id="kernel-panic-3-10-62:58a3cfc985b676d6d801b8fd6c47f42a">kernel panic 3.10.62</h1>

<p>general protection fault and page fault<br />
1498 errorentry general_protection do_general_protection<br />
1499 errorentry page_fault do_page_fault<br />
static const struct stacktrace_ops print_trace_ops = {<br />
        .stack                  = print_trace_stack,<br />
        .address                = print_trace_address,<br />
        .walk_stack             = print_context_stack,<br />
};<br />
no_context-&gt;<br />
{<br />
    show_fault_oops-&gt;<br />
    __die-&gt;<br />
    {<br />
        print_modules<br />
        show_regs<br />
        {<br />
            printk(KERN_DEFAULT &ldquo;Stack:\n&rdquo;);<br />
            show_stack_log_lvl-&gt;<br />
            {<br />
                show_trace_log_lvl-&gt;<br />
                {<br />
                    printk(&ldquo;%sCall Trace:\n&rdquo;, log_lvl);<br />
                    // arch/x86/kernel/dumpstack_64.c<br />
                    dump_trace-&gt;&amp;print_trace_ops<br />
                }<br />
            }<br />
            printk(KERN_DEFAULT &ldquo;Code: &ldquo;);<br />
        }<br />
    }<br />
}</p>

<h1 id="contents:58a3cfc985b676d6d801b8fd6c47f42a">Contents</h1>

<p>What&rsquo;s the difference between kernel and OS?<br />
cpu: syscall, process, ipc, smp<br />
memory:  mm<br />
io: buffer cache, fs, io subsys</p>

<h1 id="design-pattern:58a3cfc985b676d6d801b8fd6c47f42a">Design pattern</h1>

<p><a href="http://lwn.net/Articles/336224/">Linux kernel design patterns</a><br />
<a href="http://www.cs.fsu.edu/~baker/devices/notes/patterns.html#">Linux Kernel Programming Patterns</a></p>

<h1 id="interface:58a3cfc985b676d6d801b8fd6c47f42a">Interface</h1>

<p>Latin inter (prep., adv.) &ldquo;among, between, betwixt, in the midst of,&rdquo; from PIE *enter &ldquo;between, among&rdquo;<br />
<a href="http://www.webopedia.com/TERM/I/interface.html">Interface</a>:A boundary across which two independent systems meet and act on or communicate with each other.<br />
In computing, an <a href="https://en.wikipedia.org/wiki/Interface_(computing)">interface</a> is a shared boundary across which two separate components of a computer system exchange information.<br />
##API<br />
system call<br />
+ procfs are ultimately accessed via system calls<br />
##ABI<br />
elf, cpu specific</p>

<h3 id="x32-abi:58a3cfc985b676d6d801b8fd6c47f42a">x32 ABI</h3>

<p>ILP32<br />
LP64</p>

<h2 id="system-call:58a3cfc985b676d6d801b8fd6c47f42a">System call</h2>

<h1 id="find-bug:58a3cfc985b676d6d801b8fd6c47f42a">Find bug</h1>

<ul>
<li>Considered fault types<br />
Block “To avoid deadlock, do not call blocking functions with interrupts disabled or a spinlock held.”<br />
Null “Check potentially NULL pointers returned from routines”<br />
Var “Do not allocate large stack variables (&gt;1K) on the fixed-size kernel stack.”<br />
INull “Do not make inconsistent assumptions about whether a pointer is NULL.”<br />
Range “Always check bounds of array indices and loop bounds derived from user data.”<br />
Lock “Release acquired locks; do not double-acquire locks.”<br />
Intr “Restore disabled interrupts.”<br />
Free “Do not use freed memory.”<br />
Float “Do not use floating point in the kernel.”<br />
Size “Allocate enough memory to hold the type for which you are allocating.”<br /></li>
</ul>

<p>##KSM</p>

<p>#Signal<br />
* struct signal_sturct:<br />
The &ldquo;struct signal_struct&rdquo; is the random <em>leftovers</em> from all the other stuff.<br />
<a href="http://thread.gmane.org/gmane.linux.kernel/512831/focus=513990">http://thread.gmane.org/gmane.linux.kernel/512831/focus=513990</a><br />
* sigpending<br />
Store blocked signal info<br />
* Non-mask signal<br />
SIGKILL, SIGSTOP<br />
##Generate signal<br />
<strong>send_signal();<br />
##Process siganl<br />
* SIGKILL (may be some other)<br />
process in _send_signal()-&gt; complete_signal() tsk-&gt;state |= TASK_WAKEKILL<br />
<a href="http://lwn.net/Articles/288056/">http://lwn.net/Articles/288056/</a><br />
<a href="http://www.ibm.com/developerworks/library/l-task-killable/">http://www.ibm.com/developerworks/library/l-task-killable/</a><br />
* others<br />
each time a switch is made from kernel mode to user mode,<br />
arch-specific: entry.S -&gt; do_siganl()<br />
{<br />
    get_signal_deliver()<br />
    {<br />
        if fatal -&gt; do_greoup_exit()-&gt;&hellip;</strong>cleanup_sighand()<br />
    }</p>

<pre><code>handle_signal() -&gt; k-&gt;u(hanle)-sigreturn-&gt;k
</code></pre>

<p>}</p>

<p>#Netlink<br />
* Group<br />
enum rtnetlink_groups<br />
##What is netlink<br />
Networking related kernel configuration and monitoring interfaces.<br />
* IPC between kernel and user spacess process.<br />
ioctl<br />
* prarts<br />
    libnl<br />
    libnl-route<br />
    libnl-genl<br />
    libnl-nf</p>

<ul>
<li>How many parts does libnl-route has?<br />
Address,  links, neighboring, routing, TC<br /></li>
</ul>

<h2 id="need-patch:58a3cfc985b676d6d801b8fd6c47f42a">Need patch</h2>

<p>skbedit action<br />
cgroup classifier<br />
tun/tap dev<br />
gre tunnel dev<br />
tc classifier/action</p>

<p>#Namespace</p>

<p>#Module<br />
##pre-require<br />
modules.alias<br />
<a href="http://doc.opensuse.org/documentation/html/openSUSE_113/opensuse-reference/cha.udev.html">http://doc.opensuse.org/documentation/html/openSUSE_113/opensuse-reference/cha.udev.html</a></p>

<p><a href="http://blog.chinaunix.net/uid-22954220-id-4380202.html">http://blog.chinaunix.net/uid-22954220-id-4380202.html</a><br />
运行时, 插入u盘也是这样.</p>

<ol>
<li>内核自己加载比如缺少模块的时候 网络协议, fs<br />
<a href="https://unix.stackexchange.com/questions/90027/what-is-the-sequence-loading-linux-kernel-module-on-startup-how-priority-is-set/90037#90037">https://unix.stackexchange.com/questions/90027/what-is-the-sequence-loading-linux-kernel-module-on-startup-how-priority-is-set/90037#90037</a><br /></li>
</ol>

<p>3 rc 里面smartqos之类的.</p>

<p>##Load module into kernel<br />
vmlinux.lds.h linker scipts include helper macros.</p>

<p>#Data structures<br />
* u32 __u32<br />
__u32 is used for user-space. declare a variabe used by icotl. qosmark.<br />
u32 is used for kernel.<br />
deatils in ldd3e chapter 10</p>

<p>#Panic<br />
kernel/kernel/panic.c</p>

<p>#init<br />
##initcall</p>

<p>##disk<br />
subsys_initcall 4 genhd_device_init with base_probe{ request_module()}<br />
module_init 6 -&gt;init_sd-&gt;sync_schedule_domain(sd_probe_async</p>

<p>##cmdline<br />
root= name_to_dev_t, mount_root in prepare_namespace<br />
如果/init不能 sys_access, 则prepare_namespace,切换到真正的root=指定的设备上设备在sd_probe上初始化了.<br />
systemd负责挂在文件系统, 切换.</p>

<p>#src-tree<br />
include/linux: share with userspace<br />
include/net: kernel stuff</p>

<h1 id="assembly-in-kernel:58a3cfc985b676d6d801b8fd6c47f42a">Assembly in kernel</h1>

<p>为了简单! 内核修改特权寄存器和指令, 用汇编实现简单.<br />
尽可能加速. c到汇编, 编译器相对保守,</p>

<h1 id="the-principle-of-kernel-driver-backport:58a3cfc985b676d6d801b8fd6c47f42a">The principle of kernel &amp; driver backport</h1>

<p>将高本版kernel的feature移植到低版本的kernel的过程就是backport.<br />
1. 尽量保持与mainline的代码一致<br />
2. 做好取舍不要引入太多patch.</p>

<h2 id="开发流程:58a3cfc985b676d6d801b8fd6c47f42a">开发流程</h2>

<p>理清所引入feature的代码. 主要数据结构以及功能流程.</p>

<h1 id="arm:58a3cfc985b676d6d801b8fd6c47f42a">ARM</h1>

<h2 id="smp-ops:58a3cfc985b676d6d801b8fd6c47f42a">smp_ops</h2>

<p>Machine: Marvell Armada XP Development Board<br />
MACHINE_START(_type,_name)<br />
<strong>section</strong>(&ldquo;.arch.info.init&rdquo;)<br />
arch/arm/tools/mach-types<br />
armada_xp_db            MACH_ARMADA_XP_DB       ARMADA_XP_DB            3036</p>

<h2 id="smp:58a3cfc985b676d6d801b8fd6c47f42a">smp</h2>

<p>An Implementation Of Multiprocessor Linux Alan Cox</p>

<h3 id="cpumask:58a3cfc985b676d6d801b8fd6c47f42a">cpumask</h3>

<h2 id="interrupt:58a3cfc985b676d6d801b8fd6c47f42a">Interrupt</h2>

<p>SPI and PPI or IPI, difference?</p>

<h1 id="faq:58a3cfc985b676d6d801b8fd6c47f42a">Faq</h1>

<p>MACHINE_START</p>

<h2 id="kernel-system-boot-hang-freeze:58a3cfc985b676d6d801b8fd6c47f42a">Kernel/system boot hang/freeze</h2>

<h3 id="sysrq:58a3cfc985b676d6d801b8fd6c47f42a">Sysrq</h3>

<p>Whe sysrq work?</p>

<h3 id="bootargs:58a3cfc985b676d6d801b8fd6c47f42a">bootargs</h3>

<p>debug initcall_debug</p>

<h3 id="printk:58a3cfc985b676d6d801b8fd6c47f42a">printk</h3>

		</article>
	  </div>
	</section>

<aside id=comments>
    <div><h2> Comments </h2></div>
    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'firoyang';
    var disqus_identifier = 'http:\/\/firoyang.org\/kernel\/kernel\/';
    var disqus_title = 'kernel';
    var disqus_url = 'http:\/\/firoyang.org\/kernel\/kernel\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</aside>

<footer>
  <div>
    <p>
    &copy; 2014 ~ 2016 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Firo Yang </span></span><a href="http://creativecommons.org/licenses/by/4.0/">Some rights reserved</a>. 
	Powered by <a href="http://gohugo.io">Hugo</a>.
        Theme by <a href="http://spf13.com">Steve Francia <a href="http://firoyang.org">Firo Yang</a>.
    </p>
  </div>
</footer>
<script type="text/javascript">
(function(){var j=function(a,b){return window.getComputedStyle?getComputedStyle(a).getPropertyValue(b):a.currentStyle[b]};var k=function(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else a.attachEvent('on'+b,c)};var l=function(a,b){for(key in b)if(b.hasOwnProperty(key))a[key]=b[key];return a};window.fitText=function(d,e,f){var g=l({'minFontSize':-1/0,'maxFontSize':1/0},f);var h=function(a){var b=e||1;var c=function(){a.style.fontSize=Math.max(Math.min(a.clientWidth/(b*10),parseFloat(g.maxFontSize)),parseFloat(g.minFontSize))+'px'};c();k(window,'resize',c)};if(d.length)for(var i=0;i<d.length;i++)h(d[i]);else h(d);return d}})();
fitText(document.getElementById('title'), 1)
</script>




</body>
</html>


<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>

</body>
